import{r as kt,a as Pt}from"./vendor-xterm-DgJRGhIz.js";import{c as Mt}from"./vendor-cytoscape-BQaXIfA_.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();var Et=kt(),Lt=Pt();const b={TURTLESIM_UPDATE:"turtlesim-update",LIDAR_UPDATE:"lidar-update",MAP_UPDATE:"map-update",ROBOT_POSE_UPDATE:"robot-pose-update",SHOW_MAP:"show-map",TOGGLE_MAP_OVERLAY:"toggle-map-overlay",PATH_PLANNED:"path-planned",PATH_CLEARED:"path-cleared",WAYPOINTS_UPDATE:"waypoints-update",WAYPOINTS_CLEARED:"waypoints-cleared",LOOP_CLOSURE_DETECTED:"loop-closure-detected",PROCESS_STARTED:"process-started",PROCESS_STOPPED:"process-stopped",WORLD_STATE_CHANGED:"world-state-changed",LAYOUT_RESIZE:"layout-resize",TELEOP_ACTIVE:"teleop-active",TELEOP_INACTIVE:"teleop-inactive",TOGGLE_GRAPH:"toggle-graph",TOGGLE_CONSOLE:"toggle-console",CANVAS_EDIT_MODE_CHANGED:"canvas-edit-mode-changed",OPEN_RQT_MODAL:"open-rqt-modal"};class At{constructor(t,e={}){this.container=t,this.id=e.id||`term_${Date.now()}`,this.onCommand=e.onCommand||(()=>{}),this.onInterrupt=e.onInterrupt||(()=>{}),this.history=[],this.historyIndex=-1,this.maxHistory=100,this.currentLine="",this.cursorPosition=0,this.prompt="ros2@sim:~$ ",this.isProcessing=!1,this.waitingForInput=!1,this.focused=!1,this.teleopActive=!1,this.teleopType=null,this.activeSubscriptions=[],this.activeBagRecorders=[],this._initTerminal()}_initTerminal(){this.xterm=new Et.Terminal({theme:{background:"#1e1e1e",foreground:"#d4d4d4",cursor:"#ffffff",cursorAccent:"#1e1e1e",selection:"rgba(255, 255, 255, 0.3)",black:"#000000",red:"#cd3131",green:"#0dbc79",yellow:"#e5e510",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5",brightBlack:"#666666",brightRed:"#f14c4c",brightGreen:"#23d18b",brightYellow:"#f5f543",brightBlue:"#3b8eea",brightMagenta:"#d670d6",brightCyan:"#29b8db",brightWhite:"#ffffff"},fontFamily:'Menlo, Monaco, "Courier New", monospace',fontSize:14,lineHeight:1.2,cursorBlink:!0,cursorStyle:"block",scrollback:1e3,allowTransparency:!0}),this.fitAddon=new Lt.FitAddon,this.xterm.loadAddon(this.fitAddon),this.xterm.open(this.container),this.fit(),this.xterm.onData(this._handleInput.bind(this)),this.container.addEventListener("focus",()=>{this.focused=!0},!0),this.container.addEventListener("blur",()=>{this.focused=!1},!0),this.container.addEventListener("mousedown",()=>{this.xterm.focus()}),this._setupContextMenu(),this.writePrompt(),this._setupTeleopListeners()}_setupTeleopListeners(){window.addEventListener(b.TELEOP_ACTIVE,t=>{var e;this.teleopActive=!0,this.teleopType=((e=t.detail)==null?void 0:e.type)||"wasd-keys"}),window.addEventListener(b.TELEOP_INACTIVE,()=>{this.teleopActive=!1,this.teleopType=null})}_setupContextMenu(){this.contextMenu=document.createElement("div"),this.contextMenu.className="terminal-context-menu",this.contextMenu.innerHTML=`
      <button class="context-menu-item" data-action="copy">Copy</button>
      <button class="context-menu-item" data-action="paste">Paste</button>
      <button class="context-menu-item" data-action="clear">Clear</button>
    `,this.contextMenu.style.display="none",document.body.appendChild(this.contextMenu),this.container.addEventListener("contextmenu",t=>{t.preventDefault(),this._showContextMenu(t.clientX,t.clientY)}),this.contextMenu.addEventListener("click",async t=>{const e=t.target.dataset.action;if(e)switch(this._hideContextMenu(),e){case"copy":await this._handleCopy();break;case"paste":await this._handlePaste();break;case"clear":this.clear(),this.writePrompt(),this._refreshLine();break}}),document.addEventListener("click",t=>{this.contextMenu.contains(t.target)||this._hideContextMenu()}),document.addEventListener("scroll",()=>{this._hideContextMenu()},!0)}_showContextMenu(t,e){this.contextMenu.style.display="block",this.contextMenu.style.left=`${t}px`,this.contextMenu.style.top=`${e}px`;const s=this.contextMenu.getBoundingClientRect();s.right>window.innerWidth&&(this.contextMenu.style.left=`${window.innerWidth-s.width-5}px`),s.bottom>window.innerHeight&&(this.contextMenu.style.top=`${window.innerHeight-s.height-5}px`)}_hideContextMenu(){this.contextMenu.style.display="none"}async _handleCopy(){const t=this.xterm.getSelection();if(t)try{await navigator.clipboard.writeText(t)}catch(e){console.error("Failed to copy:",e)}}async _handlePaste(){try{const t=await navigator.clipboard.readText();if(t)for(const e of t)e===`
`||e==="\r"||this._insertChar(e)}catch(t){console.error("Failed to paste:",t)}}_forwardKeyToWindow(t,e){const s=new KeyboardEvent("keydown",{key:t,code:e,bubbles:!0,cancelable:!0});window.dispatchEvent(s),setTimeout(()=>{const i=new KeyboardEvent("keyup",{key:t,code:e,bubbles:!0,cancelable:!0});window.dispatchEvent(i)},50)}_handleInput(t){for(let e=0;e<t.length;e++){const s=t.charCodeAt(e);if(s===3){this._handleInterrupt();continue}if(s!==4){if(s===12){this.clear(),this.writePrompt(),this._refreshLine();continue}if(s===13){this._handleEnter();continue}if(s===127||s===8){this._handleBackspace();continue}if(s===9){this._handleTab();continue}if(s===27){if(e+2<t.length&&t.charCodeAt(e+1)===91){const i=t.charCodeAt(e+2);if(i===65){if(this.teleopActive&&this.teleopType==="arrow-keys"){this._forwardKeyToWindow("ArrowUp","ArrowUp"),e+=2;continue}this._historyUp(),e+=2;continue}if(i===66){if(this.teleopActive&&this.teleopType==="arrow-keys"){this._forwardKeyToWindow("ArrowDown","ArrowDown"),e+=2;continue}this._historyDown(),e+=2;continue}if(i===67){if(this.teleopActive&&this.teleopType==="arrow-keys"){this._forwardKeyToWindow("ArrowRight","ArrowRight"),e+=2;continue}this._cursorRight(),e+=2;continue}if(i===68){if(this.teleopActive&&this.teleopType==="arrow-keys"){this._forwardKeyToWindow("ArrowLeft","ArrowLeft"),e+=2;continue}this._cursorLeft(),e+=2;continue}if(i===72){this._cursorHome(),e+=2;continue}if(i===70){this._cursorEnd(),e+=2;continue}if(i===51&&e+3<t.length&&t.charCodeAt(e+3)===126){this._handleDelete(),e+=3;continue}}continue}if(s>=32&&s<127){if(this.teleopActive&&this.teleopType==="wasd-keys"){const i=t[e].toUpperCase();if("WASDQE".includes(i)){this._forwardKeyToWindow(i,`Key${i}`);continue}}this._insertChar(t[e])}}}}_insertChar(t){this.isProcessing||(this.currentLine=this.currentLine.slice(0,this.cursorPosition)+t+this.currentLine.slice(this.cursorPosition),this.cursorPosition++,this._refreshLine())}_handleBackspace(){this.isProcessing||this.cursorPosition!==0&&(this.currentLine=this.currentLine.slice(0,this.cursorPosition-1)+this.currentLine.slice(this.cursorPosition),this.cursorPosition--,this._refreshLine())}_handleDelete(){this.isProcessing||this.cursorPosition>=this.currentLine.length||(this.currentLine=this.currentLine.slice(0,this.cursorPosition)+this.currentLine.slice(this.cursorPosition+1),this._refreshLine())}_handleEnter(){if(this.isProcessing)return;this.xterm.write(`\r
`);const t=this.currentLine.trim();this.currentLine="",this.cursorPosition=0,t?(this.history[this.history.length-1]!==t&&(this.history.push(t),this.history.length>this.maxHistory&&this.history.shift()),this.historyIndex=this.history.length,this.isProcessing=!0,this.onCommand(t,this)):this.writePrompt()}_handleInterrupt(){for(const t of this.activeSubscriptions)t.destroy&&t.destroy();this.activeSubscriptions=[];for(const t of this.activeBagRecorders)t.stop&&t.stop();this.activeBagRecorders=[],this.onInterrupt(this),this.xterm.write(`^C\r
`),this.currentLine="",this.cursorPosition=0,this.isProcessing=!1,this.writePrompt()}_handleTab(){this._insertChar(" "),this._insertChar(" ")}_historyUp(){this.isProcessing||this.historyIndex<=0||(this.historyIndex--,this.currentLine=this.history[this.historyIndex],this.cursorPosition=this.currentLine.length,this._refreshLine())}_historyDown(){if(!this.isProcessing){if(this.historyIndex>=this.history.length-1){this.historyIndex=this.history.length,this.currentLine="",this.cursorPosition=0,this._refreshLine();return}this.historyIndex++,this.currentLine=this.history[this.historyIndex],this.cursorPosition=this.currentLine.length,this._refreshLine()}}_cursorLeft(){this.cursorPosition>0&&(this.cursorPosition--,this.xterm.write("\x1B[D"))}_cursorRight(){this.cursorPosition<this.currentLine.length&&(this.cursorPosition++,this.xterm.write("\x1B[C"))}_cursorHome(){for(;this.cursorPosition>0;)this.cursorPosition--,this.xterm.write("\x1B[D")}_cursorEnd(){for(;this.cursorPosition<this.currentLine.length;)this.cursorPosition++,this.xterm.write("\x1B[C")}_refreshLine(){this.prompt.length,this.xterm.write("\r"),this.xterm.write("\x1B[K"),this.xterm.write(this.prompt+this.currentLine);const t=this.currentLine.length-this.cursorPosition;t>0&&this.xterm.write(`\x1B[${t}D`)}write(t){this.xterm.write(t.replace(/\r?\n/g,`\r
`))}writeln(t){this.xterm.write(t.replace(/\r?\n/g,`\r
`)+`\r
`)}writePrompt(){this.xterm.write(this.prompt)}setPrompt(t){this.prompt=t}finishCommand(){this.isProcessing=!1,this.writePrompt()}clear(){this.xterm.clear()}fit(){try{this.fitAddon.fit()}catch{}}focus(){this.xterm.focus()}addSubscription(t){this.activeSubscriptions.push(t)}removeSubscription(t){const e=this.activeSubscriptions.indexOf(t);e>=0&&this.activeSubscriptions.splice(e,1)}addBagRecorder(t){this.activeBagRecorders.push(t)}removeBagRecorder(t){const e=this.activeBagRecorders.indexOf(t);e>=0&&this.activeBagRecorders.splice(e,1)}destroy(){for(const t of this.activeSubscriptions)t.destroy&&t.destroy();this.activeSubscriptions=[];for(const t of this.activeBagRecorders)t.stop&&t.stop();this.activeBagRecorders=[],this.contextMenu&&this.contextMenu.parentNode&&this.contextMenu.parentNode.removeChild(this.contextMenu),this.xterm.dispose()}}class $t{constructor(){this._services=new Map}register(t,e){this._services.set(t,e)}get(t){return this._services.get(t)}has(t){return this._services.has(t)}reset(){this._services.clear()}getServiceNames(){return Array.from(this._services.keys())}}const z=new $t,D={DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4};class Rt{constructor(){this.logs=[],this.maxLogs=1e3,this.listeners=[],this.defaultLevel=D.INFO,this.nodeLevels=new Map,this.paused=!1}getLogger(t){return{debug:e=>this._log(t,"DEBUG",e),info:e=>this._log(t,"INFO",e),warn:e=>this._log(t,"WARN",e),error:e=>this._log(t,"ERROR",e),fatal:e=>this._log(t,"FATAL",e)}}_log(t,e,s){const i=D[e],n=this.nodeLevels.get(t)??this.defaultLevel;if(i<n)return;const r={timestamp:Date.now(),node:t,level:e,levelValue:i,message:s};this.logs.push(r),this.logs.length>this.maxLogs&&this.logs.shift();const a=`[${t}] [${e}]: ${s}`;switch(e){case"DEBUG":console.debug(a);break;case"INFO":console.info(a);break;case"WARN":console.warn(a);break;case"ERROR":case"FATAL":console.error(a);break}if(!this.paused)for(const l of this.listeners)try{l(r)}catch(c){console.error("Error in log listener:",c)}}setNodeLevel(t,e){const s=D[e.toUpperCase()];s!==void 0&&this.nodeLevels.set(t,s)}setDefaultLevel(t){const e=D[t.toUpperCase()];e!==void 0&&(this.defaultLevel=e)}addListener(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>=0&&this.listeners.splice(e,1)}}getLogs(t={}){let e=[...this.logs];if(t.level){const s=D[t.level.toUpperCase()]??0;e=e.filter(i=>i.levelValue>=s)}return t.node&&(e=e.filter(s=>s.node.includes(t.node))),t.since&&(e=e.filter(s=>s.timestamp>=t.since)),e}clear(){this.logs=[]}pause(){this.paused=!0}resume(){this.paused=!1}formatEntry(t){const s=new Date(t.timestamp).toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),i=String(t.timestamp%1e3).padStart(3,"0");return`[${s}.${i}] [${t.node}] [${t.level}]: ${t.message}`}getLevels(){return Object.keys(D)}parseLevel(t){return D[t.toUpperCase()]}}const E=new Rt;z.register("logManager",E);class Dt{constructor(){this.processes=new Map,this.nextProcessId=1,this.logger=E.getLogger("/process_manager")}spawn(t,e,s,i){const n=`proc_${this.nextProcessId++}`;return this.processes.set(n,{node:t,terminalId:e,package:s,executable:i,startTime:Date.now()}),t.start(),this.logger.info(`Spawned ${s}/${i} as ${t.fullName} (pid: ${n})`),window.dispatchEvent(new CustomEvent(b.PROCESS_STARTED,{detail:{processId:n,terminalId:e,nodeName:t.fullName}})),n}kill(t){const e=this.processes.get(t);if(!e)return!1;const s=e.terminalId,i=e.node.fullName;return e.node.destroy(),this.processes.delete(t),this.logger.info(`Killed process ${t}`),window.dispatchEvent(new CustomEvent(b.PROCESS_STOPPED,{detail:{processId:t,terminalId:s,nodeName:i}})),!0}killByNodeName(t){for(const[e,s]of this.processes)if(s.node.fullName===t)return this.kill(e);return!1}killByTerminal(t){let e=0;const s=[];for(const[i,n]of this.processes)n.terminalId===t&&s.push(i);for(const i of s)this.kill(i)&&e++;return e}getProcess(t){return this.processes.get(t)||null}getProcessByNodeName(t){for(const[e,s]of this.processes)if(s.node.fullName===t)return{processId:e,...s};return null}getProcessesByTerminal(t){const e=[];for(const[s,i]of this.processes)i.terminalId===t&&e.push({processId:s,...i});return e}getAllProcesses(){const t=[];for(const[e,s]of this.processes)t.push({processId:e,...s});return t}isNodeRunning(t){for(const[,e]of this.processes)if(e.node.fullName===t)return!0;return!1}getProcessCount(){return this.processes.size}killAll(){const t=Array.from(this.processes.keys());for(const e of t)this.kill(e)}}const k=new Dt;z.register("processManager",k);class Ot{constructor(t={}){this.containerId=t.containerId||"terminals-container",this.tabListId=t.tabListId||"terminal-tabs",this.addButtonId=t.addButtonId||"add-terminal",this.maxTerminals=t.maxTerminals||6,this.onCommand=t.onCommand||(()=>{}),this.terminals=new Map,this.activeTerminalId=null,this.nextTerminalNum=1,this.container=document.getElementById(this.containerId),this.tabList=document.querySelector(`#${this.tabListId} .tab-list`),this.addButton=document.getElementById(this.addButtonId),this._setupEventListeners(),this._addTerminal()}_setupEventListeners(){var t;(t=this.addButton)==null||t.addEventListener("click",()=>{this._addTerminal()}),window.addEventListener("resize",()=>{this._resizeAll()}),window.addEventListener(b.LAYOUT_RESIZE,()=>{setTimeout(()=>this._resizeAll(),100)}),window.addEventListener(b.PROCESS_STARTED,e=>{const{terminalId:s}=e.detail||{};s&&this._updateTabIndicator(s,!0)}),window.addEventListener(b.PROCESS_STOPPED,e=>{const{terminalId:s}=e.detail||{};s&&this._updateTabIndicator(s,!1)})}_updateTabIndicator(t,e){const s=this.terminals.get(t);if(!s)return;const i=s.tab.querySelector(".tab-status");i&&i.classList.toggle("running",e)}_addTerminal(){if(this.terminals.size>=this.maxTerminals)return null;const t=`terminal_${this.nextTerminalNum++}`,e=this.terminals.size+1,s=document.createElement("div");s.id=t,s.className="terminal-pane",this.container.appendChild(s);const i=document.createElement("div");i.className="terminal-tab",i.dataset.termId=t,i.setAttribute("role","tab"),i.setAttribute("aria-selected","false"),i.innerHTML=`
      <span class="tab-status" aria-hidden="true"></span>
      <span class="tab-title">Terminal ${e}</span>
      <button class="tab-close" aria-label="Close terminal ${e}">&times;</button>
    `,this.tabList.appendChild(i),i.addEventListener("click",r=>{r.target.classList.contains("tab-close")||this._activateTerminal(t)}),i.querySelector(".tab-close").addEventListener("click",r=>{r.stopPropagation(),this._removeTerminal(t)});const n=new At(s,{id:t,onCommand:(r,a)=>this.onCommand(r,a),onInterrupt:r=>this._handleInterrupt(r)});return this.terminals.set(t,{terminal:n,tab:i,container:s}),this._activateTerminal(t),this._updateAddButton(),n}_removeTerminal(t){const e=this.terminals.get(t);if(e&&!(this.terminals.size<=1)){if(k.killByTerminal(t),e.terminal.destroy(),e.container.remove(),e.tab.remove(),this.terminals.delete(t),this.activeTerminalId===t){const s=this.terminals.keys().next().value;s&&this._activateTerminal(s)}this._renumberTabs(),this._updateAddButton()}}_activateTerminal(t){const e=this.terminals.get(t);if(e){if(this.activeTerminalId&&this.activeTerminalId!==t){const s=this.terminals.get(this.activeTerminalId);s&&(s.tab.classList.remove("active"),s.tab.setAttribute("aria-selected","false"),s.container.classList.remove("active"))}e.tab.classList.add("active"),e.tab.setAttribute("aria-selected","true"),e.container.classList.add("active"),this.activeTerminalId=t,setTimeout(()=>{e.terminal.focus(),e.terminal.fit()},0)}}_handleInterrupt(t){k.killByTerminal(t.id)}_renumberTabs(){let t=1;for(const[,e]of this.terminals){const s=e.tab.querySelector(".tab-title");s&&(s.textContent=`Terminal ${t}`),t++}}_updateAddButton(){this.addButton&&(this.addButton.style.display=this.terminals.size>=this.maxTerminals?"none":"block")}_resizeAll(){for(const[,t]of this.terminals)t.terminal.fit()}getActiveTerminal(){if(!this.activeTerminalId)return null;const t=this.terminals.get(this.activeTerminalId);return(t==null?void 0:t.terminal)||null}getTerminal(t){var e;return((e=this.terminals.get(t))==null?void 0:e.terminal)||null}getAllTerminals(){return Array.from(this.terminals.values()).map(t=>t.terminal)}getTerminalCount(){return this.terminals.size}clearAll(){for(const[,t]of this.terminals)t.terminal.clear(),t.terminal.writePrompt()}focus(){const t=this.getActiveTerminal();t&&t.focus()}destroy(){for(const[t]of this.terminals){const e=this.terminals.get(t);e&&(k.killByTerminal(t),e.terminal.destroy())}this.terminals.clear(),this.container.innerHTML="",this.tabList.innerHTML=""}}class Nt{constructor(){this.width=11,this.height=11,this.obstacles=[],this.turtles=new Map,this.onChangeCallback=null,this._initDefaultObstacles()}setOnChangeCallback(t){this.onChangeCallback=t}_initDefaultObstacles(){this.obstacles=[{type:"wall",x:0,y:0,width:11,height:.1},{type:"wall",x:0,y:10.9,width:11,height:.1},{type:"wall",x:0,y:0,width:.1,height:11},{type:"wall",x:10.9,y:0,width:.1,height:11},{type:"box",x:3,y:3,width:1.5,height:1.5},{type:"box",x:7,y:2,width:1,height:2},{type:"box",x:2,y:7,width:2,height:1},{type:"box",x:6,y:6,width:1.5,height:1.5},{type:"box",x:8,y:8,width:1,height:1}]}addObstacle(t){this.obstacles.push(t)}removeObstacle(t){t>=0&&t<this.obstacles.length&&this.obstacles.splice(t,1)}clearObstacles(){this.obstacles=[]}resetObstacles(){this._initDefaultObstacles(),this._notifyChange()}randomizeObstacles(t=5,e={}){const{minSize:s=.5,maxSize:i=2,keepWalls:n=!0,margin:r=1.5}=e;n?this.obstacles=this.obstacles.filter(a=>a.type==="wall"):this.obstacles=[];for(let a=0;a<t;a++){const l=s+Math.random()*(i-s),c=s+Math.random()*(i-s);let h,d,u=0;const p=50;do h=.5+Math.random()*(this.width-l-1),d=.5+Math.random()*(this.height-c-1),u++;while(u<p&&(this._obstacleOverlaps(h,d,l,c)||this._tooCloseToCenter(h,d,l,c,r)));u<p&&this.obstacles.push({type:"box",x:h,y:d,width:l,height:c})}this._notifyChange()}_obstacleOverlaps(t,e,s,i,n=.3){for(const r of this.obstacles){if(r.type==="wall")continue;const a=t<r.x+r.width+n&&t+s+n>r.x,l=e<r.y+r.height+n&&e+i+n>r.y;if(a&&l)return!0}return!1}_tooCloseToCenter(t,e,s,i,n){const r=this.width/2,a=this.height/2,l=Math.max(t,Math.min(r,t+s)),c=Math.max(e,Math.min(a,e+i)),h=r-l,d=a-c;return Math.sqrt(h*h+d*d)<n}findObstacleAt(t,e){for(let s=this.obstacles.length-1;s>=0;s--){const i=this.obstacles[s];if(i.type!=="wall"&&t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height)return s}return-1}addObstacleAt(t,e,s=1,i=1){const n={type:"box",x:t-s/2,y:e-i/2,width:s,height:i};return n.x=Math.max(.2,Math.min(this.width-s-.2,n.x)),n.y=Math.max(.2,Math.min(this.height-i-.2,n.y)),this.obstacles.push(n),this._notifyChange(),this.obstacles.length-1}removeObstacleAt(t,e){const s=this.findObstacleAt(t,e);return s>=0?(this.obstacles.splice(s,1),this._notifyChange(),!0):!1}clearNonWallObstacles(){this.obstacles=this.obstacles.filter(t=>t.type==="wall"),this._notifyChange()}_notifyChange(){this.onChangeCallback?this.onChangeCallback():window.dispatchEvent(new CustomEvent(b.WORLD_STATE_CHANGED))}getObstacleCount(){return this.obstacles.filter(t=>t.type!=="wall").length}registerTurtle(t,e,s,i){this.turtles.set(t,{x:e,y:s,theta:i})}updateTurtle(t,e,s,i){this.turtles.has(t)&&this.turtles.set(t,{x:e,y:s,theta:i})}removeTurtle(t){this.turtles.delete(t)}getTurtle(t){return this.turtles.get(t)}checkCollision(t,e,s=.2){if(t-s<0||t+s>this.width||e-s<0||e+s>this.height)return!0;for(const i of this.obstacles)if(this._circleRectCollision(t,e,s,i.x,i.y,i.width,i.height))return!0;return!1}_circleRectCollision(t,e,s,i,n,r,a){const l=Math.max(i,Math.min(t,i+r)),c=Math.max(n,Math.min(e,n+a)),h=t-l,d=e-c;return h*h+d*d<s*s}raycast(t,e,s,i=10){const n=Math.cos(s),r=Math.sin(s);let a=null,l=i;for(const h of this.obstacles){const d=this._rayRectIntersection(t,e,n,r,h.x,h.y,h.width,h.height);d&&d.distance<l&&(l=d.distance,a=d)}const c=[this._rayLineIntersection(t,e,n,r,0,0,this.width,0),this._rayLineIntersection(t,e,n,r,0,this.height,this.width,this.height),this._rayLineIntersection(t,e,n,r,0,0,0,this.height),this._rayLineIntersection(t,e,n,r,this.width,0,this.width,this.height)];for(const h of c)h&&h.distance>0&&h.distance<l&&(l=h.distance,a=h);return a?{hit:!0,distance:l,point:a.point}:{hit:!1,distance:i,point:{x:t+n*i,y:e+r*i}}}_rayRectIntersection(t,e,s,i,n,r,a,l){const c=[{x1:n,y1:r,x2:n+a,y2:r},{x1:n,y1:r+l,x2:n+a,y2:r+l},{x1:n,y1:r,x2:n,y2:r+l},{x1:n+a,y1:r,x2:n+a,y2:r+l}];let h=null,d=1/0;for(const u of c){const p=this._rayLineIntersection(t,e,s,i,u.x1,u.y1,u.x2,u.y2);p&&p.distance>.001&&p.distance<d&&(d=p.distance,h=p)}return h}_rayLineIntersection(t,e,s,i,n,r,a,l){const c=a-n,h=l-r,d=s*h-i*c;if(Math.abs(d)<1e-4)return null;const u=((n-t)*h-(r-e)*c)/d,p=((n-t)*i-(r-e)*s)/d;return u>0&&p>=0&&p<=1?{distance:u,point:{x:t+s*u,y:e+i*u}}:null}lidarScan(t,e,s,i={}){const{angleMin:n=-Math.PI,angleMax:r=Math.PI,angleIncrement:a=Math.PI/180,rangeMin:l=.1,rangeMax:c=10,numRays:h=360}=i,d=[],u=[],p=(r-n)/h;for(let g=0;g<h;g++){const m=s+n+g*p,f=this.raycast(t,e,m,c);f.hit&&f.distance>=l?(d.push(f.distance),u.push(1)):(f.distance<l,d.push(1/0),u.push(0))}return{angle_min:n,angle_max:r,angle_increment:p,time_increment:0,scan_time:.1,range_min:l,range_max:c,ranges:d,intensities:u}}getObstacles(){return this.obstacles}}const I=new Nt;z.register("worldState",I);class zt{constructor(t="turtle-canvas"){typeof t=="string"?this.canvas=document.getElementById(t):this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.worldWidth=11,this.worldHeight=11,this.turtleImage=new Image,this.turtleImageLoaded=!1,this._loadTurtleImage(),this.showObstacles=!0,this.showLidar=!1,this.showTF=!1,this.showMap=!1,this.mapOpacity=.5,this.mapData=null,this.mapInfo=null,this.mapCanvas=null,this.showCostmap=!1,this.costmapCanvas=null,this.costmapRobotRadius=.6,this.showMapQuality=!1,this.mapQualityCanvas=null,this.mapQualityScore=null,this.waypoints=[],this._resizeScheduled=!1,this.editMode="none",this.newObstacleSize=1,this.turtles=[],this.trails=[],this.background={r:69,g:86,b:255},this.lidarData=null,this.hasTurtlesim=!1,this._setupEventListeners(),this._setupClickHandlers(),this._render()}_loadTurtleImage(){const t=`
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
        <!-- Shell -->
        <ellipse cx="24" cy="24" rx="16" ry="14" fill="#228B22" stroke="#006400" stroke-width="2"/>
        <!-- Shell pattern -->
        <path d="M24 10 L24 38" stroke="#006400" stroke-width="1"/>
        <path d="M12 24 L36 24" stroke="#006400" stroke-width="1"/>
        <path d="M16 14 L32 34" stroke="#006400" stroke-width="1"/>
        <path d="M32 14 L16 34" stroke="#006400" stroke-width="1"/>
        <!-- Head -->
        <circle cx="40" cy="24" r="6" fill="#90EE90" stroke="#228B22" stroke-width="1.5"/>
        <!-- Eyes -->
        <circle cx="42" cy="22" r="1.5" fill="#000"/>
        <circle cx="42" cy="26" r="1.5" fill="#000"/>
        <!-- Legs -->
        <ellipse cx="14" cy="12" rx="5" ry="4" fill="#90EE90" stroke="#228B22" stroke-width="1"/>
        <ellipse cx="14" cy="36" rx="5" ry="4" fill="#90EE90" stroke="#228B22" stroke-width="1"/>
        <ellipse cx="30" cy="12" rx="5" ry="4" fill="#90EE90" stroke="#228B22" stroke-width="1"/>
        <ellipse cx="30" cy="36" rx="5" ry="4" fill="#90EE90" stroke="#228B22" stroke-width="1"/>
        <!-- Tail -->
        <path d="M6 24 Q2 24 4 22" stroke="#90EE90" stroke-width="3" fill="none"/>
      </svg>
    `,e=new Blob([t],{type:"image/svg+xml"}),s=URL.createObjectURL(e);this.turtleImage.onload=()=>{this.turtleImageLoaded=!0,URL.revokeObjectURL(s),this._render()},this.turtleImage.src=s}_setupEventListeners(){window.addEventListener(b.TURTLESIM_UPDATE,t=>{const{turtles:e,trails:s,background:i}=t.detail;this.turtles=e,this.trails=s,this.background=i,this.hasTurtlesim=e&&e.length>0,this._render()}),window.addEventListener(b.LIDAR_UPDATE,t=>{this.lidarData=t.detail,this.showLidar&&this._render()}),window.addEventListener(b.MAP_UPDATE,t=>{const{map:e,info:s}=t.detail;this.mapData=e,this.mapInfo=s,this._updateMapCanvas(),this.showCostmap&&this._updateCostmapCanvas(),this.showMapQuality&&this._updateMapQualityCanvas(),(this.showMap||this.showCostmap||this.showMapQuality)&&this._render()}),window.addEventListener("resize",()=>this._handleResize()),window.addEventListener(b.LAYOUT_RESIZE,()=>this._handleResize()),window.addEventListener(b.WORLD_STATE_CHANGED,()=>this._render()),window.addEventListener(b.WAYPOINTS_UPDATE,t=>{this.waypoints=t.detail.waypoints||[],this._render()}),window.addEventListener(b.WAYPOINTS_CLEARED,()=>{this.waypoints=[],this._render()}),this._handleResize()}_setupClickHandlers(){this.canvas.addEventListener("click",t=>{if(this.editMode==="none")return;const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,n=this._canvasToWorld(s,i);this.editMode==="add"?I.addObstacleAt(n.x,n.y,this.newObstacleSize,this.newObstacleSize):this.editMode==="delete"&&I.removeObstacleAt(n.x,n.y)}),this.canvas.addEventListener("mousemove",t=>{if(this.editMode==="none")this.canvas.style.cursor="default";else if(this.editMode==="add")this.canvas.style.cursor="crosshair";else if(this.editMode==="delete"){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,n=this._canvasToWorld(s,i),r=I.findObstacleAt(n.x,n.y);this.canvas.style.cursor=r>=0?"pointer":"not-allowed"}})}_canvasToWorld(t,e){const s=this.worldWidth/this.canvas.width,i=this.worldHeight/this.canvas.height;return{x:t*s,y:(this.canvas.height-e)*i}}_handleResize(){this._resizeScheduled||(this._resizeScheduled=!0,requestAnimationFrame(()=>{this._resizeScheduled=!1;const t=this.canvas.parentElement;if(!t)return;const e=t.getBoundingClientRect();if(e.width===0||e.height===0)return;const s=Math.min(e.width,e.height,500);this.canvas.width=s,this.canvas.height=s,this._render()}))}_worldToCanvas(t,e){const s=this.canvas.width/this.worldWidth,i=this.canvas.height/this.worldHeight;return{x:t*s,y:this.canvas.height-e*i}}_worldToCanvasScale(t){return t/this.worldWidth*this.canvas.width}_updateMapCanvas(){if(!this.mapData||!this.mapInfo)return;const{width:t,height:e,resolution:s,origin:i}=this.mapInfo;if(!t||!e)return;this.mapCanvas||(this.mapCanvas=document.createElement("canvas")),this.mapCanvas.width=t,this.mapCanvas.height=e;const n=this.mapCanvas.getContext("2d"),r=n.createImageData(t,e);for(let a=0;a<e;a++)for(let l=0;l<t;l++){const c=a*t+l,h=this.mapData[c],u=((e-1-a)*t+l)*4;let p,g,m;if(h===-1)p=100,g=100,m=120;else if(h<=10)p=220,g=255,m=220;else if(h>=65)p=180-Math.min(100,h),g=20,m=20;else{const f=(h-10)/55;p=Math.round(255-f*75),g=Math.round(180-f*160),m=Math.round(100-f*80)}r.data[u]=p,r.data[u+1]=g,r.data[u+2]=m,r.data[u+3]=255}n.putImageData(r,0,0)}_updateCostmapCanvas(){if(!this.mapData||!this.mapInfo)return;const{width:t,height:e,resolution:s}=this.mapInfo;if(!t||!e)return;this.costmapCanvas||(this.costmapCanvas=document.createElement("canvas")),this.costmapCanvas.width=t,this.costmapCanvas.height=e;const i=this.costmapCanvas.getContext("2d"),n=i.createImageData(t,e),r=this.costmapRobotRadius>0?Math.ceil(this.costmapRobotRadius/s):0,a=50,l=[];for(let c=0;c<e;c++)for(let h=0;h<t;h++)this.mapData[c*t+h]>=a&&l.push({gx:h,gy:c});for(let c=0;c<e;c++)for(let h=0;h<t;h++){const d=this.mapData[c*t+h],p=((e-1-c)*t+h)*4;if(d===-1||r<=0){n.data[p+3]=0;continue}if(d>=a){n.data[p]=255,n.data[p+1]=0,n.data[p+2]=0,n.data[p+3]=180;continue}let g=1/0;for(const f of l){const _=h-f.gx,x=c-f.gy;if(Math.abs(_)>r||Math.abs(x)>r)continue;const v=_*_+x*x;v<g&&(g=v)}const m=Math.sqrt(g);if(m<=r){const f=m/r,_=255,x=Math.round(f*200),v=0,S=Math.round(150*(1-f*.7));n.data[p]=_,n.data[p+1]=x,n.data[p+2]=v,n.data[p+3]=S}else n.data[p+3]=0}i.putImageData(n,0,0)}_updateMapQualityCanvas(){if(!this.mapData||!this.mapInfo)return;const{width:t,height:e,resolution:s,origin:i}=this.mapInfo;if(!t||!e)return;this.mapQualityCanvas||(this.mapQualityCanvas=document.createElement("canvas")),this.mapQualityCanvas.width=t,this.mapQualityCanvas.height=e;const n=this.mapQualityCanvas.getContext("2d"),r=n.createImageData(t,e),a=I.getObstacles(),l=50;let c=0,h=0;for(let d=0;d<e;d++)for(let u=0;u<t;u++){const p=this.mapData[d*t+u],m=((e-1-d)*t+u)*4;if(p===-1){r.data[m]=128,r.data[m+1]=128,r.data[m+2]=128,r.data[m+3]=100;continue}const f=u*s+i.position.x+s/2,_=d*s+i.position.y+s/2,x=this._isPointInAnyObstacle(f,_,a),v=p>=l;h++,v===x?(c++,r.data[m]=0,r.data[m+1]=200,r.data[m+2]=0,r.data[m+3]=100):v&&!x?(r.data[m]=255,r.data[m+1]=0,r.data[m+2]=0,r.data[m+3]=160):(r.data[m]=0,r.data[m+1]=80,r.data[m+2]=255,r.data[m+3]=160)}this.mapQualityScore=h>0?c/h*100:null,n.putImageData(r,0,0)}_isPointInAnyObstacle(t,e,s){for(const i of s)if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height)return!0;return!1}_renderMapOverlay(){if(!this.mapCanvas||!this.mapInfo)return;const t=this.ctx;t.save(),t.globalAlpha=this.mapOpacity,t.imageSmoothingEnabled=!1,t.drawImage(this.mapCanvas,0,0,this.canvas.width,this.canvas.height),t.restore()}_renderCostmapOverlay(){if(!this.costmapCanvas||!this.mapInfo)return;const t=this.ctx;t.save(),t.globalAlpha=.5,t.imageSmoothingEnabled=!1,t.drawImage(this.costmapCanvas,0,0,this.canvas.width,this.canvas.height),t.restore()}_renderMapQualityOverlay(){if(!this.mapQualityCanvas||!this.mapInfo)return;const t=this.ctx;if(t.save(),t.globalAlpha=.5,t.imageSmoothingEnabled=!1,t.drawImage(this.mapQualityCanvas,0,0,this.canvas.width,this.canvas.height),t.restore(),this.mapQualityScore!==null){const e=`Accuracy: ${this.mapQualityScore.toFixed(1)}%`;t.save(),t.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';const s=t.measureText(e),i=6,n=s.width+i*2,r=20;t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(8,8,n,r),t.fillStyle="#fff",t.textBaseline="middle",t.fillText(e,8+i,8+r/2),t.restore()}}_render(){const t=this.ctx,e=this.canvas.width,s=this.canvas.height;if(t.fillStyle=`rgb(${this.background.r}, ${this.background.g}, ${this.background.b})`,t.fillRect(0,0,e,s),this.showMap&&this._renderMapOverlay(),this.showCostmap&&this._renderCostmapOverlay(),this.showMapQuality&&this._renderMapQualityOverlay(),this.showObstacles&&this._renderObstacles(),!this.hasTurtlesim){this._renderEmptyState();return}this._renderTrails(),this.showLidar&&this.lidarData&&this._renderLidar(),this._renderTurtles(),this.waypoints.length>0&&this._renderWaypoints(),this.showTF&&this._renderTFFrames()}_renderEmptyState(){const t=this.ctx,e=this.canvas.width,s=this.canvas.height;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,e,s),t.fillStyle="#ffffff",t.font='14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("Run: ros2 run turtlesim turtlesim_node",e/2,s/2),t.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.fillStyle="rgba(255, 255, 255, 0.7)",t.fillText("to start the simulation",e/2,s/2+20)}_renderObstacles(){const t=this.ctx,e=I.getObstacles();t.fillStyle="rgba(100, 100, 100, 0.8)",t.strokeStyle="#444",t.lineWidth=2;for(const s of e){const i=this._worldToCanvas(s.x,s.y+s.height),n=this._worldToCanvasScale(s.width),r=this._worldToCanvasScale(s.height);t.fillRect(i.x,i.y,n,r),t.strokeRect(i.x,i.y,n,r)}}_renderTrails(){const t=this.ctx;for(const e of this.trails){const s=this._worldToCanvas(e.x1,e.y1),i=this._worldToCanvas(e.x2,e.y2);t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(i.x,i.y),t.strokeStyle=e.color,t.lineWidth=e.width,t.lineCap="round",t.stroke()}}_renderTurtles(){const t=this.ctx,e=this._worldToCanvasScale(1.2);for(const s of this.turtles){const i=this._worldToCanvas(s.x,s.y);t.save(),t.translate(i.x,i.y),t.rotate(-s.theta),this.turtleImageLoaded?t.drawImage(this.turtleImage,-e/2,-e/2,e,e):(t.beginPath(),t.moveTo(e/2,0),t.lineTo(-e/2,-e/3),t.lineTo(-e/2,e/3),t.closePath(),t.fillStyle="#00ff00",t.fill(),t.strokeStyle="#006400",t.stroke()),t.restore()}}_renderWaypoints(){const t=this.ctx,e=this._worldToCanvasScale(.3);for(let s=0;s<this.waypoints.length;s++){const i=this.waypoints[s],n=this._worldToCanvas(i.x,i.y);t.beginPath(),t.arc(n.x,n.y,e,0,Math.PI*2),t.fillStyle="rgba(255, 165, 0, 0.8)",t.fill(),t.strokeStyle="#cc7700",t.lineWidth=2,t.stroke(),t.fillStyle="#ffffff",t.font=`bold ${Math.max(10,e)}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(`${s+1}`,n.x,n.y)}}_renderLidar(){const t=this.ctx,{x:e,y:s,theta:i,scan:n}=this.lidarData;if(!n||!n.ranges)return;const r=this._worldToCanvas(e,s);t.strokeStyle="rgba(255, 0, 0, 0.3)",t.lineWidth=1;const{angle_min:a,angle_increment:l,ranges:c}=n;for(let h=0;h<c.length;h++){const d=c[h];if(!isFinite(d))continue;const u=i+a+h*l,p=e+Math.cos(u)*d,g=s+Math.sin(u)*d,m=this._worldToCanvas(p,g);t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(m.x,m.y),t.stroke(),d<n.range_max-.1&&(t.fillStyle="red",t.beginPath(),t.arc(m.x,m.y,2,0,Math.PI*2),t.fill())}}_renderTFFrames(){const t=this.ctx,e=this._worldToCanvasScale(.5);for(const s of this.turtles){const i=this._worldToCanvas(s.x,s.y);t.save(),t.translate(i.x,i.y),t.rotate(-s.theta),t.beginPath(),t.moveTo(0,0),t.lineTo(e,0),t.strokeStyle="red",t.lineWidth=2,t.stroke(),t.beginPath(),t.moveTo(0,0),t.lineTo(0,-e),t.strokeStyle="green",t.stroke(),t.restore()}}toggleObstacles(){this.showObstacles=!this.showObstacles,this._render()}toggleLidar(){this.showLidar=!this.showLidar,this._render()}toggleTF(){this.showTF=!this.showTF,this._render()}clearTrails(){this.trails=[],this._render()}setEditMode(t){this.editMode=t,this.canvas.style.cursor=t==="none"?"default":t==="add"?"crosshair":"pointer",window.dispatchEvent(new CustomEvent(b.CANVAS_EDIT_MODE_CHANGED,{detail:{mode:t}}))}getEditMode(){return this.editMode}setObstacleSize(t){this.newObstacleSize=Math.max(.3,Math.min(3,t))}randomizeObstacles(t=5){I.randomizeObstacles(t)}clearObstacles(){I.clearNonWallObstacles()}resetObstacles(){I.resetObstacles()}toggleMap(){return this.showMap=!this.showMap,this._render(),this.showMap}setMapOpacity(t){this.mapOpacity=Math.max(0,Math.min(1,t)),this.showMap&&this._render()}getMapOpacity(){return this.mapOpacity}isMapVisible(){return this.showMap}toggleCostmap(){return this.showCostmap=!this.showCostmap,this.showCostmap&&this._updateCostmapCanvas(),this._render(),this.showCostmap}setCostmapRobotRadius(t){this.costmapRobotRadius=Math.max(0,Math.min(3,t)),this.showCostmap&&(this._updateCostmapCanvas(),this._render())}toggleMapQuality(){return this.showMapQuality=!this.showMapQuality,this.showMapQuality&&this._updateMapQualityCanvas(),this._render(),this.showMapQuality}}class Ft{constructor(t="map-canvas"){typeof t=="string"?this.canvas=document.getElementById(t):this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.mapData=null,this.mapInfo=null,this.robotX=0,this.robotY=0,this.robotTheta=0,this._setupEventListeners(),this._render()}_setupEventListeners(){window.addEventListener(b.MAP_UPDATE,t=>{const{map:e,info:s}=t.detail;this.mapData=e,this.mapInfo=s,this._render()}),window.addEventListener(b.ROBOT_POSE_UPDATE,t=>{const{x:e,y:s,theta:i}=t.detail;this.robotX=e,this.robotY=s,this.robotTheta=i,this._render()}),window.addEventListener("resize",()=>this._handleResize()),window.addEventListener(b.LAYOUT_RESIZE,()=>this._handleResize()),this._handleResize()}_handleResize(){const t=this.canvas.parentElement;if(!t)return;const e=t.getBoundingClientRect(),s=Math.min(e.width,e.height,500);this.canvas.width=s,this.canvas.height=s,this._render()}_mapToCanvas(t,e){if(!this.mapInfo)return{x:0,y:0};const{width:s,height:i,resolution:n,origin:r}=this.mapInfo,a=r.position.x+t*n,l=r.position.y+e*n,c=s*n,h=i*n,d=this.canvas.width/c,u=this.canvas.height/h;return{x:(a-r.position.x)*d,y:this.canvas.height-(l-r.position.y)*u}}_worldToCanvas(t,e){if(!this.mapInfo){const d=this.canvas.width/11;return{x:t*d,y:this.canvas.height-e*d}}const{width:s,height:i,resolution:n,origin:r}=this.mapInfo,a=s*n,l=i*n,c=this.canvas.width/a,h=this.canvas.height/l;return{x:(t-r.position.x)*c,y:this.canvas.height-(e-r.position.y)*h}}_render(){const t=this.ctx,e=this.canvas.width,s=this.canvas.height;t.fillStyle="#808080",t.fillRect(0,0,e,s),this.mapData&&this.mapInfo&&this._renderOccupancyGrid(),this._renderRobot()}_renderOccupancyGrid(){const t=this.ctx,{width:e,height:s,resolution:i,origin:n}=this.mapInfo,r=this.mapData,a=this.canvas.width/e,l=this.canvas.height/s,c=t.createImageData(this.canvas.width,this.canvas.height),h=c.data;for(let d=0;d<s;d++)for(let u=0;u<e;u++){const p=d*e+u,g=r[p],m=s-1-d;let f,_,x;g===-1?f=_=x=128:g===0?f=_=x=255:f=_=x=Math.max(0,255-g*2.55);for(let v=0;v<Math.ceil(l);v++)for(let S=0;S<Math.ceil(a);S++){const P=Math.floor(u*a)+S,M=Math.floor(m*l)+v;if(P<this.canvas.width&&M<this.canvas.height){const R=(M*this.canvas.width+P)*4;h[R]=f,h[R+1]=_,h[R+2]=x,h[R+3]=255}}}t.putImageData(c,0,0)}_renderRobot(){const t=this.ctx,e=this._worldToCanvas(this.robotX,this.robotY),s=15;t.save(),t.translate(e.x,e.y),t.rotate(-this.robotTheta),t.beginPath(),t.moveTo(s,0),t.lineTo(-s/2,-s/2),t.lineTo(-s/3,0),t.lineTo(-s/2,s/2),t.closePath(),t.fillStyle="rgba(0, 150, 255, 0.8)",t.fill(),t.strokeStyle="#0066cc",t.lineWidth=2,t.stroke(),t.restore()}updateMap(t,e){this.mapData=t,this.mapInfo=e,this._render()}updateRobotPose(t,e,s){this.robotX=t,this.robotY=e,this.robotTheta=s,this._render()}clear(){this.mapData=null,this.mapInfo=null,this._render()}}class Bt{subscribe(t,e,s,i,n){throw new Error("subscribe() must be implemented")}unsubscribe(t){throw new Error("unsubscribe() must be implemented")}publish(t,e,s){throw new Error("publish() must be implemented")}advertise(t,e,s,i){throw new Error("advertise() must be implemented")}unadvertise(t){throw new Error("unadvertise() must be implemented")}advertiseService(t,e,s,i){throw new Error("advertiseService() must be implemented")}unadvertiseService(t){throw new Error("unadvertiseService() must be implemented")}callService(t,e,s){throw new Error("callService() must be implemented")}advertiseAction(t,e,s,i){throw new Error("advertiseAction() must be implemented")}unadvertiseAction(t){throw new Error("unadvertiseAction() must be implemented")}sendActionGoal(t,e,s,i){throw new Error("sendActionGoal() must be implemented")}getTopics(){throw new Error("getTopics() must be implemented")}getServices(){throw new Error("getServices() must be implemented")}getActions(){throw new Error("getActions() must be implemented")}destroy(){throw new Error("destroy() must be implemented")}}const A=Object.freeze({reliability:"reliable",durability:"volatile",history:"keep_last",depth:10}),Z=Object.freeze({default:{...A},system_default:{...A},sensor_data:{reliability:"best_effort",durability:"volatile",history:"keep_last",depth:5},services_default:{reliability:"reliable",durability:"volatile",history:"keep_last",depth:10},parameters:{reliability:"reliable",durability:"volatile",history:"keep_last",depth:1e3},parameter_events:{reliability:"reliable",durability:"volatile",history:"keep_last",depth:1e3}}),tt=["reliable","best_effort"],et=["volatile","transient_local"],st=["keep_last","keep_all"];function j(o){return o?{reliability:o.reliability||A.reliability,durability:o.durability||A.durability,history:o.history||A.history,depth:o.depth!=null?o.depth:A.depth}:{...A}}function it(o,t="    "){const e=j(o),s=e.history==="keep_last"?`KEEP_LAST (${e.depth})`:"KEEP_ALL";return[`${t}Reliability: ${e.reliability.toUpperCase()}`,`${t}Durability: ${e.durability.toUpperCase()}`,`${t}History (Depth): ${s}`]}function ft(o){const t=[];let e=null,s=null,i=null,n=null,r=null;const a=["--qos-profile","--qos-reliability","--qos-durability","--qos-history","--qos-depth"];for(let c=0;c<o.length;c++){const h=o[c];if(a.includes(h)&&c+1>=o.length)return{qos:null,remaining:t,error:`${h} requires a value`};if(h==="--qos-profile")e=o[++c];else if(h==="--qos-reliability")s=o[++c];else if(h==="--qos-durability")i=o[++c];else if(h==="--qos-history")n=o[++c];else if(h==="--qos-depth"){const d=o[++c];if(r=parseInt(d,10),isNaN(r)||r<=0)return{qos:null,remaining:t,error:`Invalid depth '${d}'. Must be a positive integer.`}}else t.push(h)}if(!e&&!s&&!i&&!n&&r==null)return{qos:null,remaining:t};let l;if(e){if(l=Z[e],!l)return{qos:null,remaining:t,error:`Unknown QoS profile '${e}'. Available: ${Object.keys(Z).join(", ")}`};l={...l}}else l={...A};if(s!=null){if(!tt.includes(s))return{qos:null,remaining:t,error:`Invalid reliability '${s}'. Must be: ${tt.join(" or ")}`};l.reliability=s}if(i!=null){if(!et.includes(i))return{qos:null,remaining:t,error:`Invalid durability '${i}'. Must be: ${et.join(" or ")}`};l.durability=i}if(n!=null){if(!st.includes(n))return{qos:null,remaining:t,error:`Invalid history '${n}'. Must be: ${st.join(" or ")}`};l.history=n}return r!=null&&(l.depth=r),{qos:l,remaining:t}}class ot extends Bt{constructor(){super(),this.topics=new Map,this.services=new Map,this.actions=new Map,this.nextId=1}_generateId(){return`id_${this.nextId++}`}_ensureTopic(t,e){if(!this.topics.has(t))this.topics.set(t,{type:e,publishers:new Map,subscribers:new Map});else{const s=this.topics.get(t);s.type!==e&&e!=="unknown"&&s.type!=="unknown"&&console.warn(`[WARN] Topic '${t}' already exists with type '${s.type}', but was requested with type '${e}'. In ROS2, all publishers and subscribers on a topic must use the same type.`)}return this.topics.get(t)}subscribe(t,e,s,i=null,n){const r=this._ensureTopic(t,e),a=this._generateId();return r.subscribers.set(a,{callback:s,msgType:e,nodeId:i,qos:j(n)}),a}unsubscribe(t){for(const[,e]of this.topics)if(e.subscribers.has(t))return e.subscribers.delete(t),!0;return!1}publish(t,e,s){const i=this.topics.get(t);if(!i)return;const n={...s,_timestamp:s._timestamp||Date.now()};for(const[,r]of i.subscribers)try{r.callback(n)}catch(a){console.error(`Error in subscriber callback for ${t}:`,a)}}advertise(t,e,s,i){const n=this._ensureTopic(t,e),r=this._generateId();return n.publishers.set(r,{nodeId:s,msgType:e,qos:j(i)}),r}unadvertise(t){for(const[,e]of this.topics)if(e.publishers.has(t))return e.publishers.delete(t),!0;return!1}advertiseService(t,e,s,i){const n=this._generateId();return this.services.set(t,{id:n,type:e,handler:s,nodeId:i}),n}unadvertiseService(t){for(const[e,s]of this.services)if(s.id===t)return this.services.delete(e),!0;return!1}async callService(t,e,s){const i=this.services.get(t);if(!i)throw new Error(`Service '${t}' not available`);if(i.type!==e)throw new Error(`Service type mismatch: expected ${i.type}, got ${e}`);try{return await i.handler(s)}catch(n){throw new Error(`Service call failed: ${n.message}`)}}advertiseAction(t,e,s,i){const n=this._generateId();return this.actions.set(t,{id:n,type:e,handlers:s,nodeId:i,activeGoals:new Map}),n}unadvertiseAction(t){for(const[e,s]of this.actions)if(s.id===t){for(const[i,n]of s.activeGoals)n.cancelCallback&&n.cancelCallback();return this.actions.delete(e),!0}return!1}async sendActionGoal(t,e,s,i){const n=this.actions.get(t);if(!n)throw new Error(`Action '${t}' not available`);if(n.type!==e)throw new Error(`Action type mismatch: expected ${n.type}, got ${e}`);const r=this._generateId();if(n.handlers.goalCallback&&!await n.handlers.goalCallback(s))throw new Error("Goal rejected");const a={id:r,goal:s,feedbackCallback:i,canceled:!1};n.activeGoals.set(r,a);try{const l=await n.handlers.executeCallback(s,r,c=>{i&&!a.canceled&&i(c)},()=>a.canceled);return n.activeGoals.delete(r),l}catch(l){throw n.activeGoals.delete(r),l}}cancelActionGoal(t,e){const s=this.actions.get(t);if(!s)return!1;const i=s.activeGoals.get(e);return i?(i.canceled=!0,s.handlers.cancelCallback&&s.handlers.cancelCallback(e),!0):!1}getTopics(){const t=[];for(const[e,s]of this.topics)t.push({name:e,type:s.type,publishers:Array.from(s.publishers.values()),subscribers:Array.from(s.subscribers.values())});return t}getServices(){const t=[];for(const[e,s]of this.services)t.push({name:e,type:s.type,node:s.nodeId});return t}getActions(){const t=[];for(const[e,s]of this.actions)t.push({name:e,type:s.type,node:s.nodeId});return t}destroy(){for(const[,t]of this.actions)for(const[e,s]of t.activeGoals)s.canceled=!0;this.topics.clear(),this.services.clear(),this.actions.clear()}}class Wt{constructor(){this.comm=new ot,this.nodes=new Map}setCommProvider(t){this.comm&&this.comm.destroy(),this.comm=t}registerNode(t,e={}){this.nodes.set(t,{...e,publishers:[],subscribers:[],services:[],actions:[],parameters:new Map})}unregisterNode(t){const e=this.nodes.get(t);if(e){for(const s of e.publishers)this.comm.unadvertise(s);for(const s of e.subscribers)this.comm.unsubscribe(s);for(const s of e.services)this.comm.unadvertiseService(s);for(const s of e.actions)this.comm.unadvertiseAction(s);this.nodes.delete(t)}}createPublisher(t,e,s,i){const n=this.comm.advertise(e,s,t,i),r=this.nodes.get(t);return r&&r.publishers.push(n),{id:n,topic:e,msgType:s,publish:a=>{this.comm.publish(e,s,a)},destroy:()=>{if(this.comm.unadvertise(n),r){const a=r.publishers.indexOf(n);a>=0&&r.publishers.splice(a,1)}}}}createSubscription(t,e,s,i,n){const r=this.comm.subscribe(e,s,i,t,n),a=this.nodes.get(t);return a&&a.subscribers.push(r),{id:r,topic:e,msgType:s,destroy:()=>{if(this.comm.unsubscribe(r),a){const l=a.subscribers.indexOf(r);l>=0&&a.subscribers.splice(l,1)}}}}createService(t,e,s,i){const n=this.comm.advertiseService(e,s,i,t),r=this.nodes.get(t);return r&&r.services.push(n),{id:n,name:e,type:s,destroy:()=>{if(this.comm.unadvertiseService(n),r){const a=r.services.indexOf(n);a>=0&&r.services.splice(a,1)}}}}async callService(t,e,s){return this.comm.callService(t,e,s)}createActionServer(t,e,s,i){const n=this.comm.advertiseAction(e,s,i,t),r=this.nodes.get(t);return r&&r.actions.push(n),{id:n,name:e,type:s,destroy:()=>{if(this.comm.unadvertiseAction(n),r){const a=r.actions.indexOf(n);a>=0&&r.actions.splice(a,1)}}}}async sendActionGoal(t,e,s,i){return this.comm.sendActionGoal(t,e,s,i)}publish(t,e,s){this.comm.publish(t,e,s)}subscribe(t,e,s,i){return this.comm.subscribe(t,e,s,null,i)}unsubscribe(t){return this.comm.unsubscribe(t)}getNodes(){return Array.from(this.nodes.keys())}getNodeInfo(t){return this.nodes.get(t)}getTopics(){return this.comm.getTopics()}getTopicInfo(t){return this.comm.getTopics().find(s=>s.name===t)}getServices(){return this.comm.getServices()}getServiceInfo(t){return this.comm.getServices().find(s=>s.name===t)}getActions(){return this.comm.getActions()}getActionInfo(t){return this.comm.getActions().find(s=>s.name===t)}reset(){for(const t of this.nodes.keys())this.unregisterNode(t);this.comm.destroy(),this.comm=new ot}}const w=new Wt;z.register("simDDS",w);class Gt{constructor(t="graph-container"){typeof t=="string"?this.container=document.getElementById(t):this.container=t,this.cy=null,this.updateInterval=null,this._initCytoscape()}_initCytoscape(){this.cy=null,this.initialized=!1,this.lastGraphSignature=""}_ensureInitialized(){this.initialized||(this.cy=Mt({container:this.container,elements:[],style:[{selector:'node[type="node"]',style:{"background-color":"#4a90d9",label:"data(label)","text-valign":"center","text-halign":"center",color:"#fff","font-size":"12px",width:"80px",height:"40px",shape:"round-rectangle","text-wrap":"wrap","text-max-width":"70px"}},{selector:'node[type="topic"]',style:{"background-color":"#6c757d",label:"data(label)","text-valign":"center","text-halign":"center",color:"#fff","font-size":"10px",width:"100px",height:"30px",shape:"rectangle","text-wrap":"wrap","text-max-width":"90px"}},{selector:"edge",style:{width:2,"line-color":"#aaa","target-arrow-color":"#aaa","target-arrow-shape":"triangle","curve-style":"bezier"}},{selector:'edge[type="publish"]',style:{"line-color":"#28a745","target-arrow-color":"#28a745"}},{selector:'edge[type="subscribe"]',style:{"line-color":"#dc3545","target-arrow-color":"#dc3545"}}],layout:{name:"preset"}}),this.initialized=!0)}update(){if(!this.initialized||!this.cy)return;const t=w.getNodes(),e=w.getTopics(),s=[],i=new Set,n=new Set,r=[];for(const l of t){const c=`node_${l}`;i.add(c),r.push(c),s.push({data:{id:c,label:l.replace(/^\//,""),type:"node"}})}for(const l of e){const c=`topic_${l.name}`;if(!(l.publishers.length===0&&l.subscribers.length===0)){n.has(c)||(n.add(c),r.push(c),s.push({data:{id:c,label:l.name,type:"topic"}}));for(const h of l.publishers){const d=`node_${h.nodeId}`;if(i.has(d)){const u=`${d}_to_${c}`;r.push(u),s.push({data:{id:u,source:d,target:c,type:"publish"}})}}for(const h of l.subscribers){const d=`node_${h.nodeId}`;if(i.has(d)){const u=`${c}_to_${d}`;r.push(u),s.push({data:{id:u,source:c,target:d,type:"subscribe"}})}}}}const a=r.sort().join(",");a!==this.lastGraphSignature&&(this.lastGraphSignature=a,this.cy.resize(),this.cy.elements().remove(),this.cy.add(s),s.length>0&&(this.cy.layout({name:"cose",animate:!1,nodeDimensionsIncludeLabels:!0,nodeRepulsion:4e3,idealEdgeLength:80,padding:50}).run(),this.cy.fit(void 0,50),this.cy.center()))}startAutoUpdate(t=1e3){this.stopAutoUpdate(),this.update(),this.updateInterval=setInterval(()=>this.update(),t)}stopAutoUpdate(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null)}show(){const t=document.getElementById("canvas-container");t==null||t.classList.add("hidden"),this.container.classList.remove("hidden"),setTimeout(()=>{this._ensureInitialized(),this.cy&&this.cy.resize(),this.startAutoUpdate(),setTimeout(()=>{this.cy&&(this.cy.resize(),this.cy.fit(void 0,50),this.cy.center())},200)},100)}hide(){this.container.classList.add("hidden"),this.stopAutoUpdate();const t=document.getElementById("canvas-container");t==null||t.classList.remove("hidden"),window.dispatchEvent(new Event(b.LAYOUT_RESIZE))}toggle(){this.container.classList.contains("hidden")?this.show():this.hide()}destroy(){this.stopAutoUpdate(),this.cy&&(this.cy.destroy(),this.cy=null),this.initialized=!1}}class Ht{constructor(t={}){this.panel=t.panel||document.getElementById("console-panel"),this.messagesContainer=t.messages||document.getElementById("console-messages"),this.filterLevel=t.filterLevel||document.getElementById("console-filter-level"),this.filterNode=t.filterNode||document.getElementById("console-filter-node"),this.clearButton=t.clearButton||document.getElementById("console-clear"),this.pauseButton=t.pauseButton||document.getElementById("console-pause"),this.closeButton=t.closeButton||document.getElementById("console-close"),this.paused=!1,this.pendingLogs=[],this.maxDisplayedLogs=500,this.unsubscribe=null,this._setupEventListeners()}_setupEventListeners(){var t,e,s,i,n;(t=this.filterLevel)==null||t.addEventListener("change",()=>{this._refreshLogs()}),(e=this.filterNode)==null||e.addEventListener("input",()=>{this._refreshLogs()}),(s=this.clearButton)==null||s.addEventListener("click",()=>{this._clearLogs()}),(i=this.pauseButton)==null||i.addEventListener("click",()=>{this._togglePause()}),(n=this.closeButton)==null||n.addEventListener("click",()=>{this.hide()}),this.unsubscribe=E.addListener(r=>{this._handleLogEntry(r)})}_handleLogEntry(t){if(this.paused){this.pendingLogs.push(t);return}this._addLogEntry(t)}_addLogEntry(t){var n,r,a;if(!this.messagesContainer)return;const e=E.parseLevel(((n=this.filterLevel)==null?void 0:n.value)||"INFO");if(t.levelValue<e)return;const s=(a=(r=this.filterNode)==null?void 0:r.value)==null?void 0:a.toLowerCase();if(s&&!t.node.toLowerCase().includes(s))return;const i=document.createElement("div");for(i.className=`log-entry log-${t.level.toLowerCase()}`,i.textContent=E.formatEntry(t),this.messagesContainer.appendChild(i);this.messagesContainer.children.length>this.maxDisplayedLogs;)this.messagesContainer.removeChild(this.messagesContainer.firstChild);this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}_refreshLogs(){var i,n;if(!this.messagesContainer)return;this.messagesContainer.innerHTML="";const t={level:(i=this.filterLevel)==null?void 0:i.value,node:(n=this.filterNode)==null?void 0:n.value},e=E.getLogs(t),s=Math.max(0,e.length-this.maxDisplayedLogs);for(let r=s;r<e.length;r++)this._addLogEntry(e[r])}_clearLogs(){this.messagesContainer&&(this.messagesContainer.innerHTML=""),E.clear(),this.pendingLogs=[]}_togglePause(){if(this.paused=!this.paused,this.pauseButton&&(this.pauseButton.textContent=this.paused?"Resume":"Pause"),!this.paused){for(const t of this.pendingLogs)this._addLogEntry(t);this.pendingLogs=[]}}show(){var t;(t=this.panel)==null||t.classList.remove("hidden"),this._refreshLogs()}hide(){var t;(t=this.panel)==null||t.classList.add("hidden")}toggle(){var t;(t=this.panel)!=null&&t.classList.contains("hidden")?this.show():this.hide()}destroy(){this.unsubscribe&&this.unsubscribe()}}class qt{constructor(t={}){this.visualizationPanel=t.visualizationPanel||document.getElementById("visualization-panel"),this.terminalPanel=t.terminalPanel||document.getElementById("terminal-panel"),this.canvasContainer=t.canvasContainer||document.getElementById("canvas-container"),this.mapContainer=t.mapContainer||document.getElementById("map-container"),this.graphContainer=t.graphContainer||document.getElementById("graph-container"),this.consolePanel=t.consolePanel||document.getElementById("console-panel"),this.resizing=!1,this.currentLayout="desktop",this._detectLayout(),this._setupResizeObserver(),this._setupMobileSwipe()}_detectLayout(){const t=window.innerWidth;t<768?(this.currentLayout="mobile",document.body.classList.add("mobile-layout"),document.body.classList.remove("tablet-layout","desktop-layout")):t<1024?(this.currentLayout="tablet",document.body.classList.add("tablet-layout"),document.body.classList.remove("mobile-layout","desktop-layout")):(this.currentLayout="desktop",document.body.classList.add("desktop-layout"),document.body.classList.remove("mobile-layout","tablet-layout"))}_setupResizeObserver(){window.addEventListener("resize",()=>{this._detectLayout(),this._triggerResize()})}_setupMobileSwipe(){if(!this.terminalPanel)return;let t=0,e=0;this.terminalPanel.addEventListener("touchstart",s=>{t=s.touches[0].clientX,e=s.touches[0].clientY},{passive:!0}),this.terminalPanel.addEventListener("touchend",s=>{const i=s.changedTouches[0].clientX,n=s.changedTouches[0].clientY,r=i-t,a=n-e;if(Math.abs(r)>Math.abs(a)&&Math.abs(r)>50){const l=new CustomEvent("terminal-swipe",{detail:{direction:r>0?"right":"left"}});this.terminalPanel.dispatchEvent(l)}},{passive:!0})}_triggerResize(){window.dispatchEvent(new Event(b.LAYOUT_RESIZE))}showCanvas(){var t;(t=this.canvasContainer)==null||t.classList.remove("hidden")}hideCanvas(){var t;(t=this.canvasContainer)==null||t.classList.add("hidden")}toggleMap(){window.dispatchEvent(new CustomEvent(b.TOGGLE_MAP_OVERLAY)),this._triggerResize()}showMap(){var t;(t=this.mapContainer)==null||t.classList.remove("hidden"),this._triggerResize()}hideMap(){var t;(t=this.mapContainer)==null||t.classList.add("hidden"),this._triggerResize()}toggleGraph(){var t;(t=this.graphContainer)==null||t.classList.toggle("hidden"),this._triggerResize()}showGraph(){var t;(t=this.graphContainer)==null||t.classList.remove("hidden"),this._triggerResize()}hideGraph(){var t;(t=this.graphContainer)==null||t.classList.add("hidden"),this._triggerResize()}toggleConsole(){var t;(t=this.consolePanel)==null||t.classList.toggle("hidden"),this._triggerResize()}showConsole(){var t;(t=this.consolePanel)==null||t.classList.remove("hidden"),this._triggerResize()}hideConsole(){var t;(t=this.consolePanel)==null||t.classList.add("hidden"),this._triggerResize()}getLayout(){return this.currentLayout}isMobile(){return this.currentLayout==="mobile"}isTablet(){return this.currentLayout==="tablet"}isDesktop(){return this.currentLayout==="desktop"}}class Ut{constructor(){this.activeTab="quickstart",this.modal=null,this.body=null,this.tabContent={}}show(t){this.modal=t;const e=document.getElementById("modal-title");this.body=document.getElementById("modal-body"),!(!this.modal||!this.body)&&(e.textContent="ROS 2 Turtle School - Help",this.body.innerHTML=this._renderTabs()+this._renderContent(),this._setupTabListeners(),this._showTab(this.activeTab),this.modal.classList.remove("hidden"))}_renderTabs(){return`
      <div class="help-tabs" role="tablist" aria-label="Help sections">
        <button class="help-tab active" data-tab="quickstart" role="tab" aria-selected="true" aria-controls="panel-quickstart">Quick Start</button>
        <button class="help-tab" data-tab="commands" role="tab" aria-selected="false" aria-controls="panel-commands">Commands</button>
        <button class="help-tab" data-tab="slam" role="tab" aria-selected="false" aria-controls="panel-slam">SLAM Tutorial</button>
        <button class="help-tab" data-tab="nav2" role="tab" aria-selected="false" aria-controls="panel-nav2">Nav2 Tutorial</button>
      </div>
    `}_renderContent(){return`
      <div class="help-panels">
        <div id="panel-quickstart" class="help-panel active" role="tabpanel" aria-labelledby="tab-quickstart">
          ${this._renderQuickStart()}
        </div>
        <div id="panel-commands" class="help-panel" role="tabpanel" aria-labelledby="tab-commands" hidden>
          ${this._renderCommands()}
        </div>
        <div id="panel-slam" class="help-panel" role="tabpanel" aria-labelledby="tab-slam" hidden>
          ${this._renderSlam()}
        </div>
        <div id="panel-nav2" class="help-panel" role="tabpanel" aria-labelledby="tab-nav2" hidden>
          ${this._renderNav2()}
        </div>
      </div>
    `}_renderQuickStart(){return`
      <div class="help-content">
        <div class="help-section help-intro">
          <p>This emulator lets you learn ROS2 CLI commands in your browser. Follow along with the official tutorial:</p>
          <a href="https://docs.ros.org/en/jazzy/Tutorials/Beginner-CLI-Tools.html" target="_blank" rel="noopener" class="tutorial-link">
            ROS2 Jazzy - Beginner CLI Tools Tutorial
          </a>
        </div>

        <h3>Quick Start</h3>
        <ol>
          <li>Run <code>ros2 run turtlesim turtlesim_node</code> to start turtlesim</li>
          <li>Open a new terminal with the <strong>+</strong> button</li>
          <li>Run <code>ros2 run teleop_twist_keyboard teleop_twist_keyboard</code></li>
          <li>Use <strong>W/A/S/D</strong> keys to move the turtle</li>
        </ol>

        <h3>Available Packages</h3>
        <table class="help-table">
          <tr><td><code>ros2 run turtlesim turtlesim_node</code></td><td>Start turtlesim simulator</td></tr>
          <tr><td><code>ros2 run turtlesim turtle_teleop_key</code></td><td>Control with arrow keys</td></tr>
          <tr><td><code>ros2 run teleop_twist_keyboard teleop_twist_keyboard</code></td><td>Control with WASD keys</td></tr>
          <tr><td><code>ros2 run simple_slam slam_node</code></td><td>Start SLAM mapping node</td></tr>
          <tr><td><code>ros2 run tf2_ros static_transform_publisher</code></td><td>Publish static TF</td></tr>
          <tr><td><code>ros2 run tf2_ros tf2_echo &lt;src&gt; &lt;tgt&gt;</code></td><td>Query transform between frames</td></tr>
          <tr><td><code>ros2 run tf2_ros tf2_monitor</code></td><td>Monitor all TF broadcasts</td></tr>
          <tr><td><code>ros2 run tf2_ros view_frames</code></td><td>Print TF frame tree</td></tr>
          <tr><td><code>ros2 run nav2_simple_navigator navigator_node</code></td><td>Start Nav2 path planner</td></tr>
        </table>

        <h3>Keyboard Shortcuts</h3>
        <ul>
          <li><strong>Ctrl+C</strong> - Stop running command</li>
          <li><strong>Up/Down</strong> - Command history</li>
        </ul>
      </div>
    `}_renderCommands(){return`
      <div class="help-content">
        <h3>ros2 run Options</h3>
        <table class="help-table">
          <tr><td><code>--ros-args --remap __node:=name</code></td><td>Rename node</td></tr>
          <tr><td><code>--ros-args --remap topic:=new_topic</code></td><td>Remap topic</td></tr>
          <tr><td><code>--ros-args --log-level WARN</code></td><td>Set log level</td></tr>
        </table>

        <h3>ros2 node Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 node list</code></td><td>List running nodes</td></tr>
          <tr><td><code>ros2 node info &lt;node&gt;</code></td><td>Show node details</td></tr>
        </table>

        <h3>ros2 topic Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 topic list</code></td><td>List all topics</td></tr>
          <tr><td><code>ros2 topic list -t</code></td><td>List with types</td></tr>
          <tr><td><code>ros2 topic info &lt;topic&gt;</code></td><td>Show topic info</td></tr>
          <tr><td><code>ros2 topic info &lt;topic&gt; --verbose</code></td><td>Show info with QoS profiles</td></tr>
          <tr><td><code>ros2 topic type &lt;topic&gt;</code></td><td>Show message type</td></tr>
          <tr><td><code>ros2 topic echo &lt;topic&gt;</code></td><td>Print messages</td></tr>
          <tr><td><code>ros2 topic pub &lt;topic&gt; &lt;type&gt; "&lt;yaml&gt;"</code></td><td>Publish message</td></tr>
          <tr><td><code>ros2 topic pub --once ...</code></td><td>Publish once</td></tr>
          <tr><td><code>ros2 topic pub -r 10 ...</code></td><td>Publish at rate</td></tr>
          <tr><td><code>ros2 topic hz &lt;topic&gt;</code></td><td>Show publish rate</td></tr>
          <tr><td><code>ros2 topic bw &lt;topic&gt;</code></td><td>Show bandwidth</td></tr>
        </table>

        <h3>QoS Flags (for pub/echo)</h3>
        <table class="help-table">
          <tr><td><code>--qos-profile &lt;name&gt;</code></td><td>Use named profile (sensor_data, default, etc.)</td></tr>
          <tr><td><code>--qos-reliability &lt;policy&gt;</code></td><td>reliable or best_effort</td></tr>
          <tr><td><code>--qos-durability &lt;policy&gt;</code></td><td>volatile or transient_local</td></tr>
          <tr><td><code>--qos-history &lt;policy&gt;</code></td><td>keep_last or keep_all</td></tr>
          <tr><td><code>--qos-depth &lt;n&gt;</code></td><td>Queue depth for keep_last (default: 10)</td></tr>
        </table>

        <h3>ros2 service Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 service list</code></td><td>List all services</td></tr>
          <tr><td><code>ros2 service list -t</code></td><td>List with types</td></tr>
          <tr><td><code>ros2 service type &lt;service&gt;</code></td><td>Show service type</td></tr>
          <tr><td><code>ros2 service call &lt;srv&gt; &lt;type&gt; "&lt;yaml&gt;"</code></td><td>Call service</td></tr>
        </table>
        <p><em>Turtlesim services: /spawn, /kill, /turtle1/set_pen, /turtle1/teleport_absolute</em></p>

        <h3>ros2 action Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 action list</code></td><td>List all actions</td></tr>
          <tr><td><code>ros2 action list -t</code></td><td>List with types</td></tr>
          <tr><td><code>ros2 action info &lt;action&gt;</code></td><td>Show action info</td></tr>
          <tr><td><code>ros2 action send_goal &lt;action&gt; &lt;type&gt; "&lt;yaml&gt;"</code></td><td>Send goal</td></tr>
          <tr><td><code>ros2 action send_goal ... --feedback</code></td><td>With feedback</td></tr>
        </table>
        <p><em>Turtlesim action: /turtle1/rotate_absolute</em></p>

        <h3>ros2 param Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 param list</code></td><td>List all parameters</td></tr>
          <tr><td><code>ros2 param list &lt;node&gt;</code></td><td>List node params</td></tr>
          <tr><td><code>ros2 param get &lt;node&gt; &lt;param&gt;</code></td><td>Get parameter value</td></tr>
          <tr><td><code>ros2 param set &lt;node&gt; &lt;param&gt; &lt;value&gt;</code></td><td>Set parameter</td></tr>
          <tr><td><code>ros2 param dump &lt;node&gt;</code></td><td>Dump all params</td></tr>
        </table>
        <p><em>Turtlesim params: background_r, background_g, background_b</em></p>

        <h3>ros2 bag Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 bag record &lt;topics&gt;</code></td><td>Record topics</td></tr>
          <tr><td><code>ros2 bag record -o &lt;name&gt; &lt;topics&gt;</code></td><td>Record with name</td></tr>
          <tr><td><code>ros2 bag record -a</code></td><td>Record all topics</td></tr>
          <tr><td><code>ros2 bag info &lt;bag&gt;</code></td><td>Show bag info</td></tr>
          <tr><td><code>ros2 bag play &lt;bag&gt;</code></td><td>Play back bag</td></tr>
          <tr><td><code>ros2 bag play &lt;bag&gt; --rate 2.0</code></td><td>Play at 2x speed</td></tr>
        </table>

        <h3>ros2 interface Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 interface show &lt;type&gt;</code></td><td>Show message/service definition</td></tr>
          <tr><td><code>ros2 pkg executables &lt;pkg&gt;</code></td><td>List package executables</td></tr>
        </table>

        <h3>rqt Tools</h3>
        <table class="help-table">
          <tr><td><code>rqt_graph</code></td><td>Node/topic graph visualization</td></tr>
          <tr><td><code>rqt_console</code></td><td>Log message viewer</td></tr>
          <tr><td><code>rqt</code></td><td>Open tool selector</td></tr>
        </table>
      </div>
    `}_renderSlam(){return`
      <div class="help-content">
        <div class="slam-tutorial">
          <p>Learn how occupancy grid mapping works with our simple SLAM demo.</p>

          <h4>Step 1: Start Turtlesim</h4>
          <p>In Terminal 1:</p>
          <code>ros2 run turtlesim turtlesim_node</code>
          <p>This spawns a turtle with a simulated LIDAR sensor. The gray boxes are obstacles.</p>

          <h4>Step 2: Start SLAM Node</h4>
          <p>Click <strong>+</strong> to add Terminal 2, then run:</p>
          <code>ros2 run simple_slam slam_node</code>
          <p>The SLAM node subscribes to <code>/scan</code> (LIDAR) and <code>/turtle1/pose</code> (position).</p>

          <h4>Step 3: View the Map</h4>
          <p>Click the <strong>Map</strong> button in the header. You'll see a gray grid (unknown space).</p>

          <h4>Step 4: Start Teleop</h4>
          <p>Click <strong>+</strong> to add Terminal 3, then run:</p>
          <code>ros2 run teleop_twist_keyboard teleop_twist_keyboard</code>
          <p>Use <strong>W/A/S/D</strong> keys to drive the turtle around.</p>

          <h4>Step 5: Watch the Map Build</h4>
          <p>As the turtle moves:</p>
          <ul>
            <li><strong>White cells</strong> = Free space (LIDAR rays passed through)</li>
            <li><strong>Black cells</strong> = Obstacles (LIDAR rays hit something)</li>
            <li><strong>Gray cells</strong> = Unknown (not yet scanned)</li>
          </ul>
          <p>Drive around all the obstacles to build a complete map!</p>

          <h4>Step 6: Inspect the System</h4>
          <p>Open a 4th terminal and explore what SLAM is doing:</p>
          <table class="help-table">
            <tr><td><code>ros2 node info /slam_node</code></td><td>See what the SLAM node subscribes to and publishes</td></tr>
            <tr><td><code>ros2 topic list -t</code></td><td>See all active topics with their types</td></tr>
            <tr><td><code>ros2 interface show sensor_msgs/msg/LaserScan</code></td><td>Understand the lidar message structure</td></tr>
            <tr><td><code>ros2 interface show nav_msgs/msg/OccupancyGrid</code></td><td>Understand the map message structure</td></tr>
          </table>

          <h4>Step 7: Monitor Live Data</h4>
          <table class="help-table">
            <tr><td><code>ros2 topic echo /scan</code></td><td>Watch raw lidar data streaming in</td></tr>
            <tr><td><code>ros2 topic echo /map</code></td><td>Watch occupancy grid values update</td></tr>
            <tr><td><code>ros2 topic hz /scan</code></td><td>Check lidar rate (~10 Hz)</td></tr>
            <tr><td><code>ros2 topic hz /map</code></td><td>Check map publish rate (~2 Hz)</td></tr>
            <tr><td><code>ros2 topic bw /scan</code></td><td>Measure lidar bandwidth</td></tr>
          </table>

          <h4>Step 8: Tune Parameters</h4>
          <p>Change SLAM behavior at runtime:</p>
          <table class="help-table">
            <tr><td><code>ros2 param list /slam_node</code></td><td>See all tunable parameters</td></tr>
            <tr><td><code>ros2 param get /slam_node hit_prob</code></td><td>Check obstacle detection confidence</td></tr>
            <tr><td><code>ros2 param set /slam_node hit_prob 0.95</code></td><td>Increase obstacle confidence</td></tr>
            <tr><td><code>ros2 param set /slam_node miss_prob 0.1</code></td><td>More confident free-space marking</td></tr>
            <tr><td><code>ros2 param dump /slam_node</code></td><td>Dump all current parameter values</td></tr>
          </table>

          <h4>Step 9: Record and Replay</h4>
          <p>Record a mapping session for later analysis:</p>
          <table class="help-table">
            <tr><td><code>ros2 bag record -o my_run /scan /turtle1/pose /map</code></td><td>Record SLAM topics</td></tr>
            <tr><td><code>ros2 bag info my_run</code></td><td>Inspect recorded data</td></tr>
            <tr><td><code>ros2 bag play my_run</code></td><td>Replay the session</td></tr>
            <tr><td><code>ros2 bag play my_run --rate 0.5</code></td><td>Replay at half speed</td></tr>
          </table>

          <h4>Step 10: Map Quality Visualization</h4>
          <p>Click the <strong>Quality</strong> button in the canvas toolbar to compare the SLAM map against the ground truth obstacles:</p>
          <ul>
            <li><strong>Green</strong> = SLAM matches ground truth (correct)</li>
            <li><strong>Red</strong> = False positive (SLAM says occupied, actually free)</li>
            <li><strong>Blue</strong> = False negative (SLAM says free, actually occupied)</li>
            <li><strong>Gray</strong> = Unknown (not yet scanned)</li>
          </ul>
          <p>An accuracy percentage is shown in the top-left corner.</p>

          <h4>SLAM Cell Values</h4>
          <p><code>ros2 topic echo /map</code> shows OccupancyGrid data: <strong>-1</strong> = unknown, <strong>0</strong> = free, <strong>100</strong> = occupied.</p>
        </div>
      </div>
    `}_renderNav2(){return`
      <div class="help-content">
        <div class="slam-tutorial">
          <p>Learn autonomous navigation: build a map with SLAM, then use Nav2 to plan and follow paths.</p>

          <h4>Step 1: Build a Map</h4>
          <p>Follow the SLAM Tutorial first to build a map. You need three terminals:</p>
          <code>ros2 run turtlesim turtlesim_node</code><br>
          <code>ros2 run simple_slam slam_node</code><br>
          <code>ros2 run teleop_twist_keyboard teleop_twist_keyboard</code>
          <p>Drive the turtle around with <strong>W/A/S/D</strong> to scan all obstacles.</p>

          <h4>Step 2: Start the Navigator</h4>
          <p>Open a new terminal and start the Nav2 path planner:</p>
          <code>ros2 run nav2_simple_navigator navigator_node</code>
          <p>The navigator subscribes to <code>/map</code> from SLAM and waits for goals.</p>

          <h4>Step 3: Send a Navigation Goal</h4>
          <p>Send the turtle to a target position using an action goal:</p>
          <code>ros2 action send_goal /navigate_to_pose nav2_msgs/action/NavigateToPose "{pose: {position: {x: 8.0, y: 8.0}}}"</code>
          <p>Watch the turtle plan a path and drive itself to the goal!</p>

          <h4>Step 4: Monitor Navigation</h4>
          <p>Open a 5th terminal to inspect the system while all nodes keep running:</p>
          <table class="help-table">
            <tr><td><code>ros2 topic echo /plan</code></td><td>See the planned path waypoints</td></tr>
            <tr><td><code>ros2 action send_goal ... --feedback</code></td><td>Watch distance remaining</td></tr>
            <tr><td><code>ros2 param get /navigator_node goal_tolerance</code></td><td>Check goal tolerance</td></tr>
          </table>

          <h4>Step 5: Tune Navigator Parameters</h4>
          <table class="help-table">
            <tr><td><code>ros2 param set /navigator_node goal_tolerance 0.5</code></td><td>Increase tolerance (reach goals sooner)</td></tr>
            <tr><td><code>ros2 param set /navigator_node max_speed 2.0</code></td><td>Drive faster</td></tr>
            <tr><td><code>ros2 param set /navigator_node obstacle_threshold 30</code></td><td>Avoid even partially occupied cells</td></tr>
            <tr><td><code>ros2 param set /navigator_node robot_radius 0.8</code></td><td>Increase clearance from obstacles</td></tr>
          </table>

          <h4>Step 6: Loop Closure &amp; Drift</h4>
          <p>Explore how odometry drift affects mapping and why loop closure matters:</p>
          <table class="help-table">
            <tr><td><code>ros2 param set /slam_node drift_enabled true</code></td><td>Enable simulated odometry drift</td></tr>
            <tr><td><code>ros2 param set /slam_node drift_rate 0.02</code></td><td>Increase drift rate to see the effect</td></tr>
            <tr><td><code>ros2 topic echo /loop_closures</code></td><td>Watch for loop closure events</td></tr>
            <tr><td><code>ros2 param set /slam_node loop_closure_enabled true</code></td><td>Enable loop closure correction</td></tr>
          </table>
          <p>Drive in a loop and watch the SLAM node detect when you revisit a location!</p>

          <h4>Step 7: Localization Mode</h4>
          <p>Save your map and switch to localization (no new mapping):</p>
          <table class="help-table">
            <tr><td><code>ros2 service call /slam/save_map std_srvs/srv/Empty</code></td><td>Save the current map</td></tr>
            <tr><td><code>ros2 param set /slam_node localization_mode true</code></td><td>Switch to localization mode</td></tr>
            <tr><td><code>ros2 param set /slam_node localization_mode false</code></td><td>Switch back to mapping</td></tr>
          </table>

          <h4>Step 8: TF2 Frame Queries</h4>
          <p>Explore coordinate transforms between frames:</p>
          <table class="help-table">
            <tr><td><code>ros2 run tf2_ros static_transform_publisher 0 0 0 0 0 0 world base_link</code></td><td>Publish a transform</td></tr>
            <tr><td><code>ros2 run tf2_ros tf2_echo world base_link</code></td><td>Continuously print the transform</td></tr>
            <tr><td><code>ros2 run tf2_ros view_frames</code></td><td>Print the frame tree</td></tr>
            <tr><td><code>ros2 run tf2_ros tf2_monitor</code></td><td>Monitor all TF broadcasts</td></tr>
          </table>

          <h4>Step 9: Waypoint Following</h4>
          <p>Send the turtle through a sequence of waypoints:</p>
          <code>ros2 action send_goal /follow_waypoints nav2_msgs/action/FollowWaypoints "{poses: [{position: {x: 3, y: 3}}, {position: {x: 8, y: 3}}, {position: {x: 8, y: 8}}]}"</code>
          <p>Numbered orange markers appear on the canvas. The turtle visits each in order. Missed waypoints are reported in the result.</p>

          <h4>Step 10: Recovery Behaviors</h4>
          <p>When the robot gets stuck, it automatically spins and backs up to try to free itself.</p>
          <table class="help-table">
            <tr><td><code>ros2 topic echo /recovery_status</code></td><td>Watch recovery events</td></tr>
            <tr><td><code>ros2 param set /navigator_node stuck_timeout 5.0</code></td><td>Seconds before recovery triggers</td></tr>
            <tr><td><code>ros2 param set /navigator_node max_recovery_attempts 5</code></td><td>Max retries before abort</td></tr>
            <tr><td><code>ros2 param set /navigator_node recovery_enabled false</code></td><td>Disable recovery</td></tr>
          </table>

          <h4>Step 11: Costmap Visualization</h4>
          <p>Click the <strong>Costmap</strong> button in the canvas toolbar to see the inflation zone around obstacles. Red = obstacle, orange/yellow = inflation radius.</p>

          <h4>How A* Path Planning Works</h4>
          <p>The navigator uses the A* algorithm on the occupancy grid:</p>
          <ul>
            <li>Converts start and goal positions to grid cells</li>
            <li>Searches the grid using A* with 8-connected neighbors</li>
            <li>Avoids cells with occupancy above <code>obstacle_threshold</code></li>
            <li>Publishes the path to <code>/plan</code></li>
            <li>Follows the path using a proportional controller on <code>/turtle1/cmd_vel</code></li>
          </ul>
        </div>
      </div>
    `}_setupTabListeners(){this.body.querySelectorAll(".help-tab").forEach(e=>{e.addEventListener("click",()=>{const s=e.dataset.tab;this._showTab(s)})})}_showTab(t){this.activeTab=t,this.body.querySelectorAll(".help-tab").forEach(i=>{const n=i.dataset.tab===t;i.classList.toggle("active",n),i.setAttribute("aria-selected",n?"true":"false")}),this.body.querySelectorAll(".help-panel").forEach(i=>{const n=i.id===`panel-${t}`;i.classList.toggle("active",n),i.hidden=!n})}}const Vt=new Ut;class Yt{constructor(){this.commands=new Map,this.ros2Commands=new Map}register(t,e){this.commands.set(t,e)}registerRos2(t,e){this.ros2Commands.set(t,e)}hasCommand(t){return this.commands.has(t)}hasRos2Command(t){return this.ros2Commands.has(t)}async execute(t,e,s){const i=this.commands.get(t);return i?(await i(e,s),!0):!1}async executeRos2(t,e,s){const i=this.ros2Commands.get(t);return i?(await i(e,s),!0):!1}listCommands(){return Array.from(this.commands.keys())}listRos2Commands(){return Array.from(this.ros2Commands.keys())}}const T=new Yt;class Xt{constructor(){this.packages={}}getNode(t,e){const s=this.packages[t];return s&&s[e]||null}listPackages(){return Object.keys(this.packages)}listExecutables(t){const e=this.packages[t];return e?Object.keys(e):[]}register(t,e,s){this.packages[t]||(this.packages[t]={}),this.packages[t][e]=s}hasPackage(t){return!!this.packages[t]}hasExecutable(t,e){return!!this.getNode(t,e)}}const C=new Xt;async function Qt(o,t){if(o.length<2){t.writeln("usage: ros2 run <package_name> <executable_name>"),t.writeln(""),t.writeln("Run an executable from a package."),t.finishCommand();return}const e=o[0],s=o[1],i=Kt(o.slice(2)),n=C.getNode(e,s);if(!n){t.writeln(`\x1B[31mPackage '${e}' not found or executable '${s}' not found\x1B[0m`),t.writeln(""),t.writeln("Available packages and executables:");const l=C.listPackages();for(const c of l){const h=C.listExecutables(c);for(const d of h)t.writeln(`  ${c} ${d}`)}t.finishCommand();return}let r=s;i.remap&&i.remap.__node&&(r=i.remap.__node);const a=`/${r}`;if(k.isNodeRunning(a)){t.writeln(`\x1B[33mNode with name '${a}' is already running\x1B[0m`),t.finishCommand();return}i.logLevel&&E.setNodeLevel(a,i.logLevel);try{const l=[];for(const d of o.slice(2)){if(d==="--ros-args")break;l.push(d)}const c=new n(r,{namespace:i.namespace,parameters:i.params,remappings:i.remap,args:l}),h=k.spawn(c,t.id,e,s);t.writeln(`\x1B[32m[INFO] Started ${e}/${s}\x1B[0m`)}catch(l){t.writeln(`\x1B[31mError starting node: ${l.message}\x1B[0m`),t.finishCommand()}}function Kt(o){const t={remap:{},params:{},namespace:"",logLevel:null,paramsFile:null};let e=0,s=!1;for(;e<o.length;){const i=o[e];if(i==="--ros-args"){s=!0,e++;continue}if(!s){e++;continue}if(i==="--remap"||i==="-r"){if(e+1<o.length){const r=o[e+1].split(":=");r.length===2&&(t.remap[r[0]]=r[1]),e+=2}else e++;continue}if(i.includes(":=")){const n=i.split(":=");n.length===2&&(t.remap[n[0]]=n[1]),e++;continue}if(i==="--param"||i==="-p"){if(e+1<o.length){const r=o[e+1].split(":=");r.length===2&&(t.params[r[0]]=jt(r[1])),e+=2}else e++;continue}if(i==="--params-file"){e+1<o.length?(t.paramsFile=o[e+1],e+=2):e++;continue}if(i==="--log-level"){e+1<o.length?(t.logLevel=o[e+1].toUpperCase(),e+=2):e++;continue}if(i==="-n"||i==="--namespace"){e+1<o.length?(t.namespace=o[e+1],e+=2):e++;continue}e++}return t}function jt(o){if(o==="true")return!0;if(o==="false")return!1;const t=Number(o);return isNaN(t)?o:t}T.registerRos2("run",Qt);async function Jt(o,t){if(o.length===0){nt(t),t.finishCommand();return}const e=o[0],s=o.slice(1);switch(e){case"list":Zt(s,t);break;case"info":te(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),nt(t)}t.finishCommand()}function nt(o){o.writeln("usage: ros2 node <command> [options]"),o.writeln(""),o.writeln("Commands:"),o.writeln("  list    List running nodes"),o.writeln("  info    Show information about a node")}function Zt(o,t){const e=w.getNodes();if(e.length===0){t.writeln("No nodes are currently running.");return}for(const s of e.sort())t.writeln(s)}function te(o,t){var a,l,c,h;if(o.length===0){t.writeln("usage: ros2 node info <node_name>");return}let e=o[0];if(e.startsWith("/")||(e="/"+e),!w.getNodeInfo(e)){t.writeln(`\x1B[31mNode '${e}' not found\x1B[0m`);return}t.writeln(`${e}`);const i=k.getProcessByNodeName(e),n=i==null?void 0:i.node,r=[{label:"Subscribers",items:((a=n==null?void 0:n.subscriptions)==null?void 0:a.map(d=>`${d.topic}: ${d.msgType}`))||[]},{label:"Publishers",items:((l=n==null?void 0:n.publishers)==null?void 0:l.map(d=>`${d.topic}: ${d.msgType}`))||[]},{label:"Service Servers",items:((c=n==null?void 0:n.services)==null?void 0:c.map(d=>`${d.name}: ${d.type}`))||[]},{label:"Service Clients",items:[]},{label:"Action Servers",items:((h=n==null?void 0:n.actionServers)==null?void 0:h.map(d=>`${d.name}: ${d.type}`))||[]},{label:"Action Clients",items:[]}];for(const d of r)if(t.writeln(`  ${d.label}:`),d.items.length>0)for(const u of d.items)t.writeln(`    ${u}`)}T.registerRos2("node",Jt);function q(o){if(!o||typeof o!="string")return{};let t=o.trim();if(t.startsWith("{")&&t.endsWith("}")&&(t=t.slice(1,-1)),!t.trim())return{};try{return JSON.parse(`{${t}}`)}catch{return ee(t)}}function ee(o){const t={};let e=0,s="",i="",n=!1,r=!1,a="",l=0;for(;l<o.length;){const c=o[l];if((c==='"'||c==="'")&&!r){r=!0,a=c,n&&(i+=c),l++;continue}if(r&&c===a){r=!1,n&&(i+=c),l++;continue}if(r){n?i+=c:s+=c,l++;continue}if(c==="{"||c==="["){e++,n&&(i+=c),l++;continue}if(c==="}"||c==="]"){e--,n&&(i+=c),l++;continue}if(c===":"&&e===0&&!n){for(n=!0,l++;l<o.length&&o[l]===" ";)l++;continue}if(c===","&&e===0){for(s.trim()&&(t[s.trim()]=G(i.trim())),s="",i="",n=!1,l++;l<o.length&&o[l]===" ";)l++;continue}n?i+=c:s+=c,l++}return s.trim()&&(t[s.trim()]=G(i.trim())),t}function G(o){if(!o)return null;if(o.startsWith("{")&&o.endsWith("}"))return q(o);if(o.startsWith("[")&&o.endsWith("]"))return se(o.slice(1,-1));if(o.startsWith('"')&&o.endsWith('"')||o.startsWith("'")&&o.endsWith("'"))return o.slice(1,-1);if(o==="true")return!0;if(o==="false")return!1;if(o==="null"||o==="~")return null;const t=Number(o);return isNaN(t)?o:t}function se(o){const t=[];let e=0,s="",i=!1,n="";for(let r=0;r<o.length;r++){const a=o[r];if((a==='"'||a==="'")&&!i){i=!0,n=a,s+=a;continue}if(i&&a===n){i=!1,s+=a;continue}if(i){s+=a;continue}if(a==="{"||a==="["){e++,s+=a;continue}if(a==="}"||a==="]"){e--,s+=a;continue}if(a===","&&e===0){s.trim()&&t.push(G(s.trim())),s="";continue}s+=a}return s.trim()&&t.push(G(s.trim())),t}function $(o,t=0){if(o==null)return"null";if(typeof o!="object")return String(o);if(Array.isArray(o))return o.length===0?"[]":`[${o.map(n=>$(n,t)).join(", ")}]`;const e="  ".repeat(t),s=[];for(const[i,n]of Object.entries(o))if(!i.startsWith("_"))if(typeof n=="object"&&n!==null&&!Array.isArray(n))s.push(`${e}${i}:`),s.push($(n,t+1));else{const r=$(n,t);s.push(`${e}${i}: ${r}`)}return s.join(`
`)}class ie{constructor(){this.messages={},this.services={},this.actions={}}registerMessage(t,e){this.messages[t]=e}registerService(t,e){this.services[t]=e}registerAction(t,e){this.actions[t]=e}getMessage(t){return this.messages[t]||null}getService(t){return this.services[t]||null}getAction(t){return this.actions[t]||null}getInterface(t){return this.messages[t]||this.services[t]||this.actions[t]||null}listMessages(){return Object.keys(this.messages)}listServices(){return Object.keys(this.services)}listActions(){return Object.keys(this.actions)}findMessages(t){const e=new RegExp(t,"i");return Object.keys(this.messages).filter(s=>e.test(s))}findServices(t){const e=new RegExp(t,"i");return Object.keys(this.services).filter(s=>e.test(s))}findActions(t){const e=new RegExp(t,"i");return Object.keys(this.actions).filter(s=>e.test(s))}validateMessage(t,e){const s=this.messages[t];if(!s)return{valid:!1,errors:[`Unknown message type: ${t}`]};const i=[];for(const[n,r]of Object.entries(s.fields||{}))e[n]===void 0&&r.default===void 0&&i.push(`Missing required field: ${n}`);return{valid:i.length===0,errors:i}}createMessage(t,e={}){const s=this.messages[t];return!s||!s.create?null:s.create(e)}getDefinition(t){const e=this.getInterface(t);return(e==null?void 0:e.definition)||null}}const y=new ie,oe={name:"std_msgs/msg/Header",fields:{stamp:{type:"builtin_interfaces/msg/Time",default:{sec:0,nanosec:0}},frame_id:{type:"string",default:""}},create:(o={})=>({stamp:o.stamp||{sec:0,nanosec:0},frame_id:o.frame_id||""}),definition:`# Standard metadata for higher-level stamped data types.
builtin_interfaces/Time stamp
string frame_id`},ne={name:"std_msgs/msg/String",fields:{data:{type:"string",default:""}},create:(o={})=>({data:o.data||""}),definition:`# A simple string message.
string data`},re={name:"std_msgs/msg/Bool",fields:{data:{type:"bool",default:!1}},create:(o={})=>({data:o.data||!1}),definition:`# A simple boolean message.
bool data`},ae={name:"std_msgs/msg/Int32",fields:{data:{type:"int32",default:0}},create:(o={})=>({data:o.data||0}),definition:`# A 32-bit signed integer.
int32 data`},le={name:"std_msgs/msg/Int64",fields:{data:{type:"int64",default:0}},create:(o={})=>({data:o.data||0}),definition:`# A 64-bit signed integer.
int64 data`},ce={name:"std_msgs/msg/Float32",fields:{data:{type:"float32",default:0}},create:(o={})=>({data:o.data||0}),definition:`# A 32-bit floating point number.
float32 data`},he={name:"std_msgs/msg/Float64",fields:{data:{type:"float64",default:0}},create:(o={})=>({data:o.data||0}),definition:`# A 64-bit floating point number.
float64 data`},de={name:"std_msgs/msg/Empty",fields:{},create:()=>({}),definition:"# Empty message type."},ue={name:"std_msgs/msg/ColorRGBA",fields:{r:{type:"float32",default:0},g:{type:"float32",default:0},b:{type:"float32",default:0},a:{type:"float32",default:1}},create:(o={})=>({r:o.r??0,g:o.g??0,b:o.b??0,a:o.a??1}),definition:`# RGBA color with float values.
float32 r
float32 g
float32 b
float32 a`};y.registerMessage("std_msgs/msg/Header",oe);y.registerMessage("std_msgs/msg/String",ne);y.registerMessage("std_msgs/msg/Bool",re);y.registerMessage("std_msgs/msg/Int32",ae);y.registerMessage("std_msgs/msg/Int64",le);y.registerMessage("std_msgs/msg/Float32",ce);y.registerMessage("std_msgs/msg/Float64",he);y.registerMessage("std_msgs/msg/Empty",de);y.registerMessage("std_msgs/msg/ColorRGBA",ue);const pe={name:"std_srvs/srv/Empty",type:"service",request:{},response:{},createRequest:()=>({}),createResponse:()=>({}),definition:`# Empty service - no request or response data.
---`};y.registerService("std_srvs/srv/Empty",pe);const H={name:"geometry_msgs/msg/Vector3",fields:{x:{type:"float64",default:0},y:{type:"float64",default:0},z:{type:"float64",default:0}},create:(o={})=>({x:o.x??0,y:o.y??0,z:o.z??0}),definition:`# A 3D vector.
float64 x
float64 y
float64 z`},gt={name:"geometry_msgs/msg/Point",fields:{x:{type:"float64",default:0},y:{type:"float64",default:0},z:{type:"float64",default:0}},create:(o={})=>({x:o.x??0,y:o.y??0,z:o.z??0}),definition:`# A point in 3D space.
float64 x
float64 y
float64 z`},J={name:"geometry_msgs/msg/Quaternion",fields:{x:{type:"float64",default:0},y:{type:"float64",default:0},z:{type:"float64",default:0},w:{type:"float64",default:1}},create:(o={})=>({x:o.x??0,y:o.y??0,z:o.z??0,w:o.w??1}),definition:`# A quaternion representing orientation.
float64 x
float64 y
float64 z
float64 w`},bt={name:"geometry_msgs/msg/Pose",fields:{position:{type:"geometry_msgs/msg/Point"},orientation:{type:"geometry_msgs/msg/Quaternion"}},create:(o={})=>({position:gt.create(o.position),orientation:J.create(o.orientation)}),definition:`# A representation of pose in free space.
Point position
Quaternion orientation`},me={name:"geometry_msgs/msg/PoseStamped",fields:{header:{type:"std_msgs/msg/Header"},pose:{type:"geometry_msgs/msg/Pose"}},create:(o={})=>({header:o.header||{stamp:{sec:0,nanosec:0},frame_id:""},pose:bt.create(o.pose)}),definition:`# A Pose with reference coordinate frame and timestamp.
std_msgs/Header header
Pose pose`},yt={name:"geometry_msgs/msg/Twist",fields:{linear:{type:"geometry_msgs/msg/Vector3"},angular:{type:"geometry_msgs/msg/Vector3"}},create:(o={})=>({linear:H.create(o.linear),angular:H.create(o.angular)}),definition:`# Velocity in free space, broken into linear and angular parts.
Vector3 linear
Vector3 angular`},fe={name:"geometry_msgs/msg/TwistStamped",fields:{header:{type:"std_msgs/msg/Header"},twist:{type:"geometry_msgs/msg/Twist"}},create:(o={})=>({header:o.header||{stamp:{sec:0,nanosec:0},frame_id:""},twist:yt.create(o.twist)}),definition:`# A twist with reference coordinate frame and timestamp.
std_msgs/Header header
Twist twist`},wt={name:"geometry_msgs/msg/Transform",fields:{translation:{type:"geometry_msgs/msg/Vector3"},rotation:{type:"geometry_msgs/msg/Quaternion"}},create:(o={})=>({translation:H.create(o.translation),rotation:J.create(o.rotation)}),definition:`# A transform between two coordinate frames.
Vector3 translation
Quaternion rotation`},_t={name:"geometry_msgs/msg/TransformStamped",fields:{header:{type:"std_msgs/msg/Header"},child_frame_id:{type:"string",default:""},transform:{type:"geometry_msgs/msg/Transform"}},create:(o={})=>({header:o.header||{stamp:{sec:0,nanosec:0},frame_id:""},child_frame_id:o.child_frame_id||"",transform:wt.create(o.transform)}),definition:`# A transform with reference and child coordinate frames.
std_msgs/Header header
string child_frame_id
Transform transform`};y.registerMessage("geometry_msgs/msg/Vector3",H);y.registerMessage("geometry_msgs/msg/Point",gt);y.registerMessage("geometry_msgs/msg/Quaternion",J);y.registerMessage("geometry_msgs/msg/Pose",bt);y.registerMessage("geometry_msgs/msg/PoseStamped",me);y.registerMessage("geometry_msgs/msg/Twist",yt);y.registerMessage("geometry_msgs/msg/TwistStamped",fe);y.registerMessage("geometry_msgs/msg/Transform",wt);y.registerMessage("geometry_msgs/msg/TransformStamped",_t);const ge={name:"turtlesim/msg/Pose",fields:{x:{type:"float32",default:0},y:{type:"float32",default:0},theta:{type:"float32",default:0},linear_velocity:{type:"float32",default:0},angular_velocity:{type:"float32",default:0}},create:(o={})=>({x:o.x??0,y:o.y??0,theta:o.theta??0,linear_velocity:o.linear_velocity??0,angular_velocity:o.angular_velocity??0}),definition:`# Pose of a turtle in turtlesim.
float32 x
float32 y
float32 theta

float32 linear_velocity
float32 angular_velocity`},be={name:"turtlesim/msg/Color",fields:{r:{type:"uint8",default:0},g:{type:"uint8",default:0},b:{type:"uint8",default:0}},create:(o={})=>({r:o.r??0,g:o.g??0,b:o.b??0}),definition:`# RGB color values.
uint8 r
uint8 g
uint8 b`};y.registerMessage("turtlesim/msg/Pose",ge);y.registerMessage("turtlesim/msg/Color",be);const ye={name:"turtlesim/srv/Spawn",type:"service",request:{x:{type:"float32",default:0},y:{type:"float32",default:0},theta:{type:"float32",default:0},name:{type:"string",default:""}},response:{name:{type:"string"}},createRequest:(o={})=>({x:o.x??5.544445,y:o.y??5.544445,theta:o.theta??0,name:o.name||""}),createResponse:(o={})=>({name:o.name||""}),definition:`# Spawn a new turtle.
float32 x
float32 y
float32 theta
string name
---
string name`},we={name:"turtlesim/srv/Kill",type:"service",request:{name:{type:"string",default:""}},response:{},createRequest:(o={})=>({name:o.name||""}),createResponse:()=>({}),definition:`# Kill a turtle by name.
string name
---`},_e={name:"turtlesim/srv/SetPen",type:"service",request:{r:{type:"uint8",default:0},g:{type:"uint8",default:0},b:{type:"uint8",default:0},width:{type:"uint8",default:1},off:{type:"uint8",default:0}},response:{},createRequest:(o={})=>({r:o.r??255,g:o.g??255,b:o.b??255,width:o.width??3,off:o.off??0}),createResponse:()=>({}),definition:`# Set the pen parameters.
uint8 r
uint8 g
uint8 b
uint8 width
uint8 off
---`},ve={name:"turtlesim/srv/TeleportAbsolute",type:"service",request:{x:{type:"float32",default:0},y:{type:"float32",default:0},theta:{type:"float32",default:0}},response:{},createRequest:(o={})=>({x:o.x??0,y:o.y??0,theta:o.theta??0}),createResponse:()=>({}),definition:`# Teleport the turtle to an absolute position.
float32 x
float32 y
float32 theta
---`},xe={name:"turtlesim/srv/TeleportRelative",type:"service",request:{linear:{type:"float32",default:0},angular:{type:"float32",default:0}},response:{},createRequest:(o={})=>({linear:o.linear??0,angular:o.angular??0}),createResponse:()=>({}),definition:`# Teleport the turtle relative to its current position.
float32 linear
float32 angular
---`};y.registerService("turtlesim/srv/Spawn",ye);y.registerService("turtlesim/srv/Kill",we);y.registerService("turtlesim/srv/SetPen",_e);y.registerService("turtlesim/srv/TeleportAbsolute",ve);y.registerService("turtlesim/srv/TeleportRelative",xe);const Te={name:"turtlesim/action/RotateAbsolute",type:"action",goal:{theta:{type:"float32",default:0}},result:{delta:{type:"float32"}},feedback:{remaining:{type:"float32"}},createGoal:(o={})=>({theta:o.theta??0}),createResult:(o={})=>({delta:o.delta??0}),createFeedback:(o={})=>({remaining:o.remaining??0}),definition:`# Rotate the turtle to an absolute orientation.
# Goal
float32 theta
---
# Result
float32 delta
---
# Feedback
float32 remaining`};y.registerAction("turtlesim/action/RotateAbsolute",Te);const Se={name:"tf2_msgs/msg/TFMessage",fields:{transforms:{type:"geometry_msgs/msg/TransformStamped[]",default:[]}},create:(o={})=>({transforms:(o.transforms||[]).map(t=>_t.create(t))}),definition:`# TF2 transform message.
geometry_msgs/TransformStamped[] transforms`};y.registerMessage("tf2_msgs/msg/TFMessage",Se);const Ie={name:"sensor_msgs/msg/LaserScan",fields:{header:{type:"std_msgs/msg/Header"},angle_min:{type:"float32",default:0},angle_max:{type:"float32",default:0},angle_increment:{type:"float32",default:0},time_increment:{type:"float32",default:0},scan_time:{type:"float32",default:0},range_min:{type:"float32",default:0},range_max:{type:"float32",default:0},ranges:{type:"float32[]",default:[]},intensities:{type:"float32[]",default:[]}},create:(o={})=>({header:o.header||{stamp:{sec:0,nanosec:0},frame_id:"laser"},angle_min:o.angle_min??-Math.PI,angle_max:o.angle_max??Math.PI,angle_increment:o.angle_increment??Math.PI/180,time_increment:o.time_increment??0,scan_time:o.scan_time??.1,range_min:o.range_min??.1,range_max:o.range_max??10,ranges:o.ranges||[],intensities:o.intensities||[]}),definition:`# Single scan from a planar laser range-finder.
std_msgs/Header header

float32 angle_min        # start angle of the scan [rad]
float32 angle_max        # end angle of the scan [rad]
float32 angle_increment  # angular distance between measurements [rad]

float32 time_increment   # time between measurements [seconds]
float32 scan_time        # time between scans [seconds]

float32 range_min        # minimum range value [m]
float32 range_max        # maximum range value [m]

float32[] ranges         # range data [m]
float32[] intensities    # intensity data [device-specific units]`},Ce={name:"sensor_msgs/msg/Imu",fields:{header:{type:"std_msgs/msg/Header"},orientation:{type:"geometry_msgs/msg/Quaternion"},orientation_covariance:{type:"float64[9]",default:new Array(9).fill(0)},angular_velocity:{type:"geometry_msgs/msg/Vector3"},angular_velocity_covariance:{type:"float64[9]",default:new Array(9).fill(0)},linear_acceleration:{type:"geometry_msgs/msg/Vector3"},linear_acceleration_covariance:{type:"float64[9]",default:new Array(9).fill(0)}},create:(o={})=>({header:o.header||{stamp:{sec:0,nanosec:0},frame_id:"imu"},orientation:o.orientation||{x:0,y:0,z:0,w:1},orientation_covariance:o.orientation_covariance||new Array(9).fill(0),angular_velocity:o.angular_velocity||{x:0,y:0,z:0},angular_velocity_covariance:o.angular_velocity_covariance||new Array(9).fill(0),linear_acceleration:o.linear_acceleration||{x:0,y:0,z:0},linear_acceleration_covariance:o.linear_acceleration_covariance||new Array(9).fill(0)}),definition:`# IMU sensor data.
std_msgs/Header header

geometry_msgs/Quaternion orientation
float64[9] orientation_covariance

geometry_msgs/Vector3 angular_velocity
float64[9] angular_velocity_covariance

geometry_msgs/Vector3 linear_acceleration
float64[9] linear_acceleration_covariance`};y.registerMessage("sensor_msgs/msg/LaserScan",Ie);y.registerMessage("sensor_msgs/msg/Imu",Ce);const vt={name:"nav_msgs/msg/MapMetaData",fields:{map_load_time:{type:"builtin_interfaces/msg/Time",default:{sec:0,nanosec:0}},resolution:{type:"float32",default:.05},width:{type:"uint32",default:0},height:{type:"uint32",default:0},origin:{type:"geometry_msgs/msg/Pose"}},create:(o={})=>({map_load_time:o.map_load_time||{sec:0,nanosec:0},resolution:o.resolution??.05,width:o.width??0,height:o.height??0,origin:o.origin||{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:1}}}),definition:`# Metadata about a map.
builtin_interfaces/Time map_load_time
float32 resolution
uint32 width
uint32 height
geometry_msgs/Pose origin`},ke={name:"nav_msgs/msg/OccupancyGrid",fields:{header:{type:"std_msgs/msg/Header"},info:{type:"nav_msgs/msg/MapMetaData"},data:{type:"int8[]",default:[]}},create:(o={})=>({header:o.header||{stamp:{sec:0,nanosec:0},frame_id:"map"},info:vt.create(o.info),data:o.data||[]}),definition:`# 2D occupancy grid map.
# Values: -1 = unknown, 0 = free, 100 = occupied
std_msgs/Header header
MapMetaData info
int8[] data`},Pe={name:"nav_msgs/msg/Odometry",fields:{header:{type:"std_msgs/msg/Header"},child_frame_id:{type:"string",default:""},pose:{type:"geometry_msgs/msg/PoseWithCovariance"},twist:{type:"geometry_msgs/msg/TwistWithCovariance"}},create:(o={})=>({header:o.header||{stamp:{sec:0,nanosec:0},frame_id:"odom"},child_frame_id:o.child_frame_id||"base_link",pose:o.pose||{pose:{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:1}},covariance:new Array(36).fill(0)},twist:o.twist||{twist:{linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:0}},covariance:new Array(36).fill(0)}}),definition:`# Robot odometry.
std_msgs/Header header
string child_frame_id
geometry_msgs/PoseWithCovariance pose
geometry_msgs/TwistWithCovariance twist`},Me={name:"nav_msgs/msg/Path",fields:{header:{type:"std_msgs/msg/Header"},poses:{type:"geometry_msgs/msg/PoseStamped[]",default:[]}},create:(o={})=>({header:o.header||{stamp:{sec:0,nanosec:0},frame_id:"map"},poses:o.poses||[]}),definition:`# A path represented as a series of poses.
std_msgs/Header header
geometry_msgs/PoseStamped[] poses`};y.registerMessage("nav_msgs/msg/MapMetaData",vt);y.registerMessage("nav_msgs/msg/OccupancyGrid",ke);y.registerMessage("nav_msgs/msg/Odometry",Pe);y.registerMessage("nav_msgs/msg/Path",Me);const Ee={name:"nav2_msgs/action/NavigateToPose",type:"action",goal:{pose:{type:"geometry_msgs/msg/PoseStamped"}},result:{},feedback:{current_pose:{type:"geometry_msgs/msg/PoseStamped"},distance_remaining:{type:"float32",default:0}},createGoal:(o={})=>{var t,e,s,i,n,r,a,l,c,h,d,u,p,g,m,f;return{pose:{header:((t=o.pose)==null?void 0:t.header)||{stamp:{sec:0,nanosec:0},frame_id:"map"},pose:{position:{x:((i=(s=(e=o.pose)==null?void 0:e.pose)==null?void 0:s.position)==null?void 0:i.x)??((r=(n=o.pose)==null?void 0:n.position)==null?void 0:r.x)??0,y:((c=(l=(a=o.pose)==null?void 0:a.pose)==null?void 0:l.position)==null?void 0:c.y)??((d=(h=o.pose)==null?void 0:h.position)==null?void 0:d.y)??0,z:((g=(p=(u=o.pose)==null?void 0:u.pose)==null?void 0:p.position)==null?void 0:g.z)??((f=(m=o.pose)==null?void 0:m.position)==null?void 0:f.z)??0},orientation:{x:0,y:0,z:0,w:1}}}}},createResult:()=>({}),createFeedback:(o={})=>{var t,e,s,i,n,r;return{current_pose:{header:{stamp:{sec:0,nanosec:0},frame_id:"map"},pose:{position:{x:((s=(e=(t=o.current_pose)==null?void 0:t.pose)==null?void 0:e.position)==null?void 0:s.x)??0,y:((r=(n=(i=o.current_pose)==null?void 0:i.pose)==null?void 0:n.position)==null?void 0:r.y)??0,z:0},orientation:{x:0,y:0,z:0,w:1}}},distance_remaining:o.distance_remaining??0}},definition:`# Navigate to a pose.
# Goal
geometry_msgs/PoseStamped pose
---
# Result (empty - status conveyed by action state)
---
# Feedback
geometry_msgs/PoseStamped current_pose
float32 distance_remaining`};y.registerAction("nav2_msgs/action/NavigateToPose",Ee);const Le={name:"nav2_msgs/action/FollowWaypoints",type:"action",goal:{poses:{type:"geometry_msgs/msg/PoseStamped[]"}},result:{missed_waypoint_indices:{type:"int32[]",default:[]}},feedback:{current_waypoint:{type:"int32",default:0},number_of_poses:{type:"int32",default:0},distance_remaining:{type:"float32",default:0}},createGoal:(o={})=>({poses:(o.poses||[]).map(t=>{var e,s,i,n,r,a,l,c,h;return{header:t.header||{stamp:{sec:0,nanosec:0},frame_id:"map"},pose:{position:{x:((s=(e=t.pose)==null?void 0:e.position)==null?void 0:s.x)??((i=t.position)==null?void 0:i.x)??0,y:((r=(n=t.pose)==null?void 0:n.position)==null?void 0:r.y)??((a=t.position)==null?void 0:a.y)??0,z:((c=(l=t.pose)==null?void 0:l.position)==null?void 0:c.z)??((h=t.position)==null?void 0:h.z)??0},orientation:{x:0,y:0,z:0,w:1}}}})}),createResult:(o={})=>({missed_waypoint_indices:o.missed_waypoint_indices||[]}),createFeedback:(o={})=>({current_waypoint:o.current_waypoint??0,number_of_poses:o.number_of_poses??0,distance_remaining:o.distance_remaining??0}),definition:`# Follow a sequence of waypoints.
# Goal
geometry_msgs/PoseStamped[] poses
---
# Result
int32[] missed_waypoint_indices
---
# Feedback
int32 current_waypoint
int32 number_of_poses
float32 distance_remaining`};y.registerAction("nav2_msgs/action/FollowWaypoints",Le);function Ae(o){return y.getMessage(o)}function $e(o){return y.getService(o)}function Re(o){return y.getAction(o)}function xt(){return y.listMessages()}function Tt(){return y.listServices()}function St(){return y.listActions()}function De(o){return y.findMessages(o)}function Oe(o){return y.findServices(o)}function Ne(o){return y.findActions(o)}function ze(o){return y.getDefinition(o)}async function Fe(o,t){if(o.length===0){rt(t),t.finishCommand();return}const e=o[0],s=o.slice(1);switch(e){case"list":Be(s,t),t.finishCommand();break;case"info":We(s,t),t.finishCommand();break;case"type":Ge(s,t),t.finishCommand();break;case"find":He(s,t),t.finishCommand();break;case"echo":qe(s,t);break;case"pub":await Ue(s,t);break;case"hz":Ve(s,t);break;case"bw":Ye(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),rt(t),t.finishCommand()}}function rt(o){o.writeln("usage: ros2 topic <command> [options]"),o.writeln(""),o.writeln("Commands:"),o.writeln("  list    List all active topics"),o.writeln("  info    Show information about a topic"),o.writeln("  type    Show the type of a topic"),o.writeln("  find    Find topics by type"),o.writeln("  echo    Subscribe and print messages"),o.writeln("  pub     Publish a message to a topic"),o.writeln("  hz      Show message rate for a topic"),o.writeln("  bw      Show bandwidth for a topic")}function Be(o,t){const e=o.includes("-t")||o.includes("--show-types"),s=w.getTopics();if(s.length===0){t.writeln("No topics are currently active.");return}for(const i of s.sort((n,r)=>n.name.localeCompare(r.name)))e?t.writeln(`${i.name} [${i.type}]`):t.writeln(i.name)}function We(o,t){const e=o.includes("--verbose")||o.includes("-v"),s=o.find(n=>!n.startsWith("-"));if(!s){t.writeln("usage: ros2 topic info <topic_name> [--verbose]");return}const i=w.getTopicInfo(s);if(!i){t.writeln(`\x1B[31mTopic '${s}' not found\x1B[0m`);return}if(t.writeln(`Type: ${i.type}`),t.writeln(`Publisher count: ${i.publishers.length}`),t.writeln(`Subscription count: ${i.subscribers.length}`),e){t.writeln(""),t.writeln("Publishers:");for(const n of i.publishers){t.writeln(`  Node: ${n.nodeId}`);for(const r of it(n.qos,"    "))t.writeln(r)}t.writeln(""),t.writeln("Subscribers:");for(const n of i.subscribers){t.writeln(`  Node: ${n.nodeId||"(anonymous)"}`);for(const r of it(n.qos,"    "))t.writeln(r)}}}function Ge(o,t){if(o.length===0){t.writeln("usage: ros2 topic type <topic_name>");return}const e=o[0],s=w.getTopicInfo(e);if(!s){t.writeln(`\x1B[31mTopic '${e}' not found\x1B[0m`);return}t.writeln(s.type)}function He(o,t){if(o.length===0){t.writeln("usage: ros2 topic find <msg_type>");return}const e=o[0],i=w.getTopics().filter(n=>n.type===e);if(i.length===0){t.writeln(`No topics of type '${e}' found.`);return}for(const n of i)t.writeln(n.name)}function qe(o,t){if(o.length===0){t.writeln("usage: ros2 topic echo <topic_name> [--qos-*]"),t.finishCommand();return}const{qos:e,remaining:s,error:i}=ft(o);if(i){t.writeln(`\x1B[31m${i}\x1B[0m`),t.finishCommand();return}const n=s[0];if(!n){t.writeln("usage: ros2 topic echo <topic_name> [--qos-*]"),t.finishCommand();return}let r=w.getTopicInfo(n),a=null,l=null;const c=h=>{a&&w.unsubscribe(a),a=w.subscribe(n,h,d=>{t.writeln("---"),t.writeln($(d))},e)};r?c(r.type):(t.writeln(`\x1B[33mTopic '${n}' does not exist yet.\x1B[0m`),t.writeln("\x1B[33mWill start echoing when a publisher creates it...\x1B[0m"),l=setInterval(()=>{const h=w.getTopicInfo(n);h&&h.type!=="unknown"&&(t.writeln(`\x1B[32mTopic '${n}' is now available [${h.type}]\x1B[0m`),clearInterval(l),l=null,c(h.type))},1e3),c("unknown")),t.addSubscription({destroy:()=>{l&&clearInterval(l),a&&w.unsubscribe(a)}})}async function Ue(o,t){const{qos:e,remaining:s,error:i}=ft(o);if(i){t.writeln(`\x1B[31m${i}\x1B[0m`),t.finishCommand();return}let n=!1,r=1,a=null,l=null,c=null;for(let f=0;f<s.length;f++){const _=s[f];_==="--once"||_==="-1"?n=!0:_==="-r"||_==="--rate"?r=parseFloat(s[++f])||1:_==="-w"||_==="--wait"?parseInt(s[++f]):a?l?c||(c=_):l=_:a=_}if(!a||!l){t.writeln('usage: ros2 topic pub [--once] [-r RATE] <topic> <msg_type> "<data>" [--qos-*]'),t.finishCommand();return}const h=Ae(l);if(!h){t.writeln(`\x1B[31mUnknown message type: ${l}\x1B[0m`),t.writeln(""),t.writeln("Available message types matching this pattern:");const f=De(l.split("/").pop());for(const _ of f.slice(0,10))t.writeln(`  ${_}`);t.finishCommand();return}const d=c?q(c):{},u=h.create(d),p=w.comm.advertise(a,l,"/_cli_pub",e);if(t.writeln("publisher: beginning loop"),t.writeln(`publishing #1: ${JSON.stringify(u)}`),w.publish(a,l,u),n){w.comm.unadvertise(p),t.finishCommand();return}let g=1;const m=setInterval(()=>{g++,t.writeln(`publishing #${g}: ${JSON.stringify(u)}`),w.publish(a,l,u)},1e3/r);t.addSubscription({destroy:()=>{clearInterval(m),w.comm.unadvertise(p)}})}function Ve(o,t){if(o.length===0){t.writeln("usage: ros2 topic hz <topic_name>"),t.finishCommand();return}const e=o[0],s=w.getTopicInfo(e);s||t.writeln(`\x1B[33mWaiting for topic '${e}'...\x1B[0m`);const i=[],n=100,r=w.subscribe(e,(s==null?void 0:s.type)||"unknown",()=>{const a=Date.now();for(i.push(a);i.length>n;)i.shift();if(i.length>=2){const l=Math.max((i[i.length-1]-i[0])/1e3,.001),c=(i.length-1)/l,h=l/(i.length-1);t.writeln(`average rate: ${c.toFixed(3)}`),t.writeln(`  min: ${(h*.9).toFixed(3)}s max: ${(h*1.1).toFixed(3)}s std dev: ${(h*.05).toFixed(5)}s window: ${i.length}`)}});t.addSubscription({destroy:()=>w.unsubscribe(r)})}function W(o){return o>=1e6?`${(o/1e6).toFixed(2)} MB`:o>=1e3?`${(o/1e3).toFixed(2)} KB`:`${Math.round(o)} B`}function Ye(o,t){if(o.length===0){t.writeln("usage: ros2 topic bw <topic_name>"),t.finishCommand();return}const e=o[0],s=w.getTopicInfo(e);s||t.writeln(`\x1B[33mWaiting for topic '${e}'...\x1B[0m`);const i=[],n=100;let r=!1;const a=w.subscribe(e,(s==null?void 0:s.type)||"unknown",l=>{const c=Date.now(),h=JSON.stringify(l).length;for(i.push({time:c,size:h});i.length>n;)i.shift();if(r||(t.writeln(`Subscribed to [${e}]`),r=!0),i.length>=2){const d=Math.max((i[i.length-1].time-i[0].time)/1e3,.001),u=i.reduce((_,x)=>_+x.size,0),p=u/d,g=u/i.length,m=Math.min(...i.map(_=>_.size)),f=Math.max(...i.map(_=>_.size));t.writeln(`${W(p)}/s from ${i.length} messages`),t.writeln(`  Message size mean: ${W(g)} min: ${W(m)} max: ${W(f)}`)}});t.addSubscription({destroy:()=>w.unsubscribe(a)})}T.registerRos2("topic",Fe);async function Xe(o,t){if(o.length===0){at(t),t.finishCommand();return}const e=o[0],s=o.slice(1);switch(e){case"list":Qe(s,t),t.finishCommand();break;case"type":Ke(s,t),t.finishCommand();break;case"info":je(s,t),t.finishCommand();break;case"find":Je(s,t),t.finishCommand();break;case"call":await Ze(s,t),t.finishCommand();break;case"echo":ts(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),at(t),t.finishCommand()}}function at(o){o.writeln("usage: ros2 service <command> [options]"),o.writeln(""),o.writeln("Commands:"),o.writeln("  list    List all active services"),o.writeln("  type    Show the type of a service"),o.writeln("  info    Show information about a service"),o.writeln("  find    Find services by type"),o.writeln("  call    Call a service"),o.writeln("  echo    Echo service calls")}function Qe(o,t){const e=o.includes("-t")||o.includes("--show-types"),s=w.getServices();if(s.length===0){t.writeln("No services are currently available.");return}for(const i of s.sort((n,r)=>n.name.localeCompare(r.name)))e?t.writeln(`${i.name} [${i.type}]`):t.writeln(i.name)}function Ke(o,t){if(o.length===0){t.writeln("usage: ros2 service type <service_name>");return}const e=o[0],s=w.getServiceInfo(e);if(!s){t.writeln(`\x1B[31mService '${e}' not found\x1B[0m`);return}t.writeln(s.type)}function je(o,t){if(o.length===0){t.writeln("usage: ros2 service info <service_name>");return}const e=o[0],s=w.getServiceInfo(e);if(!s){t.writeln(`\x1B[31mService '${e}' not found\x1B[0m`);return}t.writeln(`Type: ${s.type}`),t.writeln(`Node: ${s.node}`)}function Je(o,t){if(o.length===0){t.writeln("usage: ros2 service find <srv_type>");return}const e=o[0],i=w.getServices().filter(n=>n.type===e);if(i.length===0){t.writeln(`No services of type '${e}' found.`);return}for(const n of i)t.writeln(n.name)}async function Ze(o,t){let e=null,s=null,i=null;for(let c=0;c<o.length;c++){const h=o[c];e?s?i||(i=h):s=h:e=h}if(!e||!s){t.writeln('usage: ros2 service call <service_name> <srv_type> "<request_data>"');return}const n=$e(s);if(!n){t.writeln(`\x1B[31mUnknown service type: ${s}\x1B[0m`),t.writeln(""),t.writeln("Available service types:");const c=Oe(s.split("/").pop());for(const h of c.slice(0,10))t.writeln(`  ${h}`);return}if(!w.getServiceInfo(e)){t.writeln(`\x1B[31mService '${e}' not available\x1B[0m`);return}const a=i?q(i):{},l=n.createRequest(a);t.writeln(`requester: making request: ${e}`),t.writeln("");try{const c=await w.callService(e,s,l);t.writeln("response:"),t.writeln($(c))}catch(c){t.writeln(`\x1B[31mService call failed: ${c.message}\x1B[0m`)}}function ts(o,t){t.writeln("\x1B[33mService echo is not fully supported in this simulation.\x1B[0m"),t.finishCommand()}T.registerRos2("service",Xe);async function es(o,t){if(o.length===0){lt(t),t.finishCommand();return}const e=o[0],s=o.slice(1);switch(e){case"list":ss(s,t),t.finishCommand();break;case"type":is(s,t),t.finishCommand();break;case"info":os(s,t),t.finishCommand();break;case"send_goal":await ns(s,t),t.finishCommand();break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),lt(t),t.finishCommand()}}function lt(o){o.writeln("usage: ros2 action <command> [options]"),o.writeln(""),o.writeln("Commands:"),o.writeln("  list       List all action servers"),o.writeln("  type       Show the type of an action"),o.writeln("  info       Show information about an action"),o.writeln("  send_goal  Send a goal to an action server")}function ss(o,t){const e=o.includes("-t")||o.includes("--show-types"),s=w.getActions();if(s.length===0){t.writeln("No action servers are currently available.");return}for(const i of s.sort((n,r)=>n.name.localeCompare(r.name)))e?t.writeln(`${i.name} [${i.type}]`):t.writeln(i.name)}function is(o,t){if(o.length===0){t.writeln("usage: ros2 action type <action_name>");return}const e=o[0],s=w.getActionInfo(e);if(!s){t.writeln(`\x1B[31mAction '${e}' not found\x1B[0m`);return}t.writeln(s.type)}function os(o,t){if(o.length===0){t.writeln("usage: ros2 action info <action_name>");return}const e=o[0],s=w.getActionInfo(e);if(!s){t.writeln(`\x1B[31mAction '${e}' not found\x1B[0m`);return}t.writeln(`Action: ${e}`),t.writeln("Action clients: 0"),t.writeln("Action servers: 1"),t.writeln(`    ${s.node}`)}async function ns(o,t){let e=null,s=null,i=null,n=!1;for(let h=0;h<o.length;h++){const d=o[h];d==="--feedback"||d==="-f"?n=!0:e?s?i||(i=d):s=d:e=d}if(!e||!s){t.writeln('usage: ros2 action send_goal <action_name> <action_type> "<goal>" [--feedback]');return}const r=Re(s);if(!r){t.writeln(`\x1B[31mUnknown action type: ${s}\x1B[0m`),t.writeln(""),t.writeln("Available action types:");const h=Ne(s.split("/").pop());for(const d of h.slice(0,10))t.writeln(`  ${d}`);return}if(!w.getActionInfo(e)){t.writeln(`\x1B[31mAction '${e}' not available\x1B[0m`);return}const l=i?q(i):{},c=r.createGoal(l);t.writeln("Waiting for an action server to become available..."),t.writeln("Sending goal:"),t.writeln($(c)),t.writeln("");try{let h=null;n&&(h=u=>{t.writeln("Feedback:"),t.writeln($(u)),t.writeln("")}),t.writeln("Goal accepted with ID: goal_1"),t.writeln("");const d=await w.sendActionGoal(e,s,c,h);t.writeln("Result:"),t.writeln($(d)),t.writeln(""),t.writeln("Goal finished with status: SUCCEEDED")}catch(h){t.writeln(`\x1B[31mAction failed: ${h.message}\x1B[0m`)}}T.registerRos2("action",es);async function rs(o,t){if(o.length===0){ct(t),t.finishCommand();return}const e=o[0],s=o.slice(1);switch(e){case"list":as(s,t);break;case"get":ls(s,t);break;case"set":cs(s,t);break;case"dump":hs(s,t);break;case"load":ds(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),ct(t)}t.finishCommand()}function ct(o){o.writeln("usage: ros2 param <command> [options]"),o.writeln(""),o.writeln("Commands:"),o.writeln("  list    List all parameters"),o.writeln("  get     Get a parameter value"),o.writeln("  set     Set a parameter value"),o.writeln("  dump    Dump all parameters for a node"),o.writeln("  load    Load parameters from a file (not supported in sim)")}function U(o){return o?o.startsWith("/")?o:"/"+o:null}function B(o){return k.getProcessByNodeName(o)}function as(o,t){const e=o.length>0?U(o[0]):null;if(e){const s=B(e);if(!s){t.writeln(`\x1B[31mNode '${e}' not found\x1B[0m`);return}const i=s.node.getParameterNames();if(i.length===0){t.writeln("No parameters.");return}t.writeln(`${e}:`);for(const n of i.sort())t.writeln(`  ${n}`)}else{const s=w.getNodes();for(const i of s.sort()){const n=B(i);if(n&&n.node){const r=n.node.getParameterNames();if(r.length>0){t.writeln(`${i}:`);for(const a of r.sort())t.writeln(`  ${a}`)}}}}}function ls(o,t){if(o.length<2){t.writeln("usage: ros2 param get <node_name> <parameter_name>");return}const e=U(o[0]),s=o[1],i=B(e);if(!i){t.writeln(`\x1B[31mNode '${e}' not found\x1B[0m`);return}const n=i.node.getParameter(s);if(n===void 0){t.writeln(`\x1B[31mParameter '${s}' not found on node '${e}'\x1B[0m`);return}t.writeln(`${us(n)} ${V(n)}`)}function cs(o,t){if(o.length<3){t.writeln("usage: ros2 param set <node_name> <parameter_name> <value>");return}const e=U(o[0]),s=o[1],i=o.slice(2).join(" "),n=B(e);if(!n){t.writeln(`\x1B[31mNode '${e}' not found\x1B[0m`);return}const r=ps(i),a=n.node.setParameters({[s]:r});if(!a.successful){t.writeln(`\x1B[31m${a.reason}\x1B[0m`);return}t.writeln(`Set parameter '${s}' to: ${V(r)}`)}function hs(o,t){if(o.length<1){t.writeln("usage: ros2 param dump <node_name>");return}const e=U(o[0]),s=B(e);if(!s){t.writeln(`\x1B[31mNode '${e}' not found\x1B[0m`);return}const i=s.node.getParameterNames();if(i.length===0){t.writeln("No parameters.");return}t.writeln(`${e}:`),t.writeln("  ros__parameters:");for(const n of i.sort()){const r=s.node.getParameter(n);t.writeln(`    ${n}: ${V(r)}`)}}function ds(o,t){t.writeln("\x1B[33mParameter file loading is not supported in this simulation.\x1B[0m"),t.writeln("Use ros2 param set to set individual parameters.")}function us(o){if(typeof o=="boolean")return"Boolean value is:";if(typeof o=="number")return Number.isInteger(o)?"Integer value is:":"Double value is:";if(typeof o=="string")return"String value is:";if(Array.isArray(o)){if(o.length===0)return"String values are:";const t=o[0];return typeof t=="boolean"?"Boolean values are:":typeof t=="number"?Number.isInteger(t)?"Integer values are:":"Double values are:":"String values are:"}return"String value is:"}function ps(o){if(o==="true")return!0;if(o==="false")return!1;const t=Number(o);return isNaN(t)?o.startsWith('"')&&o.endsWith('"')||o.startsWith("'")&&o.endsWith("'")?o.slice(1,-1):o:t}function V(o){return typeof o=="string"?`"${o}"`:typeof o=="boolean"?o?"true":"false":typeof o=="number"?Number.isInteger(o)?o.toString():o.toFixed(6):Array.isArray(o)?`[${o.map(V).join(", ")}]`:String(o)}T.registerRos2("param",rs);class O{constructor(t,e=[]){this.name=t,this.topics=e,this.messages=[],this.subscriptions=[],this.recording=!1,this.startTime=null,this.endTime=null}start(){if(!this.recording){this.recording=!0,this.startTime=Date.now(),this.messages=[];for(const t of this.topics){const e=w.getTopicInfo(t);if(e){const s=w.subscribe(t,e.type,i=>{this.recording&&this.messages.push({topic:t,type:e.type,timestamp:Date.now()-this.startTime,message:{...i}})});this.subscriptions.push(s)}}}}stop(){if(this.recording){this.recording=!1,this.endTime=Date.now();for(const t of this.subscriptions)w.unsubscribe(t);this.subscriptions=[]}}getInfo(){const t={};for(const e of this.messages)t[e.topic]=(t[e.topic]||0)+1;return{name:this.name,duration:this.endTime?(this.endTime-this.startTime)/1e3:null,startTime:this.startTime,endTime:this.endTime,messageCount:this.messages.length,topics:this.topics,topicCounts:t}}getMessages(){return this.messages}toJSON(){return{name:this.name,startTime:this.startTime,endTime:this.endTime,topics:this.topics,messages:this.messages}}static fromJSON(t){const e=new O(t.name,t.topics);return e.startTime=t.startTime,e.endTime=t.endTime,e.messages=t.messages,e}saveToStorage(){try{const t=`ros2bag_${this.name}`;return localStorage.setItem(t,JSON.stringify(this.toJSON())),!0}catch(t){return console.error("Failed to save bag to localStorage:",t),!1}}static loadFromStorage(t){try{const e=`ros2bag_${t}`,s=localStorage.getItem(e);if(s)return O.fromJSON(JSON.parse(s))}catch(e){console.error("Failed to load bag from localStorage:",e)}return null}static listStoredBags(){const t=[];for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e);s.startsWith("ros2bag_")&&t.push(s.substring(8))}return t}static deleteFromStorage(t){const e=`ros2bag_${t}`;localStorage.removeItem(e)}}class ms{constructor(){this.bags=new Map}store(t){this.bags.set(t.name,t)}get(t){return this.bags.has(t)?this.bags.get(t):O.loadFromStorage(t)}list(){const t=Array.from(this.bags.keys()),e=O.listStoredBags();return[...new Set([...t,...e])]}delete(t){this.bags.delete(t),O.deleteFromStorage(t)}}const N=new ms;class fs{constructor(t){this.recorder=t,this.messages=t.getMessages(),this.playing=!1,this.paused=!1,this.rate=1,this.currentIndex=0,this.playStartTime=null,this.pauseTime=null,this.timeouts=[],this.onComplete=null,this.onMessage=null,this.playbackId=0}play(t=1){this.playing||(this.rate=t,this.playing=!0,this.paused=!1,this.currentIndex=0,this.playStartTime=Date.now(),this.playbackId++,this._scheduleMessages())}_scheduleMessages(){this._clearTimeouts();const t=this.playbackId;for(let e=this.currentIndex;e<this.messages.length;e++){const s=this.messages[e],i=s.timestamp/this.rate,n=setTimeout(()=>{t===this.playbackId&&this.playing&&!this.paused&&(this._publishMessage(s),this.currentIndex=e+1,this.currentIndex>=this.messages.length&&(this.stop(),this.onComplete&&this.onComplete()))},i);this.timeouts.push(n)}}_publishMessage(t){w.publish(t.topic,t.type,t.message),this.onMessage&&this.onMessage(t)}_clearTimeouts(){for(const t of this.timeouts)clearTimeout(t);this.timeouts=[]}pause(){!this.playing||this.paused||(this.paused=!0,this.pauseTime=Date.now(),this._clearTimeouts())}resume(){if(!this.playing||!this.paused)return;this.paused=!1;const t=Date.now()-this.pauseTime;this.playStartTime+=t,this._scheduleRemainingMessages()}_scheduleRemainingMessages(){const t=(Date.now()-this.playStartTime)*this.rate,e=this.playbackId;for(let s=this.currentIndex;s<this.messages.length;s++){const i=this.messages[s],n=Math.max(0,(i.timestamp-t)/this.rate),r=setTimeout(()=>{e===this.playbackId&&this.playing&&!this.paused&&(this._publishMessage(i),this.currentIndex=s+1,this.currentIndex>=this.messages.length&&(this.stop(),this.onComplete&&this.onComplete()))},n);this.timeouts.push(r)}}stop(){this._clearTimeouts(),this.playbackId++,this.playing=!1,this.paused=!1}setRate(t){this.playing&&!this.paused?(this._clearTimeouts(),this.playbackId++,this.paused=!0,this.pauseTime=Date.now(),this.rate=t,this.resume()):this.rate=t}getStatus(){return{playing:this.playing,paused:this.paused,rate:this.rate,progress:this.currentIndex/this.messages.length,currentIndex:this.currentIndex,totalMessages:this.messages.length}}}async function gs(o,t){if(o.length===0){ht(t),t.finishCommand();return}const e=o[0],s=o.slice(1);switch(e){case"record":bs(s,t);break;case"play":await ys(s,t),t.finishCommand();break;case"info":ws(s,t),t.finishCommand();break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),ht(t),t.finishCommand()}}function ht(o){o.writeln("usage: ros2 bag <command> [options]"),o.writeln(""),o.writeln("Commands:"),o.writeln("  record  Record topics to a bag"),o.writeln("  play    Play back a recorded bag"),o.writeln("  info    Show information about a bag")}function bs(o,t){let e=!1,s=`rosbag2_${Date.now()}`;const i=[];for(let a=0;a<o.length;a++){const l=o[a];l==="-a"||l==="--all"?e=!0:l==="-o"||l==="--output"?a+1<o.length&&(s=o[++a]):l.startsWith("-")||i.push(l)}let n=i;if(e&&(n=w.getTopics().map(a=>a.name),n.length===0)){t.writeln("\x1B[33mNo topics available to record.\x1B[0m"),t.finishCommand();return}if(n.length===0){t.writeln("usage: ros2 bag record [-a] [-o <bag_name>] <topic1> <topic2> ..."),t.finishCommand();return}const r=new O(s,n);r.start(),t.writeln(`\x1B[32m[INFO] Recording to '${s}'\x1B[0m`),t.writeln("Topics:");for(const a of n)t.writeln(`  ${a}`);t.writeln(""),t.writeln("Press Ctrl+C to stop recording..."),t.addBagRecorder({stop:()=>{var l;r.stop(),N.store(r);const a=r.getInfo();t.writeln(""),t.writeln("\x1B[32m[INFO] Stopped recording.\x1B[0m"),t.writeln(`Bag: ${s}`),t.writeln(`Duration: ${((l=a.duration)==null?void 0:l.toFixed(2))||0}s`),t.writeln(`Messages: ${a.messageCount}`)}})}async function ys(o,t){var a;let e=null,s=1;for(let l=0;l<o.length;l++){const c=o[l];c==="--rate"||c==="-r"?l+1<o.length&&(s=parseFloat(o[++l])||1):c.startsWith("-")||(e=c)}if(!e){t.writeln("usage: ros2 bag play <bag_name> [--rate N]"),t.writeln(""),t.writeln("Available bags:");const l=N.list();for(const c of l)t.writeln(`  ${c}`);return}const i=N.get(e);if(!i){t.writeln(`\x1B[31mBag '${e}' not found.\x1B[0m`),t.writeln(""),t.writeln("Available bags:");const l=N.list();for(const c of l)t.writeln(`  ${c}`);return}const n=i.getInfo();t.writeln(`\x1B[32m[INFO] Playing bag '${e}'\x1B[0m`),t.writeln(`Duration: ${((a=n.duration)==null?void 0:a.toFixed(2))||0}s`),t.writeln(`Rate: ${s}x`),t.writeln("");const r=new fs(i);return new Promise(l=>{r.onComplete=()=>{t.writeln(""),t.writeln("\x1B[32m[INFO] Playback complete.\x1B[0m"),l()},r.onMessage=c=>{},r.play(s)})}function ws(o,t){var n;if(o.length===0){t.writeln("usage: ros2 bag info <bag_name>"),t.writeln(""),t.writeln("Available bags:");const r=N.list();for(const a of r)t.writeln(`  ${a}`);return}const e=o[0],s=N.get(e);if(!s){t.writeln(`\x1B[31mBag '${e}' not found.\x1B[0m`);return}const i=s.getInfo();t.writeln(`Bag: ${i.name}`),t.writeln(`Duration: ${((n=i.duration)==null?void 0:n.toFixed(2))||0}s`),t.writeln(`Messages: ${i.messageCount}`),t.writeln(""),t.writeln("Topics:");for(const r of i.topics){const a=i.topicCounts[r]||0;t.writeln(`  ${r}: ${a} messages`)}}T.registerRos2("bag",gs);async function _s(o,t){if(o.length===0){dt(t),t.finishCommand();return}const e=o[0],s=o.slice(1);switch(e){case"show":vs(s,t);break;case"list":xs(s,t);break;case"package":Ts(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),dt(t)}t.finishCommand()}function dt(o){o.writeln("usage: ros2 interface <command> [options]"),o.writeln(""),o.writeln("Commands:"),o.writeln("  show      Show the definition of an interface"),o.writeln("  list      List all available interfaces"),o.writeln("  package   List interfaces in a package")}function vs(o,t){if(o.length===0){t.writeln("usage: ros2 interface show <interface_type>");return}const e=o[0],s=ze(e);if(!s){t.writeln(`\x1B[31mInterface '${e}' not found.\x1B[0m`),t.writeln(""),t.writeln('Use "ros2 interface list" to see available interfaces.');return}t.writeln(s)}function xs(o,t){const e=o.includes("-m")||o.includes("--only-msgs"),s=o.includes("-s")||o.includes("--only-srvs"),i=o.includes("-a")||o.includes("--only-actions"),n=!e&&!s&&!i;if(n||e){t.writeln("Messages:");for(const r of xt().sort())t.writeln(`    ${r}`);t.writeln("")}if(n||s){t.writeln("Services:");for(const r of Tt().sort())t.writeln(`    ${r}`);t.writeln("")}if(n||i){t.writeln("Actions:");for(const r of St().sort())t.writeln(`    ${r}`)}}function Ts(o,t){if(o.length===0){t.writeln("usage: ros2 interface package <package_name>");return}const e=o[0],s=e+"/",i=xt().filter(a=>a.startsWith(s)),n=Tt().filter(a=>a.startsWith(s)),r=St().filter(a=>a.startsWith(s));if(i.length===0&&n.length===0&&r.length===0){t.writeln(`\x1B[31mNo interfaces found in package '${e}'.\x1B[0m`);return}for(const a of i.sort())t.writeln(a);for(const a of n.sort())t.writeln(a);for(const a of r.sort())t.writeln(a)}T.registerRos2("interface",_s);async function Ss(o,t){if(o.length===0){ut(t),t.finishCommand();return}const e=o[0],s=o.slice(1);switch(e){case"executables":Is(s,t);break;case"list":Cs(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),ut(t)}t.finishCommand()}function ut(o){o.writeln("usage: ros2 pkg <command> [options]"),o.writeln(""),o.writeln("Commands:"),o.writeln("  executables   List executables in a package"),o.writeln("  list          List available packages")}function Is(o,t){if(o.length===0){const i=C.listPackages();for(const n of i.sort()){const r=C.listExecutables(n);for(const a of r.sort())t.writeln(`${n} ${a}`)}return}const e=o[0],s=C.listExecutables(e);if(s.length===0){t.writeln(`\x1B[31mPackage '${e}' not found or has no executables.\x1B[0m`);return}for(const i of s.sort())t.writeln(`${e} ${i}`)}function Cs(o,t){const e=C.listPackages();if(e.length===0){t.writeln("No packages available.");return}for(const s of e.sort())t.writeln(s)}T.registerRos2("pkg",Ss);function ks(o,t){return t.clear(),t.finishCommand(),!0}function Ps(o,t){const e=o.includes("-a")||o.includes("-la")||o.includes("-al"),s=o.includes("-l")||o.includes("-la")||o.includes("-al"),i=[{name:"src",type:"d",size:4096},{name:"install",type:"d",size:4096},{name:"build",type:"d",size:4096},{name:"log",type:"d",size:4096},{name:"package.xml",type:"-",size:1024},{name:"CMakeLists.txt",type:"-",size:2048},{name:"setup.py",type:"-",size:512}],r=e?[...[{name:".",type:"d",size:4096},{name:"..",type:"d",size:4096},{name:".colcon",type:"d",size:4096}],...i]:i;if(s){t.writeln("total "+r.length);for(const a of r){const l=a.type==="d"?"drwxr-xr-x":"-rw-r--r--",c=String(a.size).padStart(6),h="Jan 27 12:00",d=a.type==="d"?"\x1B[34m":"",u=a.type==="d"?"\x1B[0m":"";t.writeln(`${l} 1 ros2 ros2 ${c} ${h} ${d}${a.name}${u}`)}}else{const a=r.map(l=>{const c=l.type==="d"?"\x1B[34m":"",h=l.type==="d"?"\x1B[0m":"";return`${c}${l.name}${h}`});t.writeln(a.join("  "))}return t.finishCommand(),!0}function Ms(o,t){return t.writeln("/home/ros2/ws"),t.finishCommand(),!0}function Es(o,t){return o.length>0&&t.writeln(o.join(" ")),t.finishCommand(),!0}T.register("clear",ks);T.register("ls",Ps);T.register("pwd",Ms);T.register("echo",Es);function Ls(o,t){return t.writeln("ROS2 Web Emulator - Available Commands:"),t.writeln(""),t.writeln("\x1B[33mROS2 Commands:\x1B[0m"),t.writeln('  ros2 <subcommand>  - ROS2 CLI commands (type "ros2 --help")'),t.writeln("  rqt               - Open rqt tool selector"),t.writeln("  rqt_graph         - Open node graph visualization"),t.writeln("  rqt_console       - Open log console"),t.writeln(""),t.writeln("\x1B[33mShell Commands:\x1B[0m"),t.writeln("  ls [-la]          - List directory contents"),t.writeln("  pwd               - Print working directory"),t.writeln("  clear             - Clear the terminal"),t.writeln("  echo <text>       - Print text"),t.writeln("  help              - Show this help message"),t.writeln(""),t.writeln('Type "ros2 --help" for ros2 subcommands.'),t.finishCommand(),!0}T.register("help",Ls);function As(o,t){return window.dispatchEvent(new CustomEvent(b.OPEN_RQT_MODAL)),t.finishCommand(),!0}function $s(o,t){return window.dispatchEvent(new CustomEvent(b.TOGGLE_GRAPH)),t.writeln("Opening rqt_graph..."),t.finishCommand(),!0}function Rs(o,t){return window.dispatchEvent(new CustomEvent(b.TOGGLE_CONSOLE)),t.writeln("Opening rqt_console..."),t.finishCommand(),!0}T.register("rqt",As);T.register("rqt_graph",$s);T.register("rqt_console",Rs);function pt(o){o.writeln("usage: ros2 <command> [options]"),o.writeln(""),o.writeln("Commands:"),o.writeln("  run        Run an executable from a package"),o.writeln("  node       Node-related commands"),o.writeln("  topic      Topic-related commands"),o.writeln("  service    Service-related commands"),o.writeln("  action     Action-related commands"),o.writeln("  param      Parameter-related commands"),o.writeln("  bag        Bag file commands"),o.writeln("  interface  Interface introspection"),o.writeln("  pkg        Package-related commands")}async function Ds(o,t){if(o.length===0||o[0]==="--help"||o[0]==="-h")return pt(t),t.finishCommand(),!0;const e=o[0],s=o.slice(1);return await T.executeRos2(e,s,t)||(t.writeln(`\x1B[31mUnknown ros2 command: ${e}\x1B[0m`),pt(t),t.finishCommand()),!0}T.register("ros2",Ds);async function mt(o,t){const e=o.trim();if(!e){t.finishCommand();return}const s=Os(e);if(s.length===0){t.finishCommand();return}const i=s[0],n=s.slice(1);await T.execute(i,n,t)||(t.writeln(`\x1B[31mCommand not found: ${i}\x1B[0m`),t.writeln('Type "help" for available commands.'),t.finishCommand())}function Os(o){const t=[];let e="",s=!1,i="",n=0;for(;n<o.length;){const r=o[n];if((r==='"'||r==="'")&&!s){s=!0,i=r,n++;continue}if(s&&r===i){s=!1,i="",n++;continue}if(r===" "&&!s){e&&(t.push(e),e=""),n++;continue}e+=r,n++}return e&&t.push(e),t}class L{constructor(t,e={}){if(this.name=t,this.namespace=e.namespace||"",this.fullName=this.namespace?`${this.namespace}/${t}`:`/${t}`,this.publishers=[],this.subscriptions=[],this.services=[],this.actionServers=[],this.timers=[],this.parameters=new Map,this.parameterCallbacks=[],this.running=!1,this.simDDS=e.simDDS||z.get("simDDS")||w,this.logManager=e.logManager||z.get("logManager")||E,this.logger=this.logManager.getLogger(this.fullName),this.simDDS.registerNode(this.fullName,{name:this.name,namespace:this.namespace}),e.parameters)for(const[s,i]of Object.entries(e.parameters))this.declareParameter(s,i)}declareParameter(t,e){return this.parameters.has(t)||this.parameters.set(t,e),this.parameters.get(t)}getParameter(t){return this.parameters.get(t)}setParameter(t,e){return this.setParameters({[t]:e}).successful}setParameters(t){for(const s of Object.keys(t))if(!this.parameters.has(s))return{successful:!1,reason:`Parameter '${s}' not declared on node '${this.fullName}'`};const e=this._validateParameterChanges(t);if(!e.successful)return e;for(const[s,i]of Object.entries(t))this.parameters.set(s,i),this.onParameterChange(s,i);return{successful:!0,reason:""}}getParameterNames(){return Array.from(this.parameters.keys())}onParameterChange(t,e){}addOnSetParametersCallback(t){return this.parameterCallbacks.push(t),this.parameterCallbacks.length-1}removeParameterCallback(t){t>=0&&t<this.parameterCallbacks.length&&(this.parameterCallbacks[t]=null)}_validateParameterChanges(t){for(const e of this.parameterCallbacks)if(e!==null)try{const s=e(t);if(!s.successful)return s}catch(s){return{successful:!1,reason:`Callback error: ${s.message}`}}return{successful:!0,reason:""}}createPublisher(t,e,s){const i=this.simDDS.createPublisher(this.fullName,t,e,s);return this.publishers.push(i),i}createSubscription(t,e,s,i){const n=this.simDDS.createSubscription(this.fullName,t,e,s.bind(this),i);return this.subscriptions.push(n),n}createService(t,e,s){const i=this.simDDS.createService(this.fullName,t,e,s.bind(this));return this.services.push(i),i}createActionServer(t,e,s){var r,a;const i={executeCallback:s.executeCallback.bind(this),goalCallback:(r=s.goalCallback)==null?void 0:r.bind(this),cancelCallback:(a=s.cancelCallback)==null?void 0:a.bind(this)},n=this.simDDS.createActionServer(this.fullName,t,e,i);return this.actionServers.push(n),n}createTimer(t,e){const s=setInterval(()=>{this.running&&e.call(this)},t);return this.timers.push(s),s}cancelTimer(t){clearInterval(t);const e=this.timers.indexOf(t);e>=0&&this.timers.splice(e,1)}now(){return{sec:Math.floor(Date.now()/1e3),nanosec:Date.now()%1e3*1e6}}logDebug(t){this.logger.debug(t)}logInfo(t){this.logger.info(t)}logWarn(t){this.logger.warn(t)}logError(t){this.logger.error(t)}logFatal(t){this.logger.fatal(t)}onInit(){}onShutdown(){}start(){this.running=!0,this.onInit(),this.logInfo("Node started")}destroy(){this.running=!1,this.onShutdown();for(const t of this.timers)clearInterval(t);this.timers=[],this.logInfo("Node destroyed"),this.publishers=[],this.subscriptions=[],this.services=[],this.actionServers=[],this.simDDS.unregisterNode(this.fullName)}}class Ns extends L{constructor(t="turtlesim",e={}){super(t,{...e,parameters:{background_r:69,background_g:86,background_b:255,...e.parameters}}),this.turtles=new Map,this.canvas=null,this.ctx=null,this.turtleImage=null,this.turtleImageLoaded=!1,this.trails=[],this.updateRate=60,this.publishRate=10,this.lastPosePublish=0,this.lidarEnabled=!0,this.lidarPublishRate=10,this.lastLidarPublish=0}onInit(){this._spawnTurtle("turtle1",5.544445,5.544445,0),this.createService("/spawn","turtlesim/srv/Spawn",this._handleSpawn.bind(this)),this.createService("/kill","turtlesim/srv/Kill",this._handleKill.bind(this)),this.createService("/clear","turtlesim/srv/Empty",this._handleClear.bind(this)),this.createService("/reset","turtlesim/srv/Empty",this._handleReset.bind(this)),this.createTimer(1e3/this.updateRate,this._update.bind(this)),this._notifyCanvas(),this.addOnSetParametersCallback(t=>{for(const e of["background_r","background_g","background_b"])if(e in t){const s=t[e];if(typeof s!="number"||!Number.isInteger(s)||s<0||s>255)return{successful:!1,reason:`${e} must be an integer between 0 and 255`}}return{successful:!0,reason:""}}),this.logInfo("Turtlesim node started")}onShutdown(){for(const[t,e]of this.turtles)e.activeActionInterval&&(clearInterval(e.activeActionInterval),e.activeActionInterval=null),I.removeTurtle(t);this.turtles.clear(),this.trails=[]}onParameterChange(t,e){t.startsWith("background_")&&this._notifyCanvas()}_spawnTurtle(t,e,s,i){if(this.turtles.has(t))return null;const n={name:t,x:e,y:s,theta:i,linearVelocity:0,angularVelocity:0,pen:{r:184,g:184,b:184,width:3,off:!1},activeActionInterval:null};this.turtles.set(t,n),I.registerTurtle(t,e,s,i);const r=`/${t}`;return n.posePub=this.createPublisher(`${r}/pose`,"turtlesim/msg/Pose"),n.colorPub=this.createPublisher(`${r}/color_sensor`,"turtlesim/msg/Color"),n.cmdVelSub=this.createSubscription(`${r}/cmd_vel`,"geometry_msgs/msg/Twist",a=>this._handleCmdVel(t,a)),n.setPenService=this.createService(`${r}/set_pen`,"turtlesim/srv/SetPen",a=>this._handleSetPen(t,a)),n.teleportAbsService=this.createService(`${r}/teleport_absolute`,"turtlesim/srv/TeleportAbsolute",a=>this._handleTeleportAbsolute(t,a)),n.teleportRelService=this.createService(`${r}/teleport_relative`,"turtlesim/srv/TeleportRelative",a=>this._handleTeleportRelative(t,a)),t==="turtle1"&&(n.rotateAbsAction=this.createActionServer(`${r}/rotate_absolute`,"turtlesim/action/RotateAbsolute",{executeCallback:(a,l,c,h)=>this._executeRotateAbsolute(t,a,c,h),goalCallback:()=>!0}),this.lidarEnabled&&(n.scanPub=this.createPublisher("/scan","sensor_msgs/msg/LaserScan"))),this.logInfo(`Spawned turtle '${t}' at (${e.toFixed(2)}, ${s.toFixed(2)})`),t}_handleSpawn(t){let e=t.name;if(!e){let i=1;for(;this.turtles.has(`turtle${i}`);)i++;e=`turtle${i}`}return{name:this._spawnTurtle(e,t.x,t.y,t.theta)||""}}_handleKill(t){const e=this.turtles.get(t.name);if(!e)throw new Error(`Turtle '${t.name}' not found`);return e.activeActionInterval&&(clearInterval(e.activeActionInterval),e.activeActionInterval=null),e.posePub&&e.posePub.destroy(),e.colorPub&&e.colorPub.destroy(),e.cmdVelSub&&e.cmdVelSub.destroy(),e.setPenService&&e.setPenService.destroy(),e.teleportAbsService&&e.teleportAbsService.destroy(),e.teleportRelService&&e.teleportRelService.destroy(),e.rotateAbsAction&&e.rotateAbsAction.destroy(),e.scanPub&&e.scanPub.destroy(),this.turtles.delete(t.name),I.removeTurtle(t.name),this.logInfo(`Killed turtle '${t.name}'`),{}}_handleClear(){return this.trails=[],this._notifyCanvas(),{}}_handleReset(){for(const[e]of this.turtles)e!=="turtle1"&&this._handleKill({name:e});const t=this.turtles.get("turtle1");return t&&(t.x=5.544445,t.y=5.544445,t.theta=0,t.linearVelocity=0,t.angularVelocity=0,I.updateTurtle("turtle1",t.x,t.y,t.theta)),this.trails=[],this._notifyCanvas(),{}}_handleCmdVel(t,e){var i,n;const s=this.turtles.get(t);s&&(s.linearVelocity=((i=e.linear)==null?void 0:i.x)||0,s.angularVelocity=((n=e.angular)==null?void 0:n.z)||0)}_handleSetPen(t,e){const s=this.turtles.get(t);if(!s)throw new Error(`Turtle '${t}' not found`);return s.pen={r:e.r,g:e.g,b:e.b,width:e.width,off:e.off!==0},{}}_handleTeleportAbsolute(t,e){const s=this.turtles.get(t);if(!s)throw new Error(`Turtle '${t}' not found`);return s.x=e.x,s.y=e.y,s.theta=e.theta,I.updateTurtle(t,s.x,s.y,s.theta),{}}_handleTeleportRelative(t,e){const s=this.turtles.get(t);if(!s)throw new Error(`Turtle '${t}' not found`);return s.theta+=e.angular,s.x+=Math.cos(s.theta)*e.linear,s.y+=Math.sin(s.theta)*e.linear,I.updateTurtle(t,s.x,s.y,s.theta),{}}async _executeRotateAbsolute(t,e,s,i){const n=this.turtles.get(t);if(!n)throw new Error(`Turtle '${t}' not found`);n.activeActionInterval&&(clearInterval(n.activeActionInterval),n.activeActionInterval=null);const r=e.theta,a=n.theta;let l=r-n.theta;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;const c=1,h=l>0?1:-1,d=Math.abs(l);let u=0;return new Promise(p=>{const g=setInterval(()=>{if(i()){clearInterval(g),n.activeActionInterval=null,p({delta:u*h});return}const m=c/30;if(u+=m,u>=d)n.theta=r,clearInterval(g),n.activeActionInterval=null,p({delta:d*h});else{n.theta=a+u*h,I.updateTurtle(t,n.x,n.y,n.theta);const f=d-u;s({remaining:f})}},33.333333333333336);n.activeActionInterval=g})}_update(){const t=1/this.updateRate,e=Date.now();for(const[s,i]of this.turtles){const n=i.x,r=i.y;if(i.linearVelocity!==0||i.angularVelocity!==0){for(i.theta+=i.angularVelocity*t;i.theta>Math.PI;)i.theta-=2*Math.PI;for(;i.theta<-Math.PI;)i.theta+=2*Math.PI;const a=i.x+Math.cos(i.theta)*i.linearVelocity*t,l=i.y+Math.sin(i.theta)*i.linearVelocity*t;i.x=Math.max(0,Math.min(11,a)),i.y=Math.max(0,Math.min(11,l)),I.updateTurtle(s,i.x,i.y,i.theta),!i.pen.off&&(i.x!==n||i.y!==r)&&this.trails.push({x1:n,y1:r,x2:i.x,y2:i.y,color:`rgb(${i.pen.r}, ${i.pen.g}, ${i.pen.b})`,width:i.pen.width})}if(e-this.lastPosePublish>=1e3/this.publishRate){const a={x:i.x,y:i.y,theta:i.theta,linear_velocity:i.linearVelocity,angular_velocity:i.angularVelocity};i.posePub.publish(a)}if(s==="turtle1"&&this.lidarEnabled&&i.scanPub&&e-this.lastLidarPublish>=1e3/this.lidarPublishRate){const a=I.lidarScan(i.x,i.y,i.theta,{angleMin:-Math.PI,angleMax:Math.PI,numRays:360,rangeMax:10});a.header={stamp:this.now(),frame_id:"base_link"},i.scanPub.publish(a),this.lastLidarPublish=e}}e-this.lastPosePublish>=1e3/this.publishRate&&(this.lastPosePublish=e),this._notifyCanvas()}_notifyCanvas(){window.dispatchEvent(new CustomEvent(b.TURTLESIM_UPDATE,{detail:{turtles:Array.from(this.turtles.values()),trails:this.trails,background:{r:this.getParameter("background_r"),g:this.getParameter("background_g"),b:this.getParameter("background_b")}}}))}getTurtleData(){return{turtles:Array.from(this.turtles.values()),trails:this.trails,background:{r:this.getParameter("background_r"),g:this.getParameter("background_g"),b:this.getParameter("background_b")}}}}C.register("turtlesim","turtlesim_node",Ns);class zs extends L{constructor(t="turtle_teleop_key",e={}){var s;super(t,{...e,parameters:{scale_linear:2,scale_angular:2,...e.parameters}}),this.targetTopic=((s=e.remappings)==null?void 0:s.cmd_vel)||"/turtle1/cmd_vel",this.keyHandler=null,this.activeKeys=new Set}onInit(){this.cmdVelPub=this.createPublisher(this.targetTopic,"geometry_msgs/msg/Twist"),this.keyHandler=this._handleKeyDown.bind(this),this.keyUpHandler=this._handleKeyUp.bind(this),window.addEventListener("keydown",this.keyHandler),window.addEventListener("keyup",this.keyUpHandler),this.createTimer(100,this._publishVelocity.bind(this)),this.logInfo("Turtle teleop started. Use arrow keys to move the turtle."),this.logInfo(`Publishing to: ${this.targetTopic}`),window.dispatchEvent(new CustomEvent(b.TELEOP_ACTIVE,{detail:{type:"arrow-keys",node:this.fullName}}))}onShutdown(){this.keyHandler&&(window.removeEventListener("keydown",this.keyHandler),window.removeEventListener("keyup",this.keyUpHandler)),this.activeKeys.clear(),window.dispatchEvent(new CustomEvent(b.TELEOP_INACTIVE,{detail:{node:this.fullName}}))}_handleKeyDown(t){["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key)&&(t.preventDefault(),this.activeKeys.add(t.key))}_handleKeyUp(t){["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key)&&(t.preventDefault(),this.activeKeys.delete(t.key))}_publishVelocity(){const t=this.getParameter("scale_linear"),e=this.getParameter("scale_angular");let s=0,i=0;if(this.activeKeys.has("ArrowUp")&&(s+=t),this.activeKeys.has("ArrowDown")&&(s-=t),this.activeKeys.has("ArrowLeft")&&(i+=e),this.activeKeys.has("ArrowRight")&&(i-=e),s!==0||i!==0||this.lastVelocity){const n={linear:{x:s,y:0,z:0},angular:{x:0,y:0,z:i}};this.cmdVelPub.publish(n),this.lastVelocity=s!==0||i!==0}}}C.register("turtlesim","turtle_teleop_key",zs);class Fs extends L{constructor(t="teleop_twist_keyboard",e={}){var s;super(t,{...e,parameters:{speed:.5,turn:1,speed_limit:2,turn_limit:2,...e.parameters}}),this.targetTopic=((s=e.remappings)==null?void 0:s.cmd_vel)||"/turtle1/cmd_vel",this.keyHandler=null,this.keyUpHandler=null,this.activeKeys=new Set,this.currentSpeed=.5,this.currentTurn=1}onInit(){this.cmdVelPub=this.createPublisher(this.targetTopic,"geometry_msgs/msg/Twist"),this.keyHandler=this._handleKeyDown.bind(this),this.keyUpHandler=this._handleKeyUp.bind(this),window.addEventListener("keydown",this.keyHandler),window.addEventListener("keyup",this.keyUpHandler),this.createTimer(100,this._publishVelocity.bind(this)),this.logInfo("Teleop Twist Keyboard started."),this.logInfo("W/S: forward/back, A/D: turn, Q/E: diagonal, X: stop"),this.logInfo(`Publishing to: ${this.targetTopic}`),window.dispatchEvent(new CustomEvent(b.TELEOP_ACTIVE,{detail:{type:"wasd-keys",node:this.fullName}}))}onShutdown(){this.keyHandler&&(window.removeEventListener("keydown",this.keyHandler),window.removeEventListener("keyup",this.keyUpHandler)),this.activeKeys.clear(),window.dispatchEvent(new CustomEvent(b.TELEOP_INACTIVE,{detail:{node:this.fullName}}))}_handleKeyDown(t){const e=t.key.toLowerCase();if(["w","a","s","d","q","e","x"].includes(e)){t.preventDefault(),this.activeKeys.add(e);return}if(e==="i"){this.currentSpeed=Math.min(this.getParameter("speed_limit"),this.currentSpeed+.1),this.logInfo(`Speed: ${this.currentSpeed.toFixed(1)}`),t.preventDefault();return}if(e==="k"){this.currentSpeed=Math.max(.1,this.currentSpeed-.1),this.logInfo(`Speed: ${this.currentSpeed.toFixed(1)}`),t.preventDefault();return}if(e==="o"){this.currentTurn=Math.min(this.getParameter("turn_limit"),this.currentTurn+.1),this.logInfo(`Turn: ${this.currentTurn.toFixed(1)}`),t.preventDefault();return}if(e==="l"){this.currentTurn=Math.max(.1,this.currentTurn-.1),this.logInfo(`Turn: ${this.currentTurn.toFixed(1)}`),t.preventDefault();return}}_handleKeyUp(t){const e=t.key.toLowerCase();["w","a","s","d","q","e","x"].includes(e)&&(t.preventDefault(),this.activeKeys.delete(e))}_publishVelocity(){let t=0,e=0;if(this.activeKeys.has("x")){const s={linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:0}};this.cmdVelPub.publish(s),this.lastVelocity=!1;return}if(this.activeKeys.has("w")&&(t+=this.currentSpeed),this.activeKeys.has("s")&&(t-=this.currentSpeed),this.activeKeys.has("a")&&(e+=this.currentTurn),this.activeKeys.has("d")&&(e-=this.currentTurn),this.activeKeys.has("q")&&(t+=this.currentSpeed,e+=this.currentTurn),this.activeKeys.has("e")&&(t+=this.currentSpeed,e-=this.currentTurn),t!==0||e!==0||this.lastVelocity){const s={linear:{x:t,y:0,z:0},angular:{x:0,y:0,z:e}};this.cmdVelPub.publish(s),this.lastVelocity=t!==0||e!==0}}}C.register("teleop_twist_keyboard","teleop_twist_keyboard",Fs);class Bs extends L{constructor(t="slam_node",e={}){super(t,{...e,parameters:{map_resolution:.1,map_width:110,map_height:110,origin_x:0,origin_y:0,hit_prob:.9,miss_prob:.3,loop_closure_enabled:!0,loop_closure_distance:.5,loop_closure_min_travel:3,loop_closure_cooldown:5e3,drift_enabled:!1,drift_rate:.005,drift_max:.3,localization_mode:!1,...e.parameters}}),this.grid=null,this.gridWidth=0,this.gridHeight=0,this.resolution=0,this.originX=0,this.originY=0,this.robotX=5.5,this.robotY=5.5,this.robotTheta=0,this.driftX=0,this.driftY=0,this.driftTheta=0,this.l0=0,this.lOcc=0,this.lFree=0,this.lMin=-5,this.lMax=5,this.poseGraph=[],this.totalDistanceTraveled=0,this.lastPoseX=5.5,this.lastPoseY=5.5,this.lastLoopClosureTime=0,this.loopClosureCount=0,this.storedGrid=null}onInit(){this._initializeGrid();const t=this.getParameter("hit_prob"),e=this.getParameter("miss_prob");this.lOcc=Math.log(t/(1-t)),this.lFree=Math.log(e/(1-e)),this.createSubscription("/turtle1/pose","turtlesim/msg/Pose",this._handlePose.bind(this)),this.createSubscription("/scan","sensor_msgs/msg/LaserScan",this._handleScan.bind(this)),this.mapPub=this.createPublisher("/map","nav_msgs/msg/OccupancyGrid"),this.loopClosurePub=this.createPublisher("/loop_closures","std_msgs/msg/String"),this.createTimer(500,this._publishMap.bind(this)),this.createService("/slam/save_map","std_srvs/srv/Empty",this._handleSaveMap.bind(this)),this.createService("/slam/load_map","std_srvs/srv/Empty",this._handleLoadMap.bind(this)),this.addOnSetParametersCallback(i=>{if("map_resolution"in i){const n=i.map_resolution;if(typeof n!="number"||n<=0||n>1)return{successful:!1,reason:"map_resolution must be between 0.0 (exclusive) and 1.0"}}if("hit_prob"in i){const n=i.hit_prob;if(typeof n!="number"||n<.5||n>1)return{successful:!1,reason:"hit_prob must be between 0.5 and 1.0"}}if("miss_prob"in i){const n=i.miss_prob;if(typeof n!="number"||n<0||n>.5)return{successful:!1,reason:"miss_prob must be between 0.0 and 0.5"}}if("loop_closure_distance"in i){const n=i.loop_closure_distance;if(typeof n!="number"||n<=0)return{successful:!1,reason:"loop_closure_distance must be positive"}}if("drift_rate"in i){const n=i.drift_rate;if(typeof n!="number"||n<0)return{successful:!1,reason:"drift_rate must be non-negative"}}return{successful:!0,reason:""}});const s=this.getParameter("localization_mode")?"LOCALIZATION":"MAPPING";this.logInfo(`SLAM node started in ${s} mode. Subscribe to /scan and /turtle1/pose`),this.logInfo(`Map: ${this.gridWidth}x${this.gridHeight} cells, ${this.resolution}m resolution`),this.getParameter("loop_closure_enabled")&&this.logInfo("Loop closure detection enabled"),this.getParameter("drift_enabled")&&this.logInfo(`Odometry drift simulation enabled (rate: ${this.getParameter("drift_rate")})`),window.dispatchEvent(new CustomEvent(b.SHOW_MAP)),this.logInfo("Map visualization enabled - watch the occupancy grid build as you explore!")}_initializeGrid(){this.gridWidth=this.getParameter("map_width"),this.gridHeight=this.getParameter("map_height"),this.resolution=this.getParameter("map_resolution"),this.originX=this.getParameter("origin_x"),this.originY=this.getParameter("origin_y"),this.grid=new Float32Array(this.gridWidth*this.gridHeight),this.grid.fill(0)}_handlePose(t){const e=this.robotX,s=this.robotY;this.robotX=t.x,this.robotY=t.y,this.robotTheta=t.theta;const i=this.robotX-e,n=this.robotY-s,r=Math.sqrt(i*i+n*n);this.totalDistanceTraveled+=r,this.getParameter("drift_enabled")&&r>.001&&this._simulateDrift(r),Math.sqrt((this.robotX-this.lastPoseX)**2+(this.robotY-this.lastPoseY)**2)>=.5&&(this._addToPoseGraph(),this.lastPoseX=this.robotX,this.lastPoseY=this.robotY),window.dispatchEvent(new CustomEvent(b.ROBOT_POSE_UPDATE,{detail:{x:this.robotX,y:this.robotY,theta:this.robotTheta}}))}_simulateDrift(t){const e=this.getParameter("drift_rate"),s=this.getParameter("drift_max");this.driftX+=(Math.random()-.5)*e*t*2,this.driftY+=(Math.random()-.5)*e*t*2,this.driftTheta+=(Math.random()-.5)*e*t*.5,this.driftX=Math.max(-s,Math.min(s,this.driftX)),this.driftY=Math.max(-s,Math.min(s,this.driftY)),this.driftTheta=Math.max(-s*.3,Math.min(s*.3,this.driftTheta))}_addToPoseGraph(){this.poseGraph.push({x:this.robotX,y:this.robotY,theta:this.robotTheta,timestamp:Date.now(),distanceTraveled:this.totalDistanceTraveled}),this.poseGraph.length>1e3&&(this.poseGraph=this.poseGraph.slice(-500))}_handleScan(t){if(this.getParameter("localization_mode")&&this.storedGrid)return;const e=this.robotX+this.driftX,s=this.robotY+this.driftY,i=this.robotTheta+this.driftTheta,{angle_min:n,angle_increment:r,ranges:a,range_max:l}=t;for(let c=0;c<a.length;c++){const h=a[c],d=i+n+c*r;if(!isFinite(h)||h<=0)continue;const u=h<l-.1,p=u?Math.max(0,h-this.resolution*.5):h,g=e+Math.cos(d)*p,m=s+Math.sin(d)*p;this._rayTrace(e,s,g,m,u)}this.getParameter("loop_closure_enabled")&&this._checkLoopClosure()}_checkLoopClosure(){const t=Date.now(),e=this.getParameter("loop_closure_cooldown"),s=this.getParameter("loop_closure_min_travel"),i=this.getParameter("loop_closure_distance");if(t-this.lastLoopClosureTime<e||this.totalDistanceTraveled<s||this.poseGraph.length<10)return;const n=this.poseGraph.length-10;for(let r=0;r<n;r++){const a=this.poseGraph[r],l=this.robotX-a.x,c=this.robotY-a.y,h=Math.sqrt(l*l+c*c);if(!(this.totalDistanceTraveled-a.distanceTraveled<s)&&h<i){this._applyLoopClosure(a),this.lastLoopClosureTime=t;return}}}_applyLoopClosure(t){this.loopClosureCount++;const e=this.driftX,s=this.driftY,i=this.driftTheta;this.logInfo(`Loop closure #${this.loopClosureCount} detected!`),this.logInfo(`  Matched pose: (${t.x.toFixed(2)}, ${t.y.toFixed(2)})`),this.logInfo(`  Current pose: (${this.robotX.toFixed(2)}, ${this.robotY.toFixed(2)})`),this.getParameter("drift_enabled")&&(this.logInfo(`  Drift corrected: dx=${e.toFixed(3)}, dy=${s.toFixed(3)}, dtheta=${i.toFixed(3)}`),this.driftX=0,this.driftY=0,this.driftTheta=0),this.loopClosurePub.publish({data:`Loop closure #${this.loopClosureCount} at (${this.robotX.toFixed(2)}, ${this.robotY.toFixed(2)})`}),window.dispatchEvent(new CustomEvent(b.LOOP_CLOSURE_DETECTED,{detail:{currentPose:{x:this.robotX,y:this.robotY,theta:this.robotTheta},matchedPose:{x:t.x,y:t.y,theta:t.theta},error:{x:e,y:s,theta:i},count:this.loopClosureCount}}))}_handleSaveMap(){return this.storedGrid=new Float32Array(this.grid),this.logInfo("Map saved for localization. Use ros2 param set /slam_node localization_mode true to switch."),{}}_handleLoadMap(){return this.storedGrid?(this.grid=new Float32Array(this.storedGrid),this.logInfo("Stored map loaded into active grid.")):this.logWarn("No stored map available. Save a map first with /slam/save_map."),{}}_rayTrace(t,e,s,i,n){const r=this._worldToGridX(t),a=this._worldToGridY(e),l=this._worldToGridX(s),c=this._worldToGridY(i),h=l-r,d=c-a,u=Math.max(Math.abs(h),Math.abs(d));if(u===0){if(r>=0&&r<this.gridWidth&&a>=0&&a<this.gridHeight){const v=a*this.gridWidth+r;n&&(this.grid[v]=Math.min(this.lMax,this.grid[v]+this.lOcc))}return}const p=h/u,g=d/u;let m=r,f=a,_=-1,x=-1;for(let v=0;v<=u;v++){const S=Math.round(m),P=Math.round(f);if(S===_&&P===x){m+=p,f+=g;continue}if(_=S,x=P,S>=0&&S<this.gridWidth&&P>=0&&P<this.gridHeight){const M=P*this.gridWidth+S;v===u?n&&(this.grid[M]=Math.min(this.lMax,this.grid[M]+this.lOcc)):this.grid[M]=Math.max(this.lMin,this.grid[M]+this.lFree)}m+=p,f+=g}}_worldToGridX(t){return Math.floor((t-this.originX)/this.resolution)}_worldToGridY(t){return Math.floor((t-this.originY)/this.resolution)}_logOddsToProbability(t){return 1-1/(1+Math.exp(t))}_publishMap(){const t=new Int8Array(this.grid.length);for(let s=0;s<this.grid.length;s++){const i=this.grid[s];if(Math.abs(i)<.1)t[s]=-1;else{const n=this._logOddsToProbability(i);t[s]=Math.round(n*100)}}const e={header:{stamp:this.now(),frame_id:"map"},info:{map_load_time:this.now(),resolution:this.resolution,width:this.gridWidth,height:this.gridHeight,origin:{position:{x:this.originX,y:this.originY,z:0},orientation:{x:0,y:0,z:0,w:1}}},data:Array.from(t)};this.mapPub.publish(e),window.dispatchEvent(new CustomEvent(b.MAP_UPDATE,{detail:{map:Array.from(t),info:e.info}}))}onParameterChange(t,e){t==="hit_prob"?this.lOcc=Math.log(e/(1-e)):t==="miss_prob"?this.lFree=Math.log(e/(1-e)):t==="localization_mode"?e&&this.storedGrid?(this.grid=new Float32Array(this.storedGrid),this.logInfo("Switched to LOCALIZATION mode - using stored map")):e&&!this.storedGrid?this.logWarn("No stored map available. Save map first: ros2 service call /slam/save_map std_srvs/srv/Empty"):this.logInfo("Switched to MAPPING mode"):t==="drift_enabled"&&(e?this.logInfo("Odometry drift simulation enabled"):(this.driftX=0,this.driftY=0,this.driftTheta=0,this.logInfo("Odometry drift simulation disabled, drift reset")))}onShutdown(){this.grid=null,this.storedGrid=null,this.poseGraph=[]}}C.register("simple_slam","slam_node",Bs);class Ws{constructor(){this.transforms=new Map,this.staticTransforms=new Map,this.bufferDuration=1e4}setTransform(t,e=!1){const{header:s,child_frame_id:i,transform:n}=t,r=s.frame_id,a=i,l=e?this.staticTransforms:this.transforms;l.has(a)||l.set(a,new Map);const c=l.get(a);c.has(r)||c.set(r,[]);const h=c.get(r),d={timestamp:s.stamp.sec*1e3+s.stamp.nanosec/1e6,transform:n};e?c.set(r,[d]):(h.push(d),this._cleanupBuffer(h))}_cleanupBuffer(t){const s=Date.now()-this.bufferDuration;for(;t.length>0&&t[0].timestamp<s;)t.shift()}lookupTransform(t,e,s=0){let i=this._getDirectTransform(e,t,s);if(i)return i;if(i=this._getDirectTransform(t,e,s),i)return this._invertTransform(i);const n=this._findPath(e,t);return n?this._chainTransforms(n,s):null}_getDirectTransform(t,e,s){const i=this.staticTransforms.get(t);if(i&&i.has(e)){const r=i.get(e);if(r.length>0)return r[r.length-1].transform}const n=this.transforms.get(t);if(n&&n.has(e)){const r=n.get(e);if(r.length===0)return null;if(s===0)return r[r.length-1].transform;for(let a=r.length-1;a>=0;a--)if(r[a].timestamp<=s)return r[a].transform;return r[0].transform}return null}_invertTransform(t){const{translation:e,rotation:s}=t,i={x:-s.x,y:-s.y,z:-s.z,w:s.w};return{translation:this._rotateVector({x:-e.x,y:-e.y,z:-e.z},i),rotation:i}}_rotateVector(t,e){const{x:s,y:i,z:n,w:r}=e,a=[2*(i*t.z-n*t.y),2*(n*t.x-s*t.z),2*(s*t.y-i*t.x)];return{x:t.x+r*a[0]+i*a[2]-n*a[1],y:t.y+r*a[1]+n*a[0]-s*a[2],z:t.z+r*a[2]+s*a[1]-i*a[0]}}_findPath(t,e){this._getAllFrames();const s=new Set,i=[[t,[t]]];for(;i.length>0;){const[n,r]=i.shift();if(n===e)return r;if(s.has(n))continue;s.add(n);const a=this._getConnectedFrames(n);for(const l of a)s.has(l)||i.push([l,[...r,l]])}return null}_getConnectedFrames(t){const e=new Set;for(const[s]of[[this.transforms],[this.staticTransforms]]){const i=s.get(t);if(i)for(const n of i.keys())e.add(n);for(const[n,r]of s)r.has(t)&&e.add(n)}return e}_chainTransforms(t,e){let s={translation:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0,w:1}};for(let i=0;i<t.length-1;i++){const n=t[i],r=t[i+1];let a=this._getDirectTransform(n,r,e);if(!a)if(a=this._getDirectTransform(r,n,e),a)a=this._invertTransform(a);else return null;s=this._composeTransforms(s,a)}return s}_composeTransforms(t,e){const s=t.rotation,i=e.rotation,n={x:s.w*i.x+s.x*i.w+s.y*i.z-s.z*i.y,y:s.w*i.y-s.x*i.z+s.y*i.w+s.z*i.x,z:s.w*i.z+s.x*i.y-s.y*i.x+s.z*i.w,w:s.w*i.w-s.x*i.x-s.y*i.y-s.z*i.z},r=this._rotateVector(e.translation,s);return{translation:{x:t.translation.x+r.x,y:t.translation.y+r.y,z:t.translation.z+r.z},rotation:n}}_getAllFrames(){const t=new Set;for(const e of[this.transforms,this.staticTransforms])for(const[s,i]of e){t.add(s);for(const n of i.keys())t.add(n)}return t}getFrameTree(){const t={},e=this._getAllFrames();for(const s of e)t[s]={parents:[],children:[]};for(const s of[this.transforms,this.staticTransforms])for(const[i,n]of s)for(const r of n.keys())t[i]&&t[i].parents.push(r),t[r]&&t[r].children.push(i);return t}clear(){this.transforms.clear(),this.staticTransforms.clear()}}const Y=new Ws;class Gs extends L{constructor(t="static_transform_publisher",e={}){super(t,e),this.transform={translation:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0,w:1}},this.frameId="world",this.childFrameId="base_link",this._parseArgs(e.args||[])}_parseArgs(t){if(t.length!==0&&t.length>=8)if(this.transform.translation.x=parseFloat(t[0])||0,this.transform.translation.y=parseFloat(t[1])||0,this.transform.translation.z=parseFloat(t[2])||0,t.length===8){const e=parseFloat(t[3])||0,s=parseFloat(t[4])||0,i=parseFloat(t[5])||0;this.transform.rotation=this._eulerToQuaternion(e,s,i),this.frameId=t[6],this.childFrameId=t[7]}else t.length>=9&&(this.transform.rotation.x=parseFloat(t[3])||0,this.transform.rotation.y=parseFloat(t[4])||0,this.transform.rotation.z=parseFloat(t[5])||0,this.transform.rotation.w=parseFloat(t[6])||1,this.frameId=t[7],this.childFrameId=t[8])}_eulerToQuaternion(t,e,s){const i=Math.cos(t*.5),n=Math.sin(t*.5),r=Math.cos(e*.5),a=Math.sin(e*.5),l=Math.cos(s*.5),c=Math.sin(s*.5);return{w:l*r*i+c*a*n,x:c*r*i-l*a*n,y:l*a*i+c*r*n,z:l*r*n-c*a*i}}onInit(){this.tfPub=this.createPublisher("/tf_static","tf2_msgs/msg/TFMessage");const t={header:{stamp:this.now(),frame_id:this.frameId},child_frame_id:this.childFrameId,transform:this.transform};Y.setTransform(t,!0),this.tfPub.publish({transforms:[t]}),this.createTimer(1e3,()=>{const e={transforms:[{header:{stamp:this.now(),frame_id:this.frameId},child_frame_id:this.childFrameId,transform:this.transform}]};this.tfPub.publish(e)}),this.logInfo(`Publishing static transform: ${this.frameId} -> ${this.childFrameId}`),this.logInfo(`  Translation: (${this.transform.translation.x}, ${this.transform.translation.y}, ${this.transform.translation.z})`),this.logInfo(`  Rotation: (${this.transform.rotation.x}, ${this.transform.rotation.y}, ${this.transform.rotation.z}, ${this.transform.rotation.w})`)}}C.register("tf2_ros","static_transform_publisher",Gs);class Hs extends L{constructor(t="tf2_echo",e={}){super(t,e);const s=e.args||[];this.sourceFrame=s[0]||"world",this.targetFrame=s[1]||"base_link"}onInit(){this.logInfo(`Listening to transform from ${this.sourceFrame} to ${this.targetFrame}`),this.createTimer(1e3,this._queryTransform.bind(this))}_queryTransform(){const t=Y.lookupTransform(this.targetFrame,this.sourceFrame);if(t){const{translation:e,rotation:s}=t;this.logInfo(`At time ${(Date.now()/1e3).toFixed(3)}`),this.logInfo(`- Translation: [${e.x.toFixed(3)}, ${e.y.toFixed(3)}, ${e.z.toFixed(3)}]`),this.logInfo(`- Rotation: in Quaternion [${s.x.toFixed(3)}, ${s.y.toFixed(3)}, ${s.z.toFixed(3)}, ${s.w.toFixed(3)}]`);const i=Math.atan2(2*(s.w*s.z+s.x*s.y),1-2*(s.y*s.y+s.z*s.z));this.logInfo(`- Rotation: in RPY (radian) [0.000, 0.000, ${i.toFixed(3)}]`)}else this.logWarn(`Could not transform ${this.sourceFrame} to ${this.targetFrame}: frame not found`)}}C.register("tf2_ros","tf2_echo",Hs);class qs extends L{constructor(t="tf2_monitor",e={}){super(t,e),this.frameCounts=new Map,this.lastResetTime=Date.now()}onInit(){this.createSubscription("/tf","tf2_msgs/msg/TFMessage",this._handleTF.bind(this)),this.createSubscription("/tf_static","tf2_msgs/msg/TFMessage",this._handleStaticTF.bind(this)),this.createTimer(1e3,this._displayStatus.bind(this)),this.logInfo("Monitoring all transforms. Press Ctrl+C to stop.")}_handleTF(t){if(t.transforms)for(const e of t.transforms){const s=`${e.header.frame_id} -> ${e.child_frame_id}`;this.frameCounts.set(s,(this.frameCounts.get(s)||0)+1)}}_handleStaticTF(t){if(t.transforms)for(const e of t.transforms){const s=`${e.header.frame_id} -> ${e.child_frame_id} [static]`;this.frameCounts.set(s,(this.frameCounts.get(s)||0)+1)}}_displayStatus(){const t=Date.now(),e=(t-this.lastResetTime)/1e3,s=Y.getFrameTree(),i=Object.keys(s);if(this.logInfo(""),this.logInfo(`Frames: ${i.length}`),this.frameCounts.size===0)this.logInfo("No transforms received yet.");else for(const[n,r]of this.frameCounts.entries()){const a=e>0?(r/e).toFixed(1):"0.0";this.logInfo(`  ${n}  Average rate: ${a} Hz`)}this.frameCounts.clear(),this.lastResetTime=t}}C.register("tf2_ros","tf2_monitor",qs);class Us extends L{constructor(t="view_frames",e={}){super(t,e)}onInit(){const t=Y.getFrameTree(),e=Object.keys(t);if(e.length===0)this.logInfo("No transform data available. Publish transforms first."),this.logInfo("Example: ros2 run tf2_ros static_transform_publisher 0 0 0 0 0 0 world base_link");else{const s=e.filter(i=>t[i].parents.length===0);if(this.logInfo(`Frames (${e.length}):`),s.length===0)for(const i of e.sort()){const n=t[i].parents.join(", "),r=t[i].children.join(", ");this.logInfo(`  ${i}  parents: [${n}]  children: [${r}]`)}else for(const i of s)this._printTree(i,t,"",!0)}setTimeout(()=>{const s=k.getProcessByNodeName(this.fullName);s&&k.kill(s.processId)},100)}_printTree(t,e,s,i){const n=s===""?"":i?"\\-- ":"+-- ";this.logInfo(s+n+t);const r=e[t].children,a=s===""?"    ":s+(i?"    ":"|   ");r.forEach((l,c)=>{const h=c===r.length-1;this._printTree(l,e,a,h)})}}C.register("tf2_ros","view_frames",Us);class Vs extends L{constructor(t="navigator_node",e={}){super(t,{...e,parameters:{goal_tolerance:.3,max_speed:1.5,max_angular_speed:2.5,obstacle_threshold:50,robot_radius:.6,recovery_enabled:!0,stuck_timeout:3,max_recovery_attempts:3,...e.parameters}}),this.mapData=null,this.mapInfo=null,this._inflationRadiusCells=0,this.currentPose={x:5.5,y:5.5,theta:0},this.isNavigating=!1}onInit(){this.createSubscription("/map","nav_msgs/msg/OccupancyGrid",this._handleMap.bind(this)),this.createSubscription("/turtle1/pose","turtlesim/msg/Pose",this._handlePose.bind(this)),this.pathPub=this.createPublisher("/plan","nav_msgs/msg/Path"),this.cmdVelPub=this.createPublisher("/turtle1/cmd_vel","geometry_msgs/msg/Twist"),this.recoveryPub=this.createPublisher("/recovery_status","std_msgs/msg/String"),this.createActionServer("/navigate_to_pose","nav2_msgs/action/NavigateToPose",{executeCallback:this._executeNavigate.bind(this),goalCallback:()=>!0}),this.createActionServer("/follow_waypoints","nav2_msgs/action/FollowWaypoints",{executeCallback:this._executeFollowWaypoints.bind(this),goalCallback:()=>!0}),this.addOnSetParametersCallback(t=>"goal_tolerance"in t&&(t.goal_tolerance<=0||t.goal_tolerance>5)?{successful:!1,reason:"goal_tolerance must be between 0 (exclusive) and 5.0"}:"max_speed"in t&&(t.max_speed<=0||t.max_speed>10)?{successful:!1,reason:"max_speed must be between 0 (exclusive) and 10.0"}:"obstacle_threshold"in t&&(t.obstacle_threshold<0||t.obstacle_threshold>100)?{successful:!1,reason:"obstacle_threshold must be between 0 and 100"}:"robot_radius"in t&&(t.robot_radius<0||t.robot_radius>3)?{successful:!1,reason:"robot_radius must be between 0 and 3.0"}:"stuck_timeout"in t&&(t.stuck_timeout<0||t.stuck_timeout>30)?{successful:!1,reason:"stuck_timeout must be between 0 and 30"}:"max_recovery_attempts"in t&&(t.max_recovery_attempts<0||t.max_recovery_attempts>10)?{successful:!1,reason:"max_recovery_attempts must be between 0 and 10"}:{successful:!0,reason:""}),this.logInfo("Navigator node started. Waiting for map and goals..."),this.logInfo('Send goals: ros2 action send_goal /navigate_to_pose nav2_msgs/action/NavigateToPose "{pose: {position: {x: 8, y: 8}}}"')}_handleMap(t){this.mapInfo=t.info,this.mapData=t.data,this._updateInflationRadius()}_updateInflationRadius(){if(!this.mapInfo)return;const t=this.getParameter("robot_radius");this._inflationRadiusCells=t>0?Math.ceil(t/this.mapInfo.resolution):0}_handlePose(t){this.currentPose={x:t.x,y:t.y,theta:t.theta}}async _navigateToSinglePose(t,e,s,i){if(!this.mapData||!this.mapInfo)return this.logError("No map available. Start SLAM node first: ros2 run simple_slam slam_node"),{success:!1};const n=this._planPath(this.currentPose.x,this.currentPose.y,t,e);if(!n)return this.logError("Failed to find path to goal. Target may be in an obstacle or unreachable."),{success:!1};this.logInfo(`Path planned with ${n.length} waypoints`),this._publishPath(n),this._visualizePath(n),this.isNavigating=!0;const r=this.getParameter("goal_tolerance");let a=0;const l=Math.max(1,Math.floor(n.length/50));let c=Date.now(),h=1/0,d=0;for(;a<n.length&&this.running;){if(s())return this._stopRobot(),this.logInfo("Navigation cancelled"),this.isNavigating=!1,this._clearPath(),{success:!1};const p=n[a],g=this._distance(this.currentPose,p);if(i&&i({current_pose:{header:{stamp:this.now(),frame_id:"map"},pose:{position:{x:this.currentPose.x,y:this.currentPose.y,z:0},orientation:{x:0,y:0,z:0,w:1}}},distance_remaining:this._pathDistanceFrom(n,a)}),g<r){a+=l,c=Date.now(),h=1/0;continue}const m=this._distance(this.currentPose,{x:t,y:e});m<h-.05&&(h=m,c=Date.now());const f=this.getParameter("stuck_timeout"),_=this.getParameter("max_recovery_attempts");if(this.getParameter("recovery_enabled")&&f>0&&(Date.now()-c)/1e3>f){if(d>=_)return this.logError(`Stuck after ${d} recovery attempts. Aborting navigation.`),this._stopRobot(),this.isNavigating=!1,this._clearPath(),{success:!1};d++,this.logWarn(`Robot appears stuck. Executing recovery behavior (attempt ${d}/${_})`),await this._executeRecovery(d);const S=this._planPath(this.currentPose.x,this.currentPose.y,t,e);if(!S)return this.logError("Re-planning failed after recovery. Aborting navigation."),this._stopRobot(),this.isNavigating=!1,this._clearPath(),{success:!1};n.length=0,n.push(...S),a=0,this._publishPath(n),this._visualizePath(n),c=Date.now(),h=1/0;continue}const v=this._computeControl(this.currentPose,p);this.cmdVelPub.publish(v),await this._sleep(100)}this._stopRobot(),this.isNavigating=!1,this._clearPath();const u=this._distance(this.currentPose,{x:t,y:e});return u<r*2?(this.logInfo(`Goal reached! Final distance: ${u.toFixed(2)}m`),{success:!0}):(this.logWarn(`Navigation ended. Distance to goal: ${u.toFixed(2)}m`),{success:!1})}async _executeNavigate(t,e,s,i){var l,c,h,d,u,p,g,m,f,_;const n=((h=(c=(l=t.pose)==null?void 0:l.pose)==null?void 0:c.position)==null?void 0:h.x)??((u=(d=t.pose)==null?void 0:d.position)==null?void 0:u.x)??0,r=((m=(g=(p=t.pose)==null?void 0:p.pose)==null?void 0:g.position)==null?void 0:m.y)??((_=(f=t.pose)==null?void 0:f.position)==null?void 0:_.y)??0;if(this.logInfo(`Received navigation goal: (${n.toFixed(2)}, ${r.toFixed(2)})`),!(await this._navigateToSinglePose(n,r,i,s)).success)throw new Error("Navigation failed");return{}}async _executeFollowWaypoints(t,e,s,i){var a,l,c,h,d,u;const n=t.poses||[],r=[];if(n.length===0)return this.logWarn("No waypoints provided"),{missed_waypoint_indices:[]};this.logInfo(`Following ${n.length} waypoints`),this._visualizeWaypoints(n);for(let p=0;p<n.length;p++){if(i())return this._stopRobot(),this.logInfo("Waypoint following cancelled"),this._clearWaypoints(),{missed_waypoint_indices:r};const g=n[p],m=((l=(a=g.pose)==null?void 0:a.position)==null?void 0:l.x)??((c=g.position)==null?void 0:c.x)??0,f=((d=(h=g.pose)==null?void 0:h.position)==null?void 0:d.y)??((u=g.position)==null?void 0:u.y)??0;this.logInfo(`Navigating to waypoint ${p+1}/${n.length}: (${m.toFixed(2)}, ${f.toFixed(2)})`),s({current_waypoint:p,number_of_poses:n.length,distance_remaining:this._distance(this.currentPose,{x:m,y:f})}),(await this._navigateToSinglePose(m,f,i,x=>{s({current_waypoint:p,number_of_poses:n.length,distance_remaining:x.distance_remaining})})).success||(this.logWarn(`Missed waypoint ${p} at (${m.toFixed(2)}, ${f.toFixed(2)})`),r.push(p))}return this._clearWaypoints(),this.logInfo(`Waypoint following complete. Missed ${r.length}/${n.length} waypoints`),{missed_waypoint_indices:r}}async _executeRecovery(t){this._publishRecovery(`Recovery attempt ${t}: spinning in place`),this.logInfo(`Recovery attempt ${t}: spinning in place`);const e=Date.now()+2e3;for(;Date.now()<e&&this.running;)this.cmdVelPub.publish({linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:2}}),await this._sleep(100);this._publishRecovery(`Recovery attempt ${t}: backing up`),this.logInfo(`Recovery attempt ${t}: backing up`);const s=Date.now()+500;for(;Date.now()<s&&this.running;)this.cmdVelPub.publish({linear:{x:-.5,y:0,z:0},angular:{x:0,y:0,z:0}}),await this._sleep(100);this._stopRobot(),this._publishRecovery(`Recovery attempt ${t}: complete`),this.logInfo(`Recovery attempt ${t}: complete`)}_publishRecovery(t){this.recoveryPub.publish({data:t})}_visualizeWaypoints(t){const e=t.map(s=>{var i,n,r,a,l,c;return{x:((n=(i=s.pose)==null?void 0:i.position)==null?void 0:n.x)??((r=s.position)==null?void 0:r.x)??0,y:((l=(a=s.pose)==null?void 0:a.position)==null?void 0:l.y)??((c=s.position)==null?void 0:c.y)??0}});window.dispatchEvent(new CustomEvent(b.WAYPOINTS_UPDATE,{detail:{waypoints:e}}))}_clearWaypoints(){window.dispatchEvent(new CustomEvent(b.WAYPOINTS_CLEARED))}_planPath(t,e,s,i){const n=this.getParameter("obstacle_threshold");this._updateInflationRadius();const r=this._inflationRadiusCells,a=this._worldToGrid(t,e),l=this._worldToGrid(s,i);if(!this._isGridFreeInflated(l.gx,l.gy,n,r))return this.logWarn("Goal position is inside an obstacle"),null;const c=(v,S)=>`${v},${S}`,h=c(a.gx,a.gy),d=c(l.gx,l.gy),u=new Ys,p=new Map,g=new Map,m=new Set;p.set(h,0),u.push(this._heuristic(a,l),h);const f=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];let _=0;const x=5e4;for(;!u.isEmpty()&&_<x;){_++;const v=u.pop();if(m.has(v))continue;if(m.add(v),v===d)return this._reconstructPath(g,v);const[S,P]=v.split(",").map(Number);for(const[M,R]of f){const X=S+M,Q=P+R;if(!this._isGridFreeInflated(X,Q,n,r))continue;const F=c(X,Q),It=M!==0&&R!==0?1.414:1,K=p.get(v)+It;if(!p.has(F)||K<p.get(F)){g.set(F,v),p.set(F,K);const Ct=K+this._heuristic({gx:X,gy:Q},l);u.push(Ct,F)}}}return null}_heuristic(t,e){const s=e.gx-t.gx,i=e.gy-t.gy;return Math.sqrt(s*s+i*i)}_isGridFree(t,e,s){if(!this.mapInfo||t<0||t>=this.mapInfo.width||e<0||e>=this.mapInfo.height)return!1;const i=e*this.mapInfo.width+t,n=this.mapData[i];return n>=0&&n<s}_isGridFreeInflated(t,e,s,i){if(i<=0)return this._isGridFree(t,e,s);const n=i*i;for(let r=-i;r<=i;r++)for(let a=-i;a<=i;a++)if(!(r*r+a*a>n)&&!this._isGridFree(t+r,e+a,s))return!1;return!0}_worldToGrid(t,e){const s=Math.floor((t-this.mapInfo.origin.position.x)/this.mapInfo.resolution),i=Math.floor((e-this.mapInfo.origin.position.y)/this.mapInfo.resolution);return{gx:s,gy:i}}_gridToWorld(t,e){const s=t*this.mapInfo.resolution+this.mapInfo.origin.position.x+this.mapInfo.resolution/2,i=e*this.mapInfo.resolution+this.mapInfo.origin.position.y+this.mapInfo.resolution/2;return{x:s,y:i}}_reconstructPath(t,e){const s=[];let i=e;for(;i;){const[n,r]=i.split(",").map(Number);s.unshift(this._gridToWorld(n,r)),i=t.get(i)}return s}_computeControl(t,e){const s=e.x-t.x,i=e.y-t.y,n=Math.sqrt(s*s+i*i);let a=Math.atan2(i,s)-t.theta;for(;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;const l=this.getParameter("max_speed"),c=this.getParameter("max_angular_speed"),h=Math.max(.1,1-Math.abs(a)/Math.PI);let d=Math.min(l,.8*n)*h,u=Math.max(-c,Math.min(c,2.5*a));return{linear:{x:d,y:0,z:0},angular:{x:0,y:0,z:u}}}_stopRobot(){this.cmdVelPub.publish({linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:0}})}_publishPath(t){this.pathPub.publish({header:{stamp:this.now(),frame_id:"map"},poses:t.map(e=>({header:{stamp:this.now(),frame_id:"map"},pose:{position:{x:e.x,y:e.y,z:0},orientation:{x:0,y:0,z:0,w:1}}}))})}_visualizePath(t){window.dispatchEvent(new CustomEvent(b.PATH_PLANNED,{detail:{path:t}}))}_clearPath(){window.dispatchEvent(new CustomEvent(b.PATH_CLEARED))}_distance(t,e){const s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)}_pathDistanceFrom(t,e){let s=0;for(let i=e;i<t.length-1;i++)s+=this._distance(t[i],t[i+1]);return s}_sleep(t){return new Promise(e=>setTimeout(e,t))}onShutdown(){this._stopRobot(),this._clearPath(),this._clearWaypoints(),this.isNavigating=!1}}class Ys{constructor(){this.heap=[]}push(t,e){this.heap.push({priority:t,value:e}),this._bubbleUp(this.heap.length-1)}pop(){if(this.heap.length===0)return null;const t=this.heap[0],e=this.heap.pop();return this.heap.length>0&&(this.heap[0]=e,this._bubbleDown(0)),t.value}isEmpty(){return this.heap.length===0}_bubbleUp(t){for(;t>0;){const e=Math.floor((t-1)/2);if(this.heap[t].priority>=this.heap[e].priority)break;[this.heap[t],this.heap[e]]=[this.heap[e],this.heap[t]],t=e}}_bubbleDown(t){for(;;){let e=t;const s=2*t+1,i=2*t+2;if(s<this.heap.length&&this.heap[s].priority<this.heap[e].priority&&(e=s),i<this.heap.length&&this.heap[i].priority<this.heap[e].priority&&(e=i),e===t)break;[this.heap[t],this.heap[e]]=[this.heap[e],this.heap[t]],t=e}}}C.register("nav2_simple_navigator","navigator_node",Vs);class Xs{constructor(){this.terminalManager=null,this.canvas=null,this.mapCanvas=null,this.graph=null,this.rqtConsole=null,this.layout=null,this.logger=E.getLogger("/ros2_turtle_school")}init(){this.logger.info("Initializing ROS 2 Turtle School..."),this.layout=new qt,this.terminalManager=new Ot({containerId:"terminals-container",tabListId:"terminal-tabs",addButtonId:"add-terminal",onCommand:(e,s)=>mt(e,s)}),this.canvas=new zt("turtle-canvas"),this.mapCanvas=new Ft("map-canvas"),this.graph=new Gt("graph-container"),this.rqtConsole=new Ht,this._setupEventListeners(),this.terminalManager.focus();const t=this.terminalManager.getActiveTerminal();t&&(t.writeln(""),t.writeln("\x1B[32m\x1B[0m"),t.writeln("\x1B[32m                    ROS 2 Turtle School                       \x1B[0m"),t.writeln("\x1B[32m\x1B[0m"),t.writeln(""),t.writeln("Welcome! This is a browser-based ROS2 CLI emulator."),t.writeln("Try these commands to get started:"),t.writeln(""),t.writeln("  \x1B[33mros2 run turtlesim turtlesim_node\x1B[0m  - Start turtlesim"),t.writeln("  \x1B[33mros2 topic list\x1B[0m                   - List topics"),t.writeln("  \x1B[33mros2 node list\x1B[0m                    - List nodes"),t.writeln("  \x1B[33mhelp\x1B[0m                              - Show all commands"),t.writeln(""),t.writeln("Use the \x1B[36m+\x1B[0m button to add more terminal panes."),t.writeln("Press \x1B[36mCtrl+C\x1B[0m to stop running commands."),t.writeln(""),t.finishCommand()),this.logger.info("ROS 2 Turtle School initialized")}_setupEventListeners(){const t=document.getElementById("toggle-graph");t==null||t.addEventListener("click",()=>{this.graph.toggle()});const e=document.getElementById("toggle-map");e==null||e.addEventListener("click",()=>{this.layout.toggleMap()});const s=document.getElementById("toggle-console");s==null||s.addEventListener("click",()=>{this.rqtConsole.toggle()});const i=document.getElementById("show-help");i==null||i.addEventListener("click",()=>{this._showHelpModal()}),this._setupObstacleButtons(),this._setupMapOverlayButtons();const n=document.getElementById("toggle-costmap");n==null||n.addEventListener("click",()=>{const h=this.canvas.toggleCostmap();n.classList.toggle("active",h)});const r=document.getElementById("toggle-map-quality");r==null||r.addEventListener("click",()=>{const h=this.canvas.toggleMapQuality();r.classList.toggle("active",h)}),window.addEventListener(b.TOGGLE_GRAPH,()=>{this.graph.toggle()}),window.addEventListener(b.TOGGLE_CONSOLE,()=>{this.rqtConsole.toggle()}),window.addEventListener(b.SHOW_MAP,()=>{this.layout.showMap()}),window.addEventListener(b.OPEN_RQT_MODAL,()=>{this._showRqtModal()}),document.querySelectorAll("#quick-commands button").forEach(h=>{h.addEventListener("click",()=>{const d=h.dataset.cmd;if(d){const u=this.terminalManager.getActiveTerminal();u&&(u.writeln(d),mt(d,u))}})}),window.addEventListener(b.TELEOP_ACTIVE,h=>{const{type:d}=h.detail;this._showTeleopHint(d)}),window.addEventListener(b.TELEOP_INACTIVE,()=>{this._hideTeleopHint()});const l=document.getElementById("modal-overlay"),c=document.getElementById("modal-close");l==null||l.addEventListener("click",h=>{h.target===l&&l.classList.add("hidden")}),c==null||c.addEventListener("click",()=>{l==null||l.classList.add("hidden")})}_setupObstacleButtons(){const t=document.getElementById("randomize-obstacles"),e=document.getElementById("add-obstacle-mode"),s=document.getElementById("delete-obstacle-mode"),i=document.getElementById("clear-obstacles"),n=document.getElementById("reset-obstacles");t==null||t.addEventListener("click",()=>{this.canvas.randomizeObstacles(5)}),e==null||e.addEventListener("click",()=>{const a=this.canvas.getEditMode()==="add"?"none":"add";this.canvas.setEditMode(a),this._updateObstacleButtons(a)}),s==null||s.addEventListener("click",()=>{const a=this.canvas.getEditMode()==="delete"?"none":"delete";this.canvas.setEditMode(a),this._updateObstacleButtons(a)}),i==null||i.addEventListener("click",()=>{this.canvas.clearObstacles()}),n==null||n.addEventListener("click",()=>{this.canvas.resetObstacles()}),window.addEventListener(b.CANVAS_EDIT_MODE_CHANGED,r=>{this._updateObstacleButtons(r.detail.mode)})}_updateObstacleButtons(t){const e=document.getElementById("add-obstacle-mode"),s=document.getElementById("delete-obstacle-mode");e==null||e.classList.toggle("active",t==="add"),s==null||s.classList.toggle("active",t==="delete")}_setupMapOverlayButtons(){const t=document.getElementById("toggle-map-overlay"),e=document.getElementById("map-opacity-control"),s=document.getElementById("map-opacity-slider"),i=document.getElementById("map-opacity-value");t==null||t.addEventListener("click",()=>{const n=this.canvas.toggleMap();t.classList.toggle("active",n),e==null||e.classList.toggle("hidden",!n)}),s==null||s.addEventListener("input",n=>{const r=parseInt(n.target.value,10)/100;this.canvas.setMapOpacity(r),i&&(i.textContent=`${n.target.value}%`)}),window.addEventListener(b.TOGGLE_MAP_OVERLAY,()=>{const n=this.canvas.toggleMap();t==null||t.classList.toggle("active",n),e==null||e.classList.toggle("hidden",!n)})}_showRqtModal(){const t=document.getElementById("modal-overlay"),e=document.getElementById("modal-title"),s=document.getElementById("modal-body");!t||!s||(e.textContent="rqt - ROS2 Tools",s.innerHTML=`
      <div class="rqt-tools">
        <button class="rqt-tool-btn" data-tool="graph">
          <span class="icon"></span>
          <span class="label">Node Graph</span>
          <span class="desc">Visualize nodes and topics</span>
        </button>
        <button class="rqt-tool-btn" data-tool="console">
          <span class="icon"></span>
          <span class="label">Console</span>
          <span class="desc">View log messages</span>
        </button>
      </div>
    `,s.querySelectorAll(".rqt-tool-btn").forEach(i=>{i.addEventListener("click",()=>{const n=i.dataset.tool;t.classList.add("hidden"),n==="graph"?this.graph.toggle():n==="console"&&this.rqtConsole.toggle()})}),t.classList.remove("hidden"))}_showHelpModal(){const t=document.getElementById("modal-overlay");Vt.show(t)}_showTeleopHint(t){let e=document.getElementById("teleop-hint");e||(e=document.createElement("div"),e.id="teleop-hint",document.body.appendChild(e)),t==="arrow-keys"?e.innerHTML="Use <kbd></kbd> <kbd></kbd> <kbd></kbd> <kbd></kbd> to control turtle":t==="wasd-keys"&&(e.innerHTML="Use <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> to move, <kbd>Q</kbd><kbd>E</kbd> to rotate"),e.classList.add("visible")}_hideTeleopHint(){const t=document.getElementById("teleop-hint");t&&t.classList.remove("visible")}destroy(){var t,e,s;k.killAll(),w.reset(),(t=this.terminalManager)==null||t.destroy(),(e=this.graph)==null||e.destroy(),(s=this.rqtConsole)==null||s.destroy()}}document.addEventListener("DOMContentLoaded",()=>{new Xs().init()});
//# sourceMappingURL=index-C8TFygEN.js.map
