import{r as mt,a as ft}from"./vendor-xterm-DgJRGhIz.js";import{c as pt}from"./vendor-cytoscape-BQaXIfA_.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();var gt=mt(),wt=ft();const g={TURTLESIM_UPDATE:"turtlesim-update",LIDAR_UPDATE:"lidar-update",MAP_UPDATE:"map-update",ROBOT_POSE_UPDATE:"robot-pose-update",SHOW_MAP:"show-map",TOGGLE_MAP_OVERLAY:"toggle-map-overlay",PROCESS_STARTED:"process-started",PROCESS_STOPPED:"process-stopped",WORLD_STATE_CHANGED:"world-state-changed",LAYOUT_RESIZE:"layout-resize",TELEOP_ACTIVE:"teleop-active",TELEOP_INACTIVE:"teleop-inactive",TOGGLE_GRAPH:"toggle-graph",TOGGLE_CONSOLE:"toggle-console",CANVAS_EDIT_MODE_CHANGED:"canvas-edit-mode-changed",OPEN_RQT_MODAL:"open-rqt-modal"};class bt{constructor(t,e={}){this.container=t,this.id=e.id||`term_${Date.now()}`,this.onCommand=e.onCommand||(()=>{}),this.onInterrupt=e.onInterrupt||(()=>{}),this.history=[],this.historyIndex=-1,this.maxHistory=100,this.currentLine="",this.cursorPosition=0,this.prompt="ros2@sim:~$ ",this.isProcessing=!1,this.waitingForInput=!1,this.focused=!1,this.teleopActive=!1,this.teleopType=null,this.activeSubscriptions=[],this.activeBagRecorders=[],this._initTerminal()}_initTerminal(){this.xterm=new gt.Terminal({theme:{background:"#1e1e1e",foreground:"#d4d4d4",cursor:"#ffffff",cursorAccent:"#1e1e1e",selection:"rgba(255, 255, 255, 0.3)",black:"#000000",red:"#cd3131",green:"#0dbc79",yellow:"#e5e510",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5",brightBlack:"#666666",brightRed:"#f14c4c",brightGreen:"#23d18b",brightYellow:"#f5f543",brightBlue:"#3b8eea",brightMagenta:"#d670d6",brightCyan:"#29b8db",brightWhite:"#ffffff"},fontFamily:'Menlo, Monaco, "Courier New", monospace',fontSize:14,lineHeight:1.2,cursorBlink:!0,cursorStyle:"block",scrollback:1e3,allowTransparency:!0}),this.fitAddon=new wt.FitAddon,this.xterm.loadAddon(this.fitAddon),this.xterm.open(this.container),this.fit(),this.xterm.onData(this._handleInput.bind(this)),this.container.addEventListener("focus",()=>{this.focused=!0},!0),this.container.addEventListener("blur",()=>{this.focused=!1},!0),this.container.addEventListener("mousedown",()=>{this.xterm.focus()}),this._setupContextMenu(),this.writePrompt(),this._setupTeleopListeners()}_setupTeleopListeners(){window.addEventListener(g.TELEOP_ACTIVE,t=>{var e;this.teleopActive=!0,this.teleopType=((e=t.detail)==null?void 0:e.type)||"wasd-keys"}),window.addEventListener(g.TELEOP_INACTIVE,()=>{this.teleopActive=!1,this.teleopType=null})}_setupContextMenu(){this.contextMenu=document.createElement("div"),this.contextMenu.className="terminal-context-menu",this.contextMenu.innerHTML=`
      <button class="context-menu-item" data-action="copy">Copy</button>
      <button class="context-menu-item" data-action="paste">Paste</button>
      <button class="context-menu-item" data-action="clear">Clear</button>
    `,this.contextMenu.style.display="none",document.body.appendChild(this.contextMenu),this.container.addEventListener("contextmenu",t=>{t.preventDefault(),this._showContextMenu(t.clientX,t.clientY)}),this.contextMenu.addEventListener("click",async t=>{const e=t.target.dataset.action;if(e)switch(this._hideContextMenu(),e){case"copy":await this._handleCopy();break;case"paste":await this._handlePaste();break;case"clear":this.clear(),this.writePrompt(),this._refreshLine();break}}),document.addEventListener("click",t=>{this.contextMenu.contains(t.target)||this._hideContextMenu()}),document.addEventListener("scroll",()=>{this._hideContextMenu()},!0)}_showContextMenu(t,e){this.contextMenu.style.display="block",this.contextMenu.style.left=`${t}px`,this.contextMenu.style.top=`${e}px`;const s=this.contextMenu.getBoundingClientRect();s.right>window.innerWidth&&(this.contextMenu.style.left=`${window.innerWidth-s.width-5}px`),s.bottom>window.innerHeight&&(this.contextMenu.style.top=`${window.innerHeight-s.height-5}px`)}_hideContextMenu(){this.contextMenu.style.display="none"}async _handleCopy(){const t=this.xterm.getSelection();if(t)try{await navigator.clipboard.writeText(t)}catch(e){console.error("Failed to copy:",e)}}async _handlePaste(){try{const t=await navigator.clipboard.readText();if(t)for(const e of t)e===`
`||e==="\r"||this._insertChar(e)}catch(t){console.error("Failed to paste:",t)}}_forwardKeyToWindow(t,e){const s=new KeyboardEvent("keydown",{key:t,code:e,bubbles:!0,cancelable:!0});window.dispatchEvent(s),setTimeout(()=>{const i=new KeyboardEvent("keyup",{key:t,code:e,bubbles:!0,cancelable:!0});window.dispatchEvent(i)},50)}_handleInput(t){for(let e=0;e<t.length;e++){const s=t.charCodeAt(e);if(s===3){this._handleInterrupt();continue}if(s!==4){if(s===12){this.clear(),this.writePrompt(),this._refreshLine();continue}if(s===13){this._handleEnter();continue}if(s===127||s===8){this._handleBackspace();continue}if(s===9){this._handleTab();continue}if(s===27){if(e+2<t.length&&t.charCodeAt(e+1)===91){const i=t.charCodeAt(e+2);if(i===65){if(this.teleopActive&&this.teleopType==="arrow-keys"){this._forwardKeyToWindow("ArrowUp","ArrowUp"),e+=2;continue}this._historyUp(),e+=2;continue}if(i===66){if(this.teleopActive&&this.teleopType==="arrow-keys"){this._forwardKeyToWindow("ArrowDown","ArrowDown"),e+=2;continue}this._historyDown(),e+=2;continue}if(i===67){if(this.teleopActive&&this.teleopType==="arrow-keys"){this._forwardKeyToWindow("ArrowRight","ArrowRight"),e+=2;continue}this._cursorRight(),e+=2;continue}if(i===68){if(this.teleopActive&&this.teleopType==="arrow-keys"){this._forwardKeyToWindow("ArrowLeft","ArrowLeft"),e+=2;continue}this._cursorLeft(),e+=2;continue}if(i===72){this._cursorHome(),e+=2;continue}if(i===70){this._cursorEnd(),e+=2;continue}if(i===51&&e+3<t.length&&t.charCodeAt(e+3)===126){this._handleDelete(),e+=3;continue}}continue}if(s>=32&&s<127){if(this.teleopActive&&this.teleopType==="wasd-keys"){const i=t[e].toUpperCase();if("WASDQE".includes(i)){this._forwardKeyToWindow(i,`Key${i}`);continue}}this._insertChar(t[e])}}}}_insertChar(t){this.isProcessing||(this.currentLine=this.currentLine.slice(0,this.cursorPosition)+t+this.currentLine.slice(this.cursorPosition),this.cursorPosition++,this._refreshLine())}_handleBackspace(){this.isProcessing||this.cursorPosition!==0&&(this.currentLine=this.currentLine.slice(0,this.cursorPosition-1)+this.currentLine.slice(this.cursorPosition),this.cursorPosition--,this._refreshLine())}_handleDelete(){this.isProcessing||this.cursorPosition>=this.currentLine.length||(this.currentLine=this.currentLine.slice(0,this.cursorPosition)+this.currentLine.slice(this.cursorPosition+1),this._refreshLine())}_handleEnter(){if(this.isProcessing)return;this.xterm.write(`\r
`);const t=this.currentLine.trim();this.currentLine="",this.cursorPosition=0,t?(this.history[this.history.length-1]!==t&&(this.history.push(t),this.history.length>this.maxHistory&&this.history.shift()),this.historyIndex=this.history.length,this.isProcessing=!0,this.onCommand(t,this)):this.writePrompt()}_handleInterrupt(){for(const t of this.activeSubscriptions)t.destroy&&t.destroy();this.activeSubscriptions=[];for(const t of this.activeBagRecorders)t.stop&&t.stop();this.activeBagRecorders=[],this.onInterrupt(this),this.xterm.write(`^C\r
`),this.currentLine="",this.cursorPosition=0,this.isProcessing=!1,this.writePrompt()}_handleTab(){this._insertChar(" "),this._insertChar(" ")}_historyUp(){this.isProcessing||this.historyIndex<=0||(this.historyIndex--,this.currentLine=this.history[this.historyIndex],this.cursorPosition=this.currentLine.length,this._refreshLine())}_historyDown(){if(!this.isProcessing){if(this.historyIndex>=this.history.length-1){this.historyIndex=this.history.length,this.currentLine="",this.cursorPosition=0,this._refreshLine();return}this.historyIndex++,this.currentLine=this.history[this.historyIndex],this.cursorPosition=this.currentLine.length,this._refreshLine()}}_cursorLeft(){this.cursorPosition>0&&(this.cursorPosition--,this.xterm.write("\x1B[D"))}_cursorRight(){this.cursorPosition<this.currentLine.length&&(this.cursorPosition++,this.xterm.write("\x1B[C"))}_cursorHome(){for(;this.cursorPosition>0;)this.cursorPosition--,this.xterm.write("\x1B[D")}_cursorEnd(){for(;this.cursorPosition<this.currentLine.length;)this.cursorPosition++,this.xterm.write("\x1B[C")}_refreshLine(){this.prompt.length,this.xterm.write("\r"),this.xterm.write("\x1B[K"),this.xterm.write(this.prompt+this.currentLine);const t=this.currentLine.length-this.cursorPosition;t>0&&this.xterm.write(`\x1B[${t}D`)}write(t){this.xterm.write(t)}writeln(t){this.xterm.write(t+`\r
`)}writePrompt(){this.xterm.write(this.prompt)}setPrompt(t){this.prompt=t}finishCommand(){this.isProcessing=!1,this.writePrompt()}clear(){this.xterm.clear()}fit(){try{this.fitAddon.fit()}catch{}}focus(){this.xterm.focus()}addSubscription(t){this.activeSubscriptions.push(t)}removeSubscription(t){const e=this.activeSubscriptions.indexOf(t);e>=0&&this.activeSubscriptions.splice(e,1)}addBagRecorder(t){this.activeBagRecorders.push(t)}removeBagRecorder(t){const e=this.activeBagRecorders.indexOf(t);e>=0&&this.activeBagRecorders.splice(e,1)}destroy(){for(const t of this.activeSubscriptions)t.destroy&&t.destroy();this.activeSubscriptions=[];for(const t of this.activeBagRecorders)t.stop&&t.stop();this.activeBagRecorders=[],this.contextMenu&&this.contextMenu.parentNode&&this.contextMenu.parentNode.removeChild(this.contextMenu),this.xterm.dispose()}}class yt{constructor(){this._services=new Map}register(t,e){this._services.set(t,e)}get(t){return this._services.get(t)}has(t){return this._services.has(t)}reset(){this._services.clear()}getServiceNames(){return Array.from(this._services.keys())}}const D=new yt,P={DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4};class vt{constructor(){this.logs=[],this.maxLogs=1e3,this.listeners=[],this.defaultLevel=P.INFO,this.nodeLevels=new Map,this.paused=!1}getLogger(t){return{debug:e=>this._log(t,"DEBUG",e),info:e=>this._log(t,"INFO",e),warn:e=>this._log(t,"WARN",e),error:e=>this._log(t,"ERROR",e),fatal:e=>this._log(t,"FATAL",e)}}_log(t,e,s){const i=P[e],r=this.nodeLevels.get(t)??this.defaultLevel;if(i<r)return;const o={timestamp:Date.now(),node:t,level:e,levelValue:i,message:s};this.logs.push(o),this.logs.length>this.maxLogs&&this.logs.shift();const a=`[${t}] [${e}]: ${s}`;switch(e){case"DEBUG":console.debug(a);break;case"INFO":console.info(a);break;case"WARN":console.warn(a);break;case"ERROR":case"FATAL":console.error(a);break}if(!this.paused)for(const l of this.listeners)try{l(o)}catch(c){console.error("Error in log listener:",c)}}setNodeLevel(t,e){const s=P[e.toUpperCase()];s!==void 0&&this.nodeLevels.set(t,s)}setDefaultLevel(t){const e=P[t.toUpperCase()];e!==void 0&&(this.defaultLevel=e)}addListener(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>=0&&this.listeners.splice(e,1)}}getLogs(t={}){let e=[...this.logs];if(t.level){const s=P[t.level.toUpperCase()]??0;e=e.filter(i=>i.levelValue>=s)}return t.node&&(e=e.filter(s=>s.node.includes(t.node))),t.since&&(e=e.filter(s=>s.timestamp>=t.since)),e}clear(){this.logs=[]}pause(){this.paused=!0}resume(){this.paused=!1}formatEntry(t){const s=new Date(t.timestamp).toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),i=String(t.timestamp%1e3).padStart(3,"0");return`[${s}.${i}] [${t.node}] [${t.level}]: ${t.message}`}getLevels(){return Object.keys(P)}parseLevel(t){return P[t.toUpperCase()]}}const S=new vt;D.register("logManager",S);class _t{constructor(){this.processes=new Map,this.nextProcessId=1,this.logger=S.getLogger("/process_manager")}spawn(t,e,s,i){const r=`proc_${this.nextProcessId++}`;return this.processes.set(r,{node:t,terminalId:e,package:s,executable:i,startTime:Date.now()}),t.start(),this.logger.info(`Spawned ${s}/${i} as ${t.fullName} (pid: ${r})`),window.dispatchEvent(new CustomEvent(g.PROCESS_STARTED,{detail:{processId:r,terminalId:e,nodeName:t.fullName}})),r}kill(t){const e=this.processes.get(t);if(!e)return!1;const s=e.terminalId,i=e.node.fullName;return e.node.destroy(),this.processes.delete(t),this.logger.info(`Killed process ${t}`),window.dispatchEvent(new CustomEvent(g.PROCESS_STOPPED,{detail:{processId:t,terminalId:s,nodeName:i}})),!0}killByNodeName(t){for(const[e,s]of this.processes)if(s.node.fullName===t)return this.kill(e);return!1}killByTerminal(t){let e=0;const s=[];for(const[i,r]of this.processes)r.terminalId===t&&s.push(i);for(const i of s)this.kill(i)&&e++;return e}getProcess(t){return this.processes.get(t)||null}getProcessByNodeName(t){for(const[e,s]of this.processes)if(s.node.fullName===t)return{processId:e,...s};return null}getProcessesByTerminal(t){const e=[];for(const[s,i]of this.processes)i.terminalId===t&&e.push({processId:s,...i});return e}getAllProcesses(){const t=[];for(const[e,s]of this.processes)t.push({processId:e,...s});return t}isNodeRunning(t){for(const[,e]of this.processes)if(e.node.fullName===t)return!0;return!1}getProcessCount(){return this.processes.size}killAll(){const t=Array.from(this.processes.keys());for(const e of t)this.kill(e)}}const I=new _t;D.register("processManager",I);class xt{constructor(t={}){this.containerId=t.containerId||"terminals-container",this.tabListId=t.tabListId||"terminal-tabs",this.addButtonId=t.addButtonId||"add-terminal",this.maxTerminals=t.maxTerminals||4,this.onCommand=t.onCommand||(()=>{}),this.terminals=new Map,this.activeTerminalId=null,this.nextTerminalNum=1,this.container=document.getElementById(this.containerId),this.tabList=document.querySelector(`#${this.tabListId} .tab-list`),this.addButton=document.getElementById(this.addButtonId),this._setupEventListeners(),this._addTerminal()}_setupEventListeners(){var t;(t=this.addButton)==null||t.addEventListener("click",()=>{this._addTerminal()}),window.addEventListener("resize",()=>{this._resizeAll()}),window.addEventListener(g.LAYOUT_RESIZE,()=>{setTimeout(()=>this._resizeAll(),100)}),window.addEventListener(g.PROCESS_STARTED,e=>{const{terminalId:s}=e.detail||{};s&&this._updateTabIndicator(s,!0)}),window.addEventListener(g.PROCESS_STOPPED,e=>{const{terminalId:s}=e.detail||{};s&&this._updateTabIndicator(s,!1)})}_updateTabIndicator(t,e){const s=this.terminals.get(t);if(!s)return;const i=s.tab.querySelector(".tab-status");i&&i.classList.toggle("running",e)}_addTerminal(){if(this.terminals.size>=this.maxTerminals)return null;const t=`terminal_${this.nextTerminalNum++}`,e=this.terminals.size+1,s=document.createElement("div");s.id=t,s.className="terminal-pane",this.container.appendChild(s);const i=document.createElement("div");i.className="terminal-tab",i.dataset.termId=t,i.setAttribute("role","tab"),i.setAttribute("aria-selected","false"),i.innerHTML=`
      <span class="tab-status" aria-hidden="true"></span>
      <span class="tab-title">Terminal ${e}</span>
      <button class="tab-close" aria-label="Close terminal ${e}">&times;</button>
    `,this.tabList.appendChild(i),i.addEventListener("click",o=>{o.target.classList.contains("tab-close")||this._activateTerminal(t)}),i.querySelector(".tab-close").addEventListener("click",o=>{o.stopPropagation(),this._removeTerminal(t)});const r=new bt(s,{id:t,onCommand:(o,a)=>this.onCommand(o,a),onInterrupt:o=>this._handleInterrupt(o)});return this.terminals.set(t,{terminal:r,tab:i,container:s}),this._activateTerminal(t),this._updateAddButton(),r}_removeTerminal(t){const e=this.terminals.get(t);if(e&&!(this.terminals.size<=1)){if(I.killByTerminal(t),e.terminal.destroy(),e.container.remove(),e.tab.remove(),this.terminals.delete(t),this.activeTerminalId===t){const s=this.terminals.keys().next().value;s&&this._activateTerminal(s)}this._renumberTabs(),this._updateAddButton()}}_activateTerminal(t){const e=this.terminals.get(t);if(e){if(this.activeTerminalId&&this.activeTerminalId!==t){const s=this.terminals.get(this.activeTerminalId);s&&(s.tab.classList.remove("active"),s.tab.setAttribute("aria-selected","false"),s.container.classList.remove("active"))}e.tab.classList.add("active"),e.tab.setAttribute("aria-selected","true"),e.container.classList.add("active"),this.activeTerminalId=t,setTimeout(()=>{e.terminal.focus(),e.terminal.fit()},0)}}_handleInterrupt(t){I.killByTerminal(t.id)}_renumberTabs(){let t=1;for(const[,e]of this.terminals){const s=e.tab.querySelector(".tab-title");s&&(s.textContent=`Terminal ${t}`),t++}}_updateAddButton(){this.addButton&&(this.addButton.style.display=this.terminals.size>=this.maxTerminals?"none":"block")}_resizeAll(){for(const[,t]of this.terminals)t.terminal.fit()}getActiveTerminal(){if(!this.activeTerminalId)return null;const t=this.terminals.get(this.activeTerminalId);return(t==null?void 0:t.terminal)||null}getTerminal(t){var e;return((e=this.terminals.get(t))==null?void 0:e.terminal)||null}getAllTerminals(){return Array.from(this.terminals.values()).map(t=>t.terminal)}getTerminalCount(){return this.terminals.size}clearAll(){for(const[,t]of this.terminals)t.terminal.clear(),t.terminal.writePrompt()}focus(){const t=this.getActiveTerminal();t&&t.focus()}destroy(){for(const[t]of this.terminals){const e=this.terminals.get(t);e&&(I.killByTerminal(t),e.terminal.destroy())}this.terminals.clear(),this.container.innerHTML="",this.tabList.innerHTML=""}}class Tt{constructor(){this.width=11,this.height=11,this.obstacles=[],this.turtles=new Map,this.onChangeCallback=null,this._initDefaultObstacles()}setOnChangeCallback(t){this.onChangeCallback=t}_initDefaultObstacles(){this.obstacles=[{type:"wall",x:0,y:0,width:11,height:.1},{type:"wall",x:0,y:10.9,width:11,height:.1},{type:"wall",x:0,y:0,width:.1,height:11},{type:"wall",x:10.9,y:0,width:.1,height:11},{type:"box",x:3,y:3,width:1.5,height:1.5},{type:"box",x:7,y:2,width:1,height:2},{type:"box",x:2,y:7,width:2,height:1},{type:"box",x:6,y:6,width:1.5,height:1.5},{type:"box",x:8,y:8,width:1,height:1}]}addObstacle(t){this.obstacles.push(t)}removeObstacle(t){t>=0&&t<this.obstacles.length&&this.obstacles.splice(t,1)}clearObstacles(){this.obstacles=[]}resetObstacles(){this._initDefaultObstacles(),this._notifyChange()}randomizeObstacles(t=5,e={}){const{minSize:s=.5,maxSize:i=2,keepWalls:r=!0,margin:o=1.5}=e;r?this.obstacles=this.obstacles.filter(a=>a.type==="wall"):this.obstacles=[];for(let a=0;a<t;a++){const l=s+Math.random()*(i-s),c=s+Math.random()*(i-s);let h,d,u=0;const m=50;do h=.5+Math.random()*(this.width-l-1),d=.5+Math.random()*(this.height-c-1),u++;while(u<m&&(this._obstacleOverlaps(h,d,l,c)||this._tooCloseToCenter(h,d,l,c,o)));u<m&&this.obstacles.push({type:"box",x:h,y:d,width:l,height:c})}this._notifyChange()}_obstacleOverlaps(t,e,s,i,r=.3){for(const o of this.obstacles){if(o.type==="wall")continue;const a=t<o.x+o.width+r&&t+s+r>o.x,l=e<o.y+o.height+r&&e+i+r>o.y;if(a&&l)return!0}return!1}_tooCloseToCenter(t,e,s,i,r){const o=this.width/2,a=this.height/2,l=Math.max(t,Math.min(o,t+s)),c=Math.max(e,Math.min(a,e+i)),h=o-l,d=a-c;return Math.sqrt(h*h+d*d)<r}findObstacleAt(t,e){for(let s=this.obstacles.length-1;s>=0;s--){const i=this.obstacles[s];if(i.type!=="wall"&&t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height)return s}return-1}addObstacleAt(t,e,s=1,i=1){const r={type:"box",x:t-s/2,y:e-i/2,width:s,height:i};return r.x=Math.max(.2,Math.min(this.width-s-.2,r.x)),r.y=Math.max(.2,Math.min(this.height-i-.2,r.y)),this.obstacles.push(r),this._notifyChange(),this.obstacles.length-1}removeObstacleAt(t,e){const s=this.findObstacleAt(t,e);return s>=0?(this.obstacles.splice(s,1),this._notifyChange(),!0):!1}clearNonWallObstacles(){this.obstacles=this.obstacles.filter(t=>t.type==="wall"),this._notifyChange()}_notifyChange(){this.onChangeCallback?this.onChangeCallback():window.dispatchEvent(new CustomEvent(g.WORLD_STATE_CHANGED))}getObstacleCount(){return this.obstacles.filter(t=>t.type!=="wall").length}registerTurtle(t,e,s,i){this.turtles.set(t,{x:e,y:s,theta:i})}updateTurtle(t,e,s,i){this.turtles.has(t)&&this.turtles.set(t,{x:e,y:s,theta:i})}removeTurtle(t){this.turtles.delete(t)}getTurtle(t){return this.turtles.get(t)}checkCollision(t,e,s=.2){if(t-s<0||t+s>this.width||e-s<0||e+s>this.height)return!0;for(const i of this.obstacles)if(this._circleRectCollision(t,e,s,i.x,i.y,i.width,i.height))return!0;return!1}_circleRectCollision(t,e,s,i,r,o,a){const l=Math.max(i,Math.min(t,i+o)),c=Math.max(r,Math.min(e,r+a)),h=t-l,d=e-c;return h*h+d*d<s*s}raycast(t,e,s,i=10){const r=Math.cos(s),o=Math.sin(s);let a=null,l=i;for(const h of this.obstacles){const d=this._rayRectIntersection(t,e,r,o,h.x,h.y,h.width,h.height);d&&d.distance<l&&(l=d.distance,a=d)}const c=[this._rayLineIntersection(t,e,r,o,0,0,this.width,0),this._rayLineIntersection(t,e,r,o,0,this.height,this.width,this.height),this._rayLineIntersection(t,e,r,o,0,0,0,this.height),this._rayLineIntersection(t,e,r,o,this.width,0,this.width,this.height)];for(const h of c)h&&h.distance>0&&h.distance<l&&(l=h.distance,a=h);return a?{hit:!0,distance:l,point:a.point}:{hit:!1,distance:i,point:{x:t+r*i,y:e+o*i}}}_rayRectIntersection(t,e,s,i,r,o,a,l){const c=[{x1:r,y1:o,x2:r+a,y2:o},{x1:r,y1:o+l,x2:r+a,y2:o+l},{x1:r,y1:o,x2:r,y2:o+l},{x1:r+a,y1:o,x2:r+a,y2:o+l}];let h=null,d=1/0;for(const u of c){const m=this._rayLineIntersection(t,e,s,i,u.x1,u.y1,u.x2,u.y2);m&&m.distance>.001&&m.distance<d&&(d=m.distance,h=m)}return h}_rayLineIntersection(t,e,s,i,r,o,a,l){const c=a-r,h=l-o,d=s*h-i*c;if(Math.abs(d)<1e-4)return null;const u=((r-t)*h-(o-e)*c)/d,m=((r-t)*i-(o-e)*s)/d;return u>0&&m>=0&&m<=1?{distance:u,point:{x:t+s*u,y:e+i*u}}:null}lidarScan(t,e,s,i={}){const{angleMin:r=-Math.PI,angleMax:o=Math.PI,angleIncrement:a=Math.PI/180,rangeMin:l=.1,rangeMax:c=10,numRays:h=360}=i,d=[],u=[],m=(o-r)/h;for(let b=0;b<h;b++){const y=s+r+b*m,v=this.raycast(t,e,y,c);v.hit&&v.distance>=l?(d.push(v.distance),u.push(1)):(v.distance<l,d.push(1/0),u.push(0))}return{angle_min:r,angle_max:o,angle_increment:m,time_increment:0,scan_time:.1,range_min:l,range_max:c,ranges:d,intensities:u}}getObstacles(){return this.obstacles}}const _=new Tt;D.register("worldState",_);class St{constructor(t="turtle-canvas"){typeof t=="string"?this.canvas=document.getElementById(t):this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.worldWidth=11,this.worldHeight=11,this.turtleImage=new Image,this.turtleImageLoaded=!1,this._loadTurtleImage(),this.showObstacles=!0,this.showLidar=!1,this.showTF=!1,this.showMap=!1,this.mapOpacity=.5,this.mapData=null,this.mapInfo=null,this.mapCanvas=null,this._resizeScheduled=!1,this.editMode="none",this.newObstacleSize=1,this.turtles=[],this.trails=[],this.background={r:69,g:86,b:255},this.lidarData=null,this.hasTurtlesim=!1,this._setupEventListeners(),this._setupClickHandlers(),this._render()}_loadTurtleImage(){const t=`
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
        <!-- Shell -->
        <ellipse cx="24" cy="24" rx="16" ry="14" fill="#228B22" stroke="#006400" stroke-width="2"/>
        <!-- Shell pattern -->
        <path d="M24 10 L24 38" stroke="#006400" stroke-width="1"/>
        <path d="M12 24 L36 24" stroke="#006400" stroke-width="1"/>
        <path d="M16 14 L32 34" stroke="#006400" stroke-width="1"/>
        <path d="M32 14 L16 34" stroke="#006400" stroke-width="1"/>
        <!-- Head -->
        <circle cx="40" cy="24" r="6" fill="#90EE90" stroke="#228B22" stroke-width="1.5"/>
        <!-- Eyes -->
        <circle cx="42" cy="22" r="1.5" fill="#000"/>
        <circle cx="42" cy="26" r="1.5" fill="#000"/>
        <!-- Legs -->
        <ellipse cx="14" cy="12" rx="5" ry="4" fill="#90EE90" stroke="#228B22" stroke-width="1"/>
        <ellipse cx="14" cy="36" rx="5" ry="4" fill="#90EE90" stroke="#228B22" stroke-width="1"/>
        <ellipse cx="30" cy="12" rx="5" ry="4" fill="#90EE90" stroke="#228B22" stroke-width="1"/>
        <ellipse cx="30" cy="36" rx="5" ry="4" fill="#90EE90" stroke="#228B22" stroke-width="1"/>
        <!-- Tail -->
        <path d="M6 24 Q2 24 4 22" stroke="#90EE90" stroke-width="3" fill="none"/>
      </svg>
    `,e=new Blob([t],{type:"image/svg+xml"}),s=URL.createObjectURL(e);this.turtleImage.onload=()=>{this.turtleImageLoaded=!0,URL.revokeObjectURL(s),this._render()},this.turtleImage.src=s}_setupEventListeners(){window.addEventListener(g.TURTLESIM_UPDATE,t=>{const{turtles:e,trails:s,background:i}=t.detail;this.turtles=e,this.trails=s,this.background=i,this.hasTurtlesim=e&&e.length>0,this._render()}),window.addEventListener(g.LIDAR_UPDATE,t=>{this.lidarData=t.detail,this.showLidar&&this._render()}),window.addEventListener(g.MAP_UPDATE,t=>{const{map:e,info:s}=t.detail;this.mapData=e,this.mapInfo=s,this._updateMapCanvas(),this.showMap&&this._render()}),window.addEventListener("resize",()=>this._handleResize()),window.addEventListener(g.LAYOUT_RESIZE,()=>this._handleResize()),window.addEventListener(g.WORLD_STATE_CHANGED,()=>this._render()),this._handleResize()}_setupClickHandlers(){this.canvas.addEventListener("click",t=>{if(this.editMode==="none")return;const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,r=this._canvasToWorld(s,i);this.editMode==="add"?_.addObstacleAt(r.x,r.y,this.newObstacleSize,this.newObstacleSize):this.editMode==="delete"&&_.removeObstacleAt(r.x,r.y)}),this.canvas.addEventListener("mousemove",t=>{if(this.editMode==="none")this.canvas.style.cursor="default";else if(this.editMode==="add")this.canvas.style.cursor="crosshair";else if(this.editMode==="delete"){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,r=this._canvasToWorld(s,i),o=_.findObstacleAt(r.x,r.y);this.canvas.style.cursor=o>=0?"pointer":"not-allowed"}})}_canvasToWorld(t,e){const s=this.worldWidth/this.canvas.width,i=this.worldHeight/this.canvas.height;return{x:t*s,y:(this.canvas.height-e)*i}}_handleResize(){this._resizeScheduled||(this._resizeScheduled=!0,requestAnimationFrame(()=>{this._resizeScheduled=!1;const t=this.canvas.parentElement;if(!t)return;const e=t.getBoundingClientRect();if(e.width===0||e.height===0)return;const s=Math.min(e.width,e.height,500);this.canvas.width=s,this.canvas.height=s,this._render()}))}_worldToCanvas(t,e){const s=this.canvas.width/this.worldWidth,i=this.canvas.height/this.worldHeight;return{x:t*s,y:this.canvas.height-e*i}}_worldToCanvasScale(t){return t/this.worldWidth*this.canvas.width}_updateMapCanvas(){if(!this.mapData||!this.mapInfo)return;const{width:t,height:e,resolution:s,origin:i}=this.mapInfo;if(!t||!e)return;this.mapCanvas||(this.mapCanvas=document.createElement("canvas")),this.mapCanvas.width=t,this.mapCanvas.height=e;const r=this.mapCanvas.getContext("2d"),o=r.createImageData(t,e);for(let a=0;a<e;a++)for(let l=0;l<t;l++){const c=a*t+l,h=this.mapData[c],u=((e-1-a)*t+l)*4;let m,b,y;if(h===-1)m=100,b=100,y=120;else if(h<=10)m=220,b=255,y=220;else if(h>=65)m=180-Math.min(100,h),b=20,y=20;else{const v=(h-10)/55;m=Math.round(255-v*75),b=Math.round(180-v*160),y=Math.round(100-v*80)}o.data[u]=m,o.data[u+1]=b,o.data[u+2]=y,o.data[u+3]=255}r.putImageData(o,0,0)}_renderMapOverlay(){if(!this.mapCanvas||!this.mapInfo)return;const t=this.ctx,{width:e,height:s,resolution:i,origin:r}=this.mapInfo;t.save(),t.globalAlpha=this.mapOpacity,t.imageSmoothingEnabled=!1,t.drawImage(this.mapCanvas,0,0,this.canvas.width,this.canvas.height),t.restore()}_render(){const t=this.ctx,e=this.canvas.width,s=this.canvas.height;if(t.fillStyle=`rgb(${this.background.r}, ${this.background.g}, ${this.background.b})`,t.fillRect(0,0,e,s),this.showMap&&this._renderMapOverlay(),this.showObstacles&&this._renderObstacles(),!this.hasTurtlesim){this._renderEmptyState();return}this._renderTrails(),this.showLidar&&this.lidarData&&this._renderLidar(),this._renderTurtles(),this.showTF&&this._renderTFFrames()}_renderEmptyState(){const t=this.ctx,e=this.canvas.width,s=this.canvas.height;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,e,s),t.fillStyle="#ffffff",t.font='14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("Run: ros2 run turtlesim turtlesim_node",e/2,s/2),t.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.fillStyle="rgba(255, 255, 255, 0.7)",t.fillText("to start the simulation",e/2,s/2+20)}_renderObstacles(){const t=this.ctx,e=_.getObstacles();t.fillStyle="rgba(100, 100, 100, 0.8)",t.strokeStyle="#444",t.lineWidth=2;for(const s of e){const i=this._worldToCanvas(s.x,s.y+s.height),r=this._worldToCanvasScale(s.width),o=this._worldToCanvasScale(s.height);t.fillRect(i.x,i.y,r,o),t.strokeRect(i.x,i.y,r,o)}}_renderTrails(){const t=this.ctx;for(const e of this.trails){const s=this._worldToCanvas(e.x1,e.y1),i=this._worldToCanvas(e.x2,e.y2);t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(i.x,i.y),t.strokeStyle=e.color,t.lineWidth=e.width,t.lineCap="round",t.stroke()}}_renderTurtles(){const t=this.ctx,e=this._worldToCanvasScale(1.2);for(const s of this.turtles){const i=this._worldToCanvas(s.x,s.y);t.save(),t.translate(i.x,i.y),t.rotate(-s.theta),this.turtleImageLoaded?t.drawImage(this.turtleImage,-e/2,-e/2,e,e):(t.beginPath(),t.moveTo(e/2,0),t.lineTo(-e/2,-e/3),t.lineTo(-e/2,e/3),t.closePath(),t.fillStyle="#00ff00",t.fill(),t.strokeStyle="#006400",t.stroke()),t.restore()}}_renderLidar(){const t=this.ctx,{x:e,y:s,theta:i,scan:r}=this.lidarData;if(!r||!r.ranges)return;const o=this._worldToCanvas(e,s);t.strokeStyle="rgba(255, 0, 0, 0.3)",t.lineWidth=1;const{angle_min:a,angle_increment:l,ranges:c}=r;for(let h=0;h<c.length;h++){const d=c[h];if(!isFinite(d))continue;const u=i+a+h*l,m=e+Math.cos(u)*d,b=s+Math.sin(u)*d,y=this._worldToCanvas(m,b);t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(y.x,y.y),t.stroke(),d<r.range_max-.1&&(t.fillStyle="red",t.beginPath(),t.arc(y.x,y.y,2,0,Math.PI*2),t.fill())}}_renderTFFrames(){const t=this.ctx,e=this._worldToCanvasScale(.5);for(const s of this.turtles){const i=this._worldToCanvas(s.x,s.y);t.save(),t.translate(i.x,i.y),t.rotate(-s.theta),t.beginPath(),t.moveTo(0,0),t.lineTo(e,0),t.strokeStyle="red",t.lineWidth=2,t.stroke(),t.beginPath(),t.moveTo(0,0),t.lineTo(0,-e),t.strokeStyle="green",t.stroke(),t.restore()}}toggleObstacles(){this.showObstacles=!this.showObstacles,this._render()}toggleLidar(){this.showLidar=!this.showLidar,this._render()}toggleTF(){this.showTF=!this.showTF,this._render()}clearTrails(){this.trails=[],this._render()}setEditMode(t){this.editMode=t,this.canvas.style.cursor=t==="none"?"default":t==="add"?"crosshair":"pointer",window.dispatchEvent(new CustomEvent(g.CANVAS_EDIT_MODE_CHANGED,{detail:{mode:t}}))}getEditMode(){return this.editMode}setObstacleSize(t){this.newObstacleSize=Math.max(.3,Math.min(3,t))}randomizeObstacles(t=5){_.randomizeObstacles(t)}clearObstacles(){_.clearNonWallObstacles()}resetObstacles(){_.resetObstacles()}toggleMap(){return this.showMap=!this.showMap,this._render(),this.showMap}setMapOpacity(t){this.mapOpacity=Math.max(0,Math.min(1,t)),this.showMap&&this._render()}getMapOpacity(){return this.mapOpacity}isMapVisible(){return this.showMap}}class Ct{constructor(t="map-canvas"){typeof t=="string"?this.canvas=document.getElementById(t):this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.mapData=null,this.mapInfo=null,this.robotX=0,this.robotY=0,this.robotTheta=0,this._setupEventListeners(),this._render()}_setupEventListeners(){window.addEventListener(g.MAP_UPDATE,t=>{const{map:e,info:s}=t.detail;this.mapData=e,this.mapInfo=s,this._render()}),window.addEventListener(g.ROBOT_POSE_UPDATE,t=>{const{x:e,y:s,theta:i}=t.detail;this.robotX=e,this.robotY=s,this.robotTheta=i,this._render()}),window.addEventListener("resize",()=>this._handleResize()),window.addEventListener(g.LAYOUT_RESIZE,()=>this._handleResize()),this._handleResize()}_handleResize(){const t=this.canvas.parentElement;if(!t)return;const e=t.getBoundingClientRect(),s=Math.min(e.width,e.height,500);this.canvas.width=s,this.canvas.height=s,this._render()}_mapToCanvas(t,e){if(!this.mapInfo)return{x:0,y:0};const{width:s,height:i,resolution:r,origin:o}=this.mapInfo,a=o.position.x+t*r,l=o.position.y+e*r,c=s*r,h=i*r,d=this.canvas.width/c,u=this.canvas.height/h;return{x:(a-o.position.x)*d,y:this.canvas.height-(l-o.position.y)*u}}_worldToCanvas(t,e){if(!this.mapInfo){const d=this.canvas.width/11;return{x:t*d,y:this.canvas.height-e*d}}const{width:s,height:i,resolution:r,origin:o}=this.mapInfo,a=s*r,l=i*r,c=this.canvas.width/a,h=this.canvas.height/l;return{x:(t-o.position.x)*c,y:this.canvas.height-(e-o.position.y)*h}}_render(){const t=this.ctx,e=this.canvas.width,s=this.canvas.height;t.fillStyle="#808080",t.fillRect(0,0,e,s),this.mapData&&this.mapInfo&&this._renderOccupancyGrid(),this._renderRobot()}_renderOccupancyGrid(){const t=this.ctx,{width:e,height:s,resolution:i,origin:r}=this.mapInfo,o=this.mapData,a=this.canvas.width/e,l=this.canvas.height/s,c=t.createImageData(this.canvas.width,this.canvas.height),h=c.data;for(let d=0;d<s;d++)for(let u=0;u<e;u++){const m=d*e+u,b=o[m],y=s-1-d;let v,E,M;b===-1?v=E=M=128:b===0?v=E=M=255:v=E=M=Math.max(0,255-b*2.55);for(let T=0;T<Math.ceil(l);T++)for(let C=0;C<Math.ceil(a);C++){const k=Math.floor(u*a)+C,A=Math.floor(y*l)+T;if(k<this.canvas.width&&A<this.canvas.height){const z=(A*this.canvas.width+k)*4;h[z]=v,h[z+1]=E,h[z+2]=M,h[z+3]=255}}}t.putImageData(c,0,0)}_renderRobot(){const t=this.ctx,e=this._worldToCanvas(this.robotX,this.robotY),s=15;t.save(),t.translate(e.x,e.y),t.rotate(-this.robotTheta),t.beginPath(),t.moveTo(s,0),t.lineTo(-s/2,-s/2),t.lineTo(-s/3,0),t.lineTo(-s/2,s/2),t.closePath(),t.fillStyle="rgba(0, 150, 255, 0.8)",t.fill(),t.strokeStyle="#0066cc",t.lineWidth=2,t.stroke(),t.restore()}updateMap(t,e){this.mapData=t,this.mapInfo=e,this._render()}updateRobotPose(t,e,s){this.robotX=t,this.robotY=e,this.robotTheta=s,this._render()}clear(){this.mapData=null,this.mapInfo=null,this._render()}}class It{subscribe(t,e,s){throw new Error("subscribe() must be implemented")}unsubscribe(t){throw new Error("unsubscribe() must be implemented")}publish(t,e,s){throw new Error("publish() must be implemented")}advertise(t,e,s){throw new Error("advertise() must be implemented")}unadvertise(t){throw new Error("unadvertise() must be implemented")}advertiseService(t,e,s,i){throw new Error("advertiseService() must be implemented")}unadvertiseService(t){throw new Error("unadvertiseService() must be implemented")}callService(t,e,s){throw new Error("callService() must be implemented")}advertiseAction(t,e,s,i){throw new Error("advertiseAction() must be implemented")}unadvertiseAction(t){throw new Error("unadvertiseAction() must be implemented")}sendActionGoal(t,e,s,i){throw new Error("sendActionGoal() must be implemented")}getTopics(){throw new Error("getTopics() must be implemented")}getServices(){throw new Error("getServices() must be implemented")}getActions(){throw new Error("getActions() must be implemented")}destroy(){throw new Error("destroy() must be implemented")}}class V extends It{constructor(){super(),this.topics=new Map,this.services=new Map,this.actions=new Map,this.nextId=1}_generateId(){return`id_${this.nextId++}`}_ensureTopic(t,e){if(!this.topics.has(t))this.topics.set(t,{type:e,publishers:new Map,subscribers:new Map});else{const s=this.topics.get(t);s.type!==e&&e!=="unknown"&&s.type!=="unknown"&&console.warn(`[WARN] Topic '${t}' already exists with type '${s.type}', but was requested with type '${e}'. In ROS2, all publishers and subscribers on a topic must use the same type.`)}return this.topics.get(t)}subscribe(t,e,s,i=null){const r=this._ensureTopic(t,e),o=this._generateId();return r.subscribers.set(o,{callback:s,msgType:e,nodeId:i}),o}unsubscribe(t){for(const[,e]of this.topics)if(e.subscribers.has(t))return e.subscribers.delete(t),!0;return!1}publish(t,e,s){const i=this.topics.get(t);if(!i)return;const r={...s,_timestamp:s._timestamp||Date.now()};for(const[,o]of i.subscribers)try{o.callback(r)}catch(a){console.error(`Error in subscriber callback for ${t}:`,a)}}advertise(t,e,s){const i=this._ensureTopic(t,e),r=this._generateId();return i.publishers.set(r,{nodeId:s,msgType:e}),r}unadvertise(t){for(const[,e]of this.topics)if(e.publishers.has(t))return e.publishers.delete(t),!0;return!1}advertiseService(t,e,s,i){const r=this._generateId();return this.services.set(t,{id:r,type:e,handler:s,nodeId:i}),r}unadvertiseService(t){for(const[e,s]of this.services)if(s.id===t)return this.services.delete(e),!0;return!1}async callService(t,e,s){const i=this.services.get(t);if(!i)throw new Error(`Service '${t}' not available`);if(i.type!==e)throw new Error(`Service type mismatch: expected ${i.type}, got ${e}`);try{return await i.handler(s)}catch(r){throw new Error(`Service call failed: ${r.message}`)}}advertiseAction(t,e,s,i){const r=this._generateId();return this.actions.set(t,{id:r,type:e,handlers:s,nodeId:i,activeGoals:new Map}),r}unadvertiseAction(t){for(const[e,s]of this.actions)if(s.id===t){for(const[i,r]of s.activeGoals)r.cancelCallback&&r.cancelCallback();return this.actions.delete(e),!0}return!1}async sendActionGoal(t,e,s,i){const r=this.actions.get(t);if(!r)throw new Error(`Action '${t}' not available`);if(r.type!==e)throw new Error(`Action type mismatch: expected ${r.type}, got ${e}`);const o=this._generateId();if(r.handlers.goalCallback&&!await r.handlers.goalCallback(s))throw new Error("Goal rejected");const a={id:o,goal:s,feedbackCallback:i,canceled:!1};r.activeGoals.set(o,a);try{const l=await r.handlers.executeCallback(s,o,c=>{i&&!a.canceled&&i(c)},()=>a.canceled);return r.activeGoals.delete(o),l}catch(l){throw r.activeGoals.delete(o),l}}cancelActionGoal(t,e){const s=this.actions.get(t);if(!s)return!1;const i=s.activeGoals.get(e);return i?(i.canceled=!0,s.handlers.cancelCallback&&s.handlers.cancelCallback(e),!0):!1}getTopics(){const t=[];for(const[e,s]of this.topics)t.push({name:e,type:s.type,publishers:Array.from(s.publishers.values()),subscribers:Array.from(s.subscribers.values())});return t}getServices(){const t=[];for(const[e,s]of this.services)t.push({name:e,type:s.type,node:s.nodeId});return t}getActions(){const t=[];for(const[e,s]of this.actions)t.push({name:e,type:s.type,node:s.nodeId});return t}destroy(){for(const[,t]of this.actions)for(const[e,s]of t.activeGoals)s.canceled=!0;this.topics.clear(),this.services.clear(),this.actions.clear()}}class kt{constructor(){this.comm=new V,this.nodes=new Map}setCommProvider(t){this.comm&&this.comm.destroy(),this.comm=t}registerNode(t,e={}){this.nodes.set(t,{...e,publishers:[],subscribers:[],services:[],actions:[],parameters:new Map})}unregisterNode(t){const e=this.nodes.get(t);if(e){for(const s of e.publishers)this.comm.unadvertise(s);for(const s of e.subscribers)this.comm.unsubscribe(s);for(const s of e.services)this.comm.unadvertiseService(s);for(const s of e.actions)this.comm.unadvertiseAction(s);this.nodes.delete(t)}}createPublisher(t,e,s){const i=this.comm.advertise(e,s,t),r=this.nodes.get(t);return r&&r.publishers.push(i),{id:i,topic:e,msgType:s,publish:o=>{this.comm.publish(e,s,o)},destroy:()=>{if(this.comm.unadvertise(i),r){const o=r.publishers.indexOf(i);o>=0&&r.publishers.splice(o,1)}}}}createSubscription(t,e,s,i){const r=this.comm.subscribe(e,s,i,t),o=this.nodes.get(t);return o&&o.subscribers.push(r),{id:r,topic:e,msgType:s,destroy:()=>{if(this.comm.unsubscribe(r),o){const a=o.subscribers.indexOf(r);a>=0&&o.subscribers.splice(a,1)}}}}createService(t,e,s,i){const r=this.comm.advertiseService(e,s,i,t),o=this.nodes.get(t);return o&&o.services.push(r),{id:r,name:e,type:s,destroy:()=>{if(this.comm.unadvertiseService(r),o){const a=o.services.indexOf(r);a>=0&&o.services.splice(a,1)}}}}async callService(t,e,s){return this.comm.callService(t,e,s)}createActionServer(t,e,s,i){const r=this.comm.advertiseAction(e,s,i,t),o=this.nodes.get(t);return o&&o.actions.push(r),{id:r,name:e,type:s,destroy:()=>{if(this.comm.unadvertiseAction(r),o){const a=o.actions.indexOf(r);a>=0&&o.actions.splice(a,1)}}}}async sendActionGoal(t,e,s,i){return this.comm.sendActionGoal(t,e,s,i)}publish(t,e,s){this.comm.publish(t,e,s)}subscribe(t,e,s){return this.comm.subscribe(t,e,s)}unsubscribe(t){return this.comm.unsubscribe(t)}getNodes(){return Array.from(this.nodes.keys())}getNodeInfo(t){return this.nodes.get(t)}getTopics(){return this.comm.getTopics()}getTopicInfo(t){return this.comm.getTopics().find(s=>s.name===t)}getServices(){return this.comm.getServices()}getServiceInfo(t){return this.comm.getServices().find(s=>s.name===t)}getActions(){return this.comm.getActions()}getActionInfo(t){return this.comm.getActions().find(s=>s.name===t)}reset(){for(const t of this.nodes.keys())this.unregisterNode(t);this.comm.destroy(),this.comm=new V}}const p=new kt;D.register("simDDS",p);class Lt{constructor(t="graph-container"){typeof t=="string"?this.container=document.getElementById(t):this.container=t,this.cy=null,this.updateInterval=null,this._initCytoscape()}_initCytoscape(){this.cy=null,this.initialized=!1,this.lastGraphSignature=""}_ensureInitialized(){this.initialized||(this.cy=pt({container:this.container,elements:[],style:[{selector:'node[type="node"]',style:{"background-color":"#4a90d9",label:"data(label)","text-valign":"center","text-halign":"center",color:"#fff","font-size":"12px",width:"80px",height:"40px",shape:"round-rectangle","text-wrap":"wrap","text-max-width":"70px"}},{selector:'node[type="topic"]',style:{"background-color":"#6c757d",label:"data(label)","text-valign":"center","text-halign":"center",color:"#fff","font-size":"10px",width:"100px",height:"30px",shape:"rectangle","text-wrap":"wrap","text-max-width":"90px"}},{selector:"edge",style:{width:2,"line-color":"#aaa","target-arrow-color":"#aaa","target-arrow-shape":"triangle","curve-style":"bezier"}},{selector:'edge[type="publish"]',style:{"line-color":"#28a745","target-arrow-color":"#28a745"}},{selector:'edge[type="subscribe"]',style:{"line-color":"#dc3545","target-arrow-color":"#dc3545"}}],layout:{name:"preset"}}),this.initialized=!0)}update(){if(!this.initialized||!this.cy)return;const t=p.getNodes(),e=p.getTopics(),s=[],i=new Set,r=new Set,o=[];for(const l of t){const c=`node_${l}`;i.add(c),o.push(c),s.push({data:{id:c,label:l.replace(/^\//,""),type:"node"}})}for(const l of e){const c=`topic_${l.name}`;if(!(l.publishers.length===0&&l.subscribers.length===0)){r.has(c)||(r.add(c),o.push(c),s.push({data:{id:c,label:l.name,type:"topic"}}));for(const h of l.publishers){const d=`node_${h.nodeId}`;if(i.has(d)){const u=`${d}_to_${c}`;o.push(u),s.push({data:{id:u,source:d,target:c,type:"publish"}})}}for(const h of l.subscribers){const d=`node_${h.nodeId}`;if(i.has(d)){const u=`${c}_to_${d}`;o.push(u),s.push({data:{id:u,source:c,target:d,type:"subscribe"}})}}}}const a=o.sort().join(",");a!==this.lastGraphSignature&&(this.lastGraphSignature=a,this.cy.resize(),this.cy.elements().remove(),this.cy.add(s),s.length>0&&(this.cy.layout({name:"cose",animate:!1,nodeDimensionsIncludeLabels:!0,nodeRepulsion:4e3,idealEdgeLength:80,padding:50}).run(),this.cy.fit(void 0,50),this.cy.center()))}startAutoUpdate(t=1e3){this.stopAutoUpdate(),this.update(),this.updateInterval=setInterval(()=>this.update(),t)}stopAutoUpdate(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null)}show(){const t=document.getElementById("canvas-container");t==null||t.classList.add("hidden"),this.container.classList.remove("hidden"),setTimeout(()=>{this._ensureInitialized(),this.cy&&this.cy.resize(),this.startAutoUpdate(),setTimeout(()=>{this.cy&&(this.cy.resize(),this.cy.fit(void 0,50),this.cy.center())},200)},100)}hide(){this.container.classList.add("hidden"),this.stopAutoUpdate();const t=document.getElementById("canvas-container");t==null||t.classList.remove("hidden"),window.dispatchEvent(new Event(g.LAYOUT_RESIZE))}toggle(){this.container.classList.contains("hidden")?this.show():this.hide()}destroy(){this.stopAutoUpdate(),this.cy&&(this.cy.destroy(),this.cy=null),this.initialized=!1}}class Et{constructor(t={}){this.panel=t.panel||document.getElementById("console-panel"),this.messagesContainer=t.messages||document.getElementById("console-messages"),this.filterLevel=t.filterLevel||document.getElementById("console-filter-level"),this.filterNode=t.filterNode||document.getElementById("console-filter-node"),this.clearButton=t.clearButton||document.getElementById("console-clear"),this.pauseButton=t.pauseButton||document.getElementById("console-pause"),this.closeButton=t.closeButton||document.getElementById("console-close"),this.paused=!1,this.pendingLogs=[],this.maxDisplayedLogs=500,this.unsubscribe=null,this._setupEventListeners()}_setupEventListeners(){var t,e,s,i,r;(t=this.filterLevel)==null||t.addEventListener("change",()=>{this._refreshLogs()}),(e=this.filterNode)==null||e.addEventListener("input",()=>{this._refreshLogs()}),(s=this.clearButton)==null||s.addEventListener("click",()=>{this._clearLogs()}),(i=this.pauseButton)==null||i.addEventListener("click",()=>{this._togglePause()}),(r=this.closeButton)==null||r.addEventListener("click",()=>{this.hide()}),this.unsubscribe=S.addListener(o=>{this._handleLogEntry(o)})}_handleLogEntry(t){if(this.paused){this.pendingLogs.push(t);return}this._addLogEntry(t)}_addLogEntry(t){var r,o,a;if(!this.messagesContainer)return;const e=S.parseLevel(((r=this.filterLevel)==null?void 0:r.value)||"INFO");if(t.levelValue<e)return;const s=(a=(o=this.filterNode)==null?void 0:o.value)==null?void 0:a.toLowerCase();if(s&&!t.node.toLowerCase().includes(s))return;const i=document.createElement("div");for(i.className=`log-entry log-${t.level.toLowerCase()}`,i.textContent=S.formatEntry(t),this.messagesContainer.appendChild(i);this.messagesContainer.children.length>this.maxDisplayedLogs;)this.messagesContainer.removeChild(this.messagesContainer.firstChild);this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}_refreshLogs(){var i,r;if(!this.messagesContainer)return;this.messagesContainer.innerHTML="";const t={level:(i=this.filterLevel)==null?void 0:i.value,node:(r=this.filterNode)==null?void 0:r.value},e=S.getLogs(t),s=Math.max(0,e.length-this.maxDisplayedLogs);for(let o=s;o<e.length;o++)this._addLogEntry(e[o])}_clearLogs(){this.messagesContainer&&(this.messagesContainer.innerHTML=""),S.clear(),this.pendingLogs=[]}_togglePause(){if(this.paused=!this.paused,this.pauseButton&&(this.pauseButton.textContent=this.paused?"Resume":"Pause"),!this.paused){for(const t of this.pendingLogs)this._addLogEntry(t);this.pendingLogs=[]}}show(){var t;(t=this.panel)==null||t.classList.remove("hidden"),this._refreshLogs()}hide(){var t;(t=this.panel)==null||t.classList.add("hidden")}toggle(){var t;(t=this.panel)!=null&&t.classList.contains("hidden")?this.show():this.hide()}destroy(){this.unsubscribe&&this.unsubscribe()}}class Mt{constructor(t={}){this.visualizationPanel=t.visualizationPanel||document.getElementById("visualization-panel"),this.terminalPanel=t.terminalPanel||document.getElementById("terminal-panel"),this.canvasContainer=t.canvasContainer||document.getElementById("canvas-container"),this.mapContainer=t.mapContainer||document.getElementById("map-container"),this.graphContainer=t.graphContainer||document.getElementById("graph-container"),this.consolePanel=t.consolePanel||document.getElementById("console-panel"),this.resizing=!1,this.currentLayout="desktop",this._detectLayout(),this._setupResizeObserver(),this._setupMobileSwipe()}_detectLayout(){const t=window.innerWidth;t<768?(this.currentLayout="mobile",document.body.classList.add("mobile-layout"),document.body.classList.remove("tablet-layout","desktop-layout")):t<1024?(this.currentLayout="tablet",document.body.classList.add("tablet-layout"),document.body.classList.remove("mobile-layout","desktop-layout")):(this.currentLayout="desktop",document.body.classList.add("desktop-layout"),document.body.classList.remove("mobile-layout","tablet-layout"))}_setupResizeObserver(){window.addEventListener("resize",()=>{this._detectLayout(),this._triggerResize()})}_setupMobileSwipe(){if(!this.terminalPanel)return;let t=0,e=0;this.terminalPanel.addEventListener("touchstart",s=>{t=s.touches[0].clientX,e=s.touches[0].clientY},{passive:!0}),this.terminalPanel.addEventListener("touchend",s=>{const i=s.changedTouches[0].clientX,r=s.changedTouches[0].clientY,o=i-t,a=r-e;if(Math.abs(o)>Math.abs(a)&&Math.abs(o)>50){const l=new CustomEvent("terminal-swipe",{detail:{direction:o>0?"right":"left"}});this.terminalPanel.dispatchEvent(l)}},{passive:!0})}_triggerResize(){window.dispatchEvent(new Event(g.LAYOUT_RESIZE))}showCanvas(){var t;(t=this.canvasContainer)==null||t.classList.remove("hidden")}hideCanvas(){var t;(t=this.canvasContainer)==null||t.classList.add("hidden")}toggleMap(){window.dispatchEvent(new CustomEvent(g.TOGGLE_MAP_OVERLAY)),this._triggerResize()}showMap(){var t;(t=this.mapContainer)==null||t.classList.remove("hidden"),this._triggerResize()}hideMap(){var t;(t=this.mapContainer)==null||t.classList.add("hidden"),this._triggerResize()}toggleGraph(){var t;(t=this.graphContainer)==null||t.classList.toggle("hidden"),this._triggerResize()}showGraph(){var t;(t=this.graphContainer)==null||t.classList.remove("hidden"),this._triggerResize()}hideGraph(){var t;(t=this.graphContainer)==null||t.classList.add("hidden"),this._triggerResize()}toggleConsole(){var t;(t=this.consolePanel)==null||t.classList.toggle("hidden"),this._triggerResize()}showConsole(){var t;(t=this.consolePanel)==null||t.classList.remove("hidden"),this._triggerResize()}hideConsole(){var t;(t=this.consolePanel)==null||t.classList.add("hidden"),this._triggerResize()}getLayout(){return this.currentLayout}isMobile(){return this.currentLayout==="mobile"}isTablet(){return this.currentLayout==="tablet"}isDesktop(){return this.currentLayout==="desktop"}}class At{constructor(){this.activeTab="quickstart",this.modal=null,this.body=null,this.tabContent={}}show(t){this.modal=t;const e=document.getElementById("modal-title");this.body=document.getElementById("modal-body"),!(!this.modal||!this.body)&&(e.textContent="ROS 2 Turtle School - Help",this.body.innerHTML=this._renderTabs()+this._renderContent(),this._setupTabListeners(),this._showTab(this.activeTab),this.modal.classList.remove("hidden"))}_renderTabs(){return`
      <div class="help-tabs" role="tablist" aria-label="Help sections">
        <button class="help-tab active" data-tab="quickstart" role="tab" aria-selected="true" aria-controls="panel-quickstart">Quick Start</button>
        <button class="help-tab" data-tab="commands" role="tab" aria-selected="false" aria-controls="panel-commands">Commands</button>
        <button class="help-tab" data-tab="slam" role="tab" aria-selected="false" aria-controls="panel-slam">SLAM Tutorial</button>
      </div>
    `}_renderContent(){return`
      <div class="help-panels">
        <div id="panel-quickstart" class="help-panel active" role="tabpanel" aria-labelledby="tab-quickstart">
          ${this._renderQuickStart()}
        </div>
        <div id="panel-commands" class="help-panel" role="tabpanel" aria-labelledby="tab-commands" hidden>
          ${this._renderCommands()}
        </div>
        <div id="panel-slam" class="help-panel" role="tabpanel" aria-labelledby="tab-slam" hidden>
          ${this._renderSlam()}
        </div>
      </div>
    `}_renderQuickStart(){return`
      <div class="help-content">
        <div class="help-section help-intro">
          <p>This emulator lets you learn ROS2 CLI commands in your browser. Follow along with the official tutorial:</p>
          <a href="https://docs.ros.org/en/jazzy/Tutorials/Beginner-CLI-Tools.html" target="_blank" rel="noopener" class="tutorial-link">
            ROS2 Jazzy - Beginner CLI Tools Tutorial
          </a>
        </div>

        <h3>Quick Start</h3>
        <ol>
          <li>Run <code>ros2 run turtlesim turtlesim_node</code> to start turtlesim</li>
          <li>Open a new terminal with the <strong>+</strong> button</li>
          <li>Run <code>ros2 run teleop_twist_keyboard teleop_twist_keyboard</code></li>
          <li>Use <strong>W/A/S/D</strong> keys to move the turtle</li>
        </ol>

        <h3>Available Packages</h3>
        <table class="help-table">
          <tr><td><code>ros2 run turtlesim turtlesim_node</code></td><td>Start turtlesim simulator</td></tr>
          <tr><td><code>ros2 run turtlesim turtle_teleop_key</code></td><td>Control with arrow keys</td></tr>
          <tr><td><code>ros2 run teleop_twist_keyboard teleop_twist_keyboard</code></td><td>Control with WASD keys</td></tr>
          <tr><td><code>ros2 run simple_slam slam_node</code></td><td>Start SLAM mapping node</td></tr>
          <tr><td><code>ros2 run tf2_ros static_transform_publisher</code></td><td>Publish static TF</td></tr>
        </table>

        <h3>Keyboard Shortcuts</h3>
        <ul>
          <li><strong>Ctrl+C</strong> - Stop running command</li>
          <li><strong>Up/Down</strong> - Command history</li>
        </ul>
      </div>
    `}_renderCommands(){return`
      <div class="help-content">
        <h3>ros2 run Options</h3>
        <table class="help-table">
          <tr><td><code>--ros-args --remap __node:=name</code></td><td>Rename node</td></tr>
          <tr><td><code>--ros-args --remap topic:=new_topic</code></td><td>Remap topic</td></tr>
          <tr><td><code>--ros-args --log-level WARN</code></td><td>Set log level</td></tr>
        </table>

        <h3>ros2 node Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 node list</code></td><td>List running nodes</td></tr>
          <tr><td><code>ros2 node info &lt;node&gt;</code></td><td>Show node details</td></tr>
        </table>

        <h3>ros2 topic Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 topic list</code></td><td>List all topics</td></tr>
          <tr><td><code>ros2 topic list -t</code></td><td>List with types</td></tr>
          <tr><td><code>ros2 topic info &lt;topic&gt;</code></td><td>Show topic info</td></tr>
          <tr><td><code>ros2 topic type &lt;topic&gt;</code></td><td>Show message type</td></tr>
          <tr><td><code>ros2 topic echo &lt;topic&gt;</code></td><td>Print messages</td></tr>
          <tr><td><code>ros2 topic pub &lt;topic&gt; &lt;type&gt; "&lt;yaml&gt;"</code></td><td>Publish message</td></tr>
          <tr><td><code>ros2 topic pub --once ...</code></td><td>Publish once</td></tr>
          <tr><td><code>ros2 topic pub -r 10 ...</code></td><td>Publish at rate</td></tr>
          <tr><td><code>ros2 topic hz &lt;topic&gt;</code></td><td>Show publish rate</td></tr>
        </table>

        <h3>ros2 service Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 service list</code></td><td>List all services</td></tr>
          <tr><td><code>ros2 service list -t</code></td><td>List with types</td></tr>
          <tr><td><code>ros2 service type &lt;service&gt;</code></td><td>Show service type</td></tr>
          <tr><td><code>ros2 service call &lt;srv&gt; &lt;type&gt; "&lt;yaml&gt;"</code></td><td>Call service</td></tr>
        </table>
        <p><em>Turtlesim services: /spawn, /kill, /turtle1/set_pen, /turtle1/teleport_absolute</em></p>

        <h3>ros2 action Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 action list</code></td><td>List all actions</td></tr>
          <tr><td><code>ros2 action list -t</code></td><td>List with types</td></tr>
          <tr><td><code>ros2 action info &lt;action&gt;</code></td><td>Show action info</td></tr>
          <tr><td><code>ros2 action send_goal &lt;action&gt; &lt;type&gt; "&lt;yaml&gt;"</code></td><td>Send goal</td></tr>
          <tr><td><code>ros2 action send_goal ... --feedback</code></td><td>With feedback</td></tr>
        </table>
        <p><em>Turtlesim action: /turtle1/rotate_absolute</em></p>

        <h3>ros2 param Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 param list</code></td><td>List all parameters</td></tr>
          <tr><td><code>ros2 param list &lt;node&gt;</code></td><td>List node params</td></tr>
          <tr><td><code>ros2 param get &lt;node&gt; &lt;param&gt;</code></td><td>Get parameter value</td></tr>
          <tr><td><code>ros2 param set &lt;node&gt; &lt;param&gt; &lt;value&gt;</code></td><td>Set parameter</td></tr>
          <tr><td><code>ros2 param dump &lt;node&gt;</code></td><td>Dump all params</td></tr>
        </table>
        <p><em>Turtlesim params: background_r, background_g, background_b</em></p>

        <h3>ros2 bag Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 bag record &lt;topics&gt;</code></td><td>Record topics</td></tr>
          <tr><td><code>ros2 bag record -o &lt;name&gt; &lt;topics&gt;</code></td><td>Record with name</td></tr>
          <tr><td><code>ros2 bag record -a</code></td><td>Record all topics</td></tr>
          <tr><td><code>ros2 bag info &lt;bag&gt;</code></td><td>Show bag info</td></tr>
          <tr><td><code>ros2 bag play &lt;bag&gt;</code></td><td>Play back bag</td></tr>
          <tr><td><code>ros2 bag play &lt;bag&gt; --rate 2.0</code></td><td>Play at 2x speed</td></tr>
        </table>

        <h3>ros2 interface Commands</h3>
        <table class="help-table">
          <tr><td><code>ros2 interface show &lt;type&gt;</code></td><td>Show message/service definition</td></tr>
          <tr><td><code>ros2 pkg executables &lt;pkg&gt;</code></td><td>List package executables</td></tr>
        </table>

        <h3>rqt Tools</h3>
        <table class="help-table">
          <tr><td><code>rqt_graph</code></td><td>Node/topic graph visualization</td></tr>
          <tr><td><code>rqt_console</code></td><td>Log message viewer</td></tr>
          <tr><td><code>rqt</code></td><td>Open tool selector</td></tr>
        </table>
      </div>
    `}_renderSlam(){return`
      <div class="help-content">
        <div class="slam-tutorial">
          <p>Learn how occupancy grid mapping works with our simple SLAM demo:</p>

          <h4>Step 1: Start Turtlesim</h4>
          <p>In Terminal 1:</p>
          <code>ros2 run turtlesim turtlesim_node</code>
          <p>This spawns a turtle with a simulated LIDAR sensor. The gray boxes are obstacles.</p>

          <h4>Step 2: Start SLAM Node</h4>
          <p>Click <strong>+</strong> to add Terminal 2, then run:</p>
          <code>ros2 run simple_slam slam_node</code>
          <p>The SLAM node subscribes to <code>/scan</code> (LIDAR) and <code>/turtle1/pose</code> (position).</p>

          <h4>Step 3: View the Map</h4>
          <p>Click the <strong>Map</strong> button in the header. You'll see a gray grid (unknown space).</p>

          <h4>Step 4: Start Teleop</h4>
          <p>Click <strong>+</strong> to add Terminal 3, then run:</p>
          <code>ros2 run teleop_twist_keyboard teleop_twist_keyboard</code>
          <p>Use <strong>W/A/S/D</strong> keys to drive the turtle around.</p>

          <h4>Step 5: Watch the Map Build</h4>
          <p>As the turtle moves:</p>
          <ul>
            <li><strong>White cells</strong> = Free space (LIDAR rays passed through)</li>
            <li><strong>Black cells</strong> = Obstacles (LIDAR rays hit something)</li>
            <li><strong>Gray cells</strong> = Unknown (not yet scanned)</li>
          </ul>
          <p>Drive around all the obstacles to build a complete map!</p>

          <h4>Inspect SLAM Topics</h4>
          <code>ros2 topic echo /map</code>
          <p>This shows the OccupancyGrid message with cell values (-1=unknown, 0=free, 100=occupied).</p>
        </div>
      </div>
    `}_setupTabListeners(){this.body.querySelectorAll(".help-tab").forEach(e=>{e.addEventListener("click",()=>{const s=e.dataset.tab;this._showTab(s)})})}_showTab(t){this.activeTab=t,this.body.querySelectorAll(".help-tab").forEach(i=>{const r=i.dataset.tab===t;i.classList.toggle("active",r),i.setAttribute("aria-selected",r?"true":"false")}),this.body.querySelectorAll(".help-panel").forEach(i=>{const r=i.id===`panel-${t}`;i.classList.toggle("active",r),i.hidden=!r})}}const Pt=new At;class $t{constructor(){this.commands=new Map,this.ros2Commands=new Map}register(t,e){this.commands.set(t,e)}registerRos2(t,e){this.ros2Commands.set(t,e)}hasCommand(t){return this.commands.has(t)}hasRos2Command(t){return this.ros2Commands.has(t)}async execute(t,e,s){const i=this.commands.get(t);return i?(await i(e,s),!0):!1}async executeRos2(t,e,s){const i=this.ros2Commands.get(t);return i?(await i(e,s),!0):!1}listCommands(){return Array.from(this.commands.keys())}listRos2Commands(){return Array.from(this.ros2Commands.keys())}}const w=new $t;class Rt{constructor(){this.packages={}}getNode(t,e){const s=this.packages[t];return s&&s[e]||null}listPackages(){return Object.keys(this.packages)}listExecutables(t){const e=this.packages[t];return e?Object.keys(e):[]}register(t,e,s){this.packages[t]||(this.packages[t]={}),this.packages[t][e]=s}hasPackage(t){return!!this.packages[t]}hasExecutable(t,e){return!!this.getNode(t,e)}}const x=new Rt;async function Dt(n,t){if(n.length<2){t.writeln("usage: ros2 run <package_name> <executable_name>"),t.writeln(""),t.writeln("Run an executable from a package."),t.finishCommand();return}const e=n[0],s=n[1],i=Ot(n.slice(2)),r=x.getNode(e,s);if(!r){t.writeln(`\x1B[31mPackage '${e}' not found or executable '${s}' not found\x1B[0m`),t.writeln(""),t.writeln("Available packages and executables:");const l=x.listPackages();for(const c of l){const h=x.listExecutables(c);for(const d of h)t.writeln(`  ${c} ${d}`)}t.finishCommand();return}let o=s;i.remap&&i.remap.__node&&(o=i.remap.__node);const a=`/${o}`;if(I.isNodeRunning(a)){t.writeln(`\x1B[33mNode with name '${a}' is already running\x1B[0m`),t.finishCommand();return}i.logLevel&&S.setNodeLevel(a,i.logLevel);try{const l=new r(o,{namespace:i.namespace,parameters:i.params,remappings:i.remap}),c=I.spawn(l,t.id,e,s);t.writeln(`\x1B[32m[INFO] Started ${e}/${s}\x1B[0m`)}catch(l){t.writeln(`\x1B[31mError starting node: ${l.message}\x1B[0m`),t.finishCommand()}}function Ot(n){const t={remap:{},params:{},namespace:"",logLevel:null,paramsFile:null};let e=0,s=!1;for(;e<n.length;){const i=n[e];if(i==="--ros-args"){s=!0,e++;continue}if(!s){e++;continue}if(i==="--remap"||i==="-r"){if(e+1<n.length){const o=n[e+1].split(":=");o.length===2&&(t.remap[o[0]]=o[1]),e+=2}else e++;continue}if(i.includes(":=")){const r=i.split(":=");r.length===2&&(t.remap[r[0]]=r[1]),e++;continue}if(i==="--param"||i==="-p"){if(e+1<n.length){const o=n[e+1].split(":=");o.length===2&&(t.params[o[0]]=Nt(o[1])),e+=2}else e++;continue}if(i==="--params-file"){e+1<n.length?(t.paramsFile=n[e+1],e+=2):e++;continue}if(i==="--log-level"){e+1<n.length?(t.logLevel=n[e+1].toUpperCase(),e+=2):e++;continue}if(i==="-n"||i==="--namespace"){e+1<n.length?(t.namespace=n[e+1],e+=2):e++;continue}e++}return t}function Nt(n){if(n==="true")return!0;if(n==="false")return!1;const t=Number(n);return isNaN(t)?n:t}w.registerRos2("run",Dt);async function zt(n,t){if(n.length===0){q(t),t.finishCommand();return}const e=n[0],s=n.slice(1);switch(e){case"list":Bt(s,t);break;case"info":Ft(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),q(t)}t.finishCommand()}function q(n){n.writeln("usage: ros2 node <command> [options]"),n.writeln(""),n.writeln("Commands:"),n.writeln("  list    List running nodes"),n.writeln("  info    Show information about a node")}function Bt(n,t){const e=p.getNodes();if(e.length===0){t.writeln("No nodes are currently running.");return}for(const s of e.sort())t.writeln(s)}function Ft(n,t){if(n.length===0){t.writeln("usage: ros2 node info <node_name>");return}let e=n[0];if(e.startsWith("/")||(e="/"+e),!p.getNodeInfo(e)){t.writeln(`\x1B[31mNode '${e}' not found\x1B[0m`);return}t.writeln(`${e}`);const i=I.getProcessByNodeName(e),r=i==null?void 0:i.node;if(t.writeln("  Subscribers:"),r&&r.subscriptions.length>0)for(const o of r.subscriptions)t.writeln(`    ${o.topic}: ${o.msgType}`);else t.writeln("    (none)");if(t.writeln("  Publishers:"),r&&r.publishers.length>0)for(const o of r.publishers)t.writeln(`    ${o.topic}: ${o.msgType}`);else t.writeln("    (none)");if(t.writeln("  Service Servers:"),r&&r.services.length>0)for(const o of r.services)t.writeln(`    ${o.name}: ${o.type}`);else t.writeln("    (none)");if(t.writeln("  Service Clients:"),t.writeln("    (none)"),t.writeln("  Action Servers:"),r&&r.actionServers.length>0)for(const o of r.actionServers)t.writeln(`    ${o.name}: ${o.type}`);else t.writeln("    (none)");t.writeln("  Action Clients:"),t.writeln("    (none)")}w.registerRos2("node",zt);function H(n){if(!n||typeof n!="string")return{};let t=n.trim();if(t.startsWith("{")&&t.endsWith("}")&&(t=t.slice(1,-1)),!t.trim())return{};try{return JSON.parse(`{${t}}`)}catch{return Ht(t)}}function Ht(n){const t={};let e=0,s="",i="",r=!1,o=!1,a="",l=0;for(;l<n.length;){const c=n[l];if((c==='"'||c==="'")&&!o){o=!0,a=c,r&&(i+=c),l++;continue}if(o&&c===a){o=!1,r&&(i+=c),l++;continue}if(o){r?i+=c:s+=c,l++;continue}if(c==="{"||c==="["){e++,r&&(i+=c),l++;continue}if(c==="}"||c==="]"){e--,r&&(i+=c),l++;continue}if(c===":"&&e===0&&!r){for(r=!0,l++;l<n.length&&n[l]===" ";)l++;continue}if(c===","&&e===0){for(s.trim()&&(t[s.trim()]=B(i.trim())),s="",i="",r=!1,l++;l<n.length&&n[l]===" ";)l++;continue}r?i+=c:s+=c,l++}return s.trim()&&(t[s.trim()]=B(i.trim())),t}function B(n){if(!n)return null;if(n.startsWith("{")&&n.endsWith("}"))return H(n);if(n.startsWith("[")&&n.endsWith("]"))return Wt(n.slice(1,-1));if(n.startsWith('"')&&n.endsWith('"')||n.startsWith("'")&&n.endsWith("'"))return n.slice(1,-1);if(n==="true")return!0;if(n==="false")return!1;if(n==="null"||n==="~")return null;const t=Number(n);return isNaN(t)?n:t}function Wt(n){const t=[];let e=0,s="",i=!1,r="";for(let o=0;o<n.length;o++){const a=n[o];if((a==='"'||a==="'")&&!i){i=!0,r=a,s+=a;continue}if(i&&a===r){i=!1,s+=a;continue}if(i){s+=a;continue}if(a==="{"||a==="["){e++,s+=a;continue}if(a==="}"||a==="]"){e--,s+=a;continue}if(a===","&&e===0){s.trim()&&t.push(B(s.trim())),s="";continue}s+=a}return s.trim()&&t.push(B(s.trim())),t}function L(n,t=0){if(n==null)return"null";if(typeof n!="object")return String(n);if(Array.isArray(n))return n.length===0?"[]":`[${n.map(r=>L(r,t)).join(", ")}]`;const e="  ".repeat(t),s=[];for(const[i,r]of Object.entries(n))if(!i.startsWith("_"))if(typeof r=="object"&&r!==null&&!Array.isArray(r))s.push(`${e}${i}:`),s.push(L(r,t+1));else{const o=L(r,t);s.push(`${e}${i}: ${o}`)}return s.join(`
`)}class Gt{constructor(){this.messages={},this.services={},this.actions={}}registerMessage(t,e){this.messages[t]=e}registerService(t,e){this.services[t]=e}registerAction(t,e){this.actions[t]=e}getMessage(t){return this.messages[t]||null}getService(t){return this.services[t]||null}getAction(t){return this.actions[t]||null}getInterface(t){return this.messages[t]||this.services[t]||this.actions[t]||null}listMessages(){return Object.keys(this.messages)}listServices(){return Object.keys(this.services)}listActions(){return Object.keys(this.actions)}findMessages(t){const e=new RegExp(t,"i");return Object.keys(this.messages).filter(s=>e.test(s))}findServices(t){const e=new RegExp(t,"i");return Object.keys(this.services).filter(s=>e.test(s))}findActions(t){const e=new RegExp(t,"i");return Object.keys(this.actions).filter(s=>e.test(s))}validateMessage(t,e){const s=this.messages[t];if(!s)return{valid:!1,errors:[`Unknown message type: ${t}`]};const i=[];for(const[r,o]of Object.entries(s.fields||{}))e[r]===void 0&&o.default===void 0&&i.push(`Missing required field: ${r}`);return{valid:i.length===0,errors:i}}createMessage(t,e={}){const s=this.messages[t];return!s||!s.create?null:s.create(e)}getDefinition(t){const e=this.getInterface(t);return(e==null?void 0:e.definition)||null}}const f=new Gt,Ut={name:"std_msgs/msg/Header",fields:{stamp:{type:"builtin_interfaces/msg/Time",default:{sec:0,nanosec:0}},frame_id:{type:"string",default:""}},create:(n={})=>({stamp:n.stamp||{sec:0,nanosec:0},frame_id:n.frame_id||""}),definition:`# Standard metadata for higher-level stamped data types.
builtin_interfaces/Time stamp
string frame_id`},Vt={name:"std_msgs/msg/String",fields:{data:{type:"string",default:""}},create:(n={})=>({data:n.data||""}),definition:`# A simple string message.
string data`},qt={name:"std_msgs/msg/Bool",fields:{data:{type:"bool",default:!1}},create:(n={})=>({data:n.data||!1}),definition:`# A simple boolean message.
bool data`},Yt={name:"std_msgs/msg/Int32",fields:{data:{type:"int32",default:0}},create:(n={})=>({data:n.data||0}),definition:`# A 32-bit signed integer.
int32 data`},Kt={name:"std_msgs/msg/Int64",fields:{data:{type:"int64",default:0}},create:(n={})=>({data:n.data||0}),definition:`# A 64-bit signed integer.
int64 data`},Xt={name:"std_msgs/msg/Float32",fields:{data:{type:"float32",default:0}},create:(n={})=>({data:n.data||0}),definition:`# A 32-bit floating point number.
float32 data`},jt={name:"std_msgs/msg/Float64",fields:{data:{type:"float64",default:0}},create:(n={})=>({data:n.data||0}),definition:`# A 64-bit floating point number.
float64 data`},Qt={name:"std_msgs/msg/Empty",fields:{},create:()=>({}),definition:"# Empty message type."},Jt={name:"std_msgs/msg/ColorRGBA",fields:{r:{type:"float32",default:0},g:{type:"float32",default:0},b:{type:"float32",default:0},a:{type:"float32",default:1}},create:(n={})=>({r:n.r??0,g:n.g??0,b:n.b??0,a:n.a??1}),definition:`# RGBA color with float values.
float32 r
float32 g
float32 b
float32 a`};f.registerMessage("std_msgs/msg/Header",Ut);f.registerMessage("std_msgs/msg/String",Vt);f.registerMessage("std_msgs/msg/Bool",qt);f.registerMessage("std_msgs/msg/Int32",Yt);f.registerMessage("std_msgs/msg/Int64",Kt);f.registerMessage("std_msgs/msg/Float32",Xt);f.registerMessage("std_msgs/msg/Float64",jt);f.registerMessage("std_msgs/msg/Empty",Qt);f.registerMessage("std_msgs/msg/ColorRGBA",Jt);const F={name:"geometry_msgs/msg/Vector3",fields:{x:{type:"float64",default:0},y:{type:"float64",default:0},z:{type:"float64",default:0}},create:(n={})=>({x:n.x??0,y:n.y??0,z:n.z??0}),definition:`# A 3D vector.
float64 x
float64 y
float64 z`},st={name:"geometry_msgs/msg/Point",fields:{x:{type:"float64",default:0},y:{type:"float64",default:0},z:{type:"float64",default:0}},create:(n={})=>({x:n.x??0,y:n.y??0,z:n.z??0}),definition:`# A point in 3D space.
float64 x
float64 y
float64 z`},U={name:"geometry_msgs/msg/Quaternion",fields:{x:{type:"float64",default:0},y:{type:"float64",default:0},z:{type:"float64",default:0},w:{type:"float64",default:1}},create:(n={})=>({x:n.x??0,y:n.y??0,z:n.z??0,w:n.w??1}),definition:`# A quaternion representing orientation.
float64 x
float64 y
float64 z
float64 w`},it={name:"geometry_msgs/msg/Pose",fields:{position:{type:"geometry_msgs/msg/Point"},orientation:{type:"geometry_msgs/msg/Quaternion"}},create:(n={})=>({position:st.create(n.position),orientation:U.create(n.orientation)}),definition:`# A representation of pose in free space.
Point position
Quaternion orientation`},Zt={name:"geometry_msgs/msg/PoseStamped",fields:{header:{type:"std_msgs/msg/Header"},pose:{type:"geometry_msgs/msg/Pose"}},create:(n={})=>({header:n.header||{stamp:{sec:0,nanosec:0},frame_id:""},pose:it.create(n.pose)}),definition:`# A Pose with reference coordinate frame and timestamp.
std_msgs/Header header
Pose pose`},nt={name:"geometry_msgs/msg/Twist",fields:{linear:{type:"geometry_msgs/msg/Vector3"},angular:{type:"geometry_msgs/msg/Vector3"}},create:(n={})=>({linear:F.create(n.linear),angular:F.create(n.angular)}),definition:`# Velocity in free space, broken into linear and angular parts.
Vector3 linear
Vector3 angular`},te={name:"geometry_msgs/msg/TwistStamped",fields:{header:{type:"std_msgs/msg/Header"},twist:{type:"geometry_msgs/msg/Twist"}},create:(n={})=>({header:n.header||{stamp:{sec:0,nanosec:0},frame_id:""},twist:nt.create(n.twist)}),definition:`# A twist with reference coordinate frame and timestamp.
std_msgs/Header header
Twist twist`},rt={name:"geometry_msgs/msg/Transform",fields:{translation:{type:"geometry_msgs/msg/Vector3"},rotation:{type:"geometry_msgs/msg/Quaternion"}},create:(n={})=>({translation:F.create(n.translation),rotation:U.create(n.rotation)}),definition:`# A transform between two coordinate frames.
Vector3 translation
Quaternion rotation`},ot={name:"geometry_msgs/msg/TransformStamped",fields:{header:{type:"std_msgs/msg/Header"},child_frame_id:{type:"string",default:""},transform:{type:"geometry_msgs/msg/Transform"}},create:(n={})=>({header:n.header||{stamp:{sec:0,nanosec:0},frame_id:""},child_frame_id:n.child_frame_id||"",transform:rt.create(n.transform)}),definition:`# A transform with reference and child coordinate frames.
std_msgs/Header header
string child_frame_id
Transform transform`};f.registerMessage("geometry_msgs/msg/Vector3",F);f.registerMessage("geometry_msgs/msg/Point",st);f.registerMessage("geometry_msgs/msg/Quaternion",U);f.registerMessage("geometry_msgs/msg/Pose",it);f.registerMessage("geometry_msgs/msg/PoseStamped",Zt);f.registerMessage("geometry_msgs/msg/Twist",nt);f.registerMessage("geometry_msgs/msg/TwistStamped",te);f.registerMessage("geometry_msgs/msg/Transform",rt);f.registerMessage("geometry_msgs/msg/TransformStamped",ot);const ee={name:"turtlesim/msg/Pose",fields:{x:{type:"float32",default:0},y:{type:"float32",default:0},theta:{type:"float32",default:0},linear_velocity:{type:"float32",default:0},angular_velocity:{type:"float32",default:0}},create:(n={})=>({x:n.x??0,y:n.y??0,theta:n.theta??0,linear_velocity:n.linear_velocity??0,angular_velocity:n.angular_velocity??0}),definition:`# Pose of a turtle in turtlesim.
float32 x
float32 y
float32 theta

float32 linear_velocity
float32 angular_velocity`},se={name:"turtlesim/msg/Color",fields:{r:{type:"uint8",default:0},g:{type:"uint8",default:0},b:{type:"uint8",default:0}},create:(n={})=>({r:n.r??0,g:n.g??0,b:n.b??0}),definition:`# RGB color values.
uint8 r
uint8 g
uint8 b`};f.registerMessage("turtlesim/msg/Pose",ee);f.registerMessage("turtlesim/msg/Color",se);const ie={name:"turtlesim/srv/Spawn",type:"service",request:{x:{type:"float32",default:0},y:{type:"float32",default:0},theta:{type:"float32",default:0},name:{type:"string",default:""}},response:{name:{type:"string"}},createRequest:(n={})=>({x:n.x??5.544445,y:n.y??5.544445,theta:n.theta??0,name:n.name||""}),createResponse:(n={})=>({name:n.name||""}),definition:`# Spawn a new turtle.
float32 x
float32 y
float32 theta
string name
---
string name`},ne={name:"turtlesim/srv/Kill",type:"service",request:{name:{type:"string",default:""}},response:{},createRequest:(n={})=>({name:n.name||""}),createResponse:()=>({}),definition:`# Kill a turtle by name.
string name
---`},re={name:"turtlesim/srv/SetPen",type:"service",request:{r:{type:"uint8",default:0},g:{type:"uint8",default:0},b:{type:"uint8",default:0},width:{type:"uint8",default:1},off:{type:"uint8",default:0}},response:{},createRequest:(n={})=>({r:n.r??255,g:n.g??255,b:n.b??255,width:n.width??3,off:n.off??0}),createResponse:()=>({}),definition:`# Set the pen parameters.
uint8 r
uint8 g
uint8 b
uint8 width
uint8 off
---`},oe={name:"turtlesim/srv/TeleportAbsolute",type:"service",request:{x:{type:"float32",default:0},y:{type:"float32",default:0},theta:{type:"float32",default:0}},response:{},createRequest:(n={})=>({x:n.x??0,y:n.y??0,theta:n.theta??0}),createResponse:()=>({}),definition:`# Teleport the turtle to an absolute position.
float32 x
float32 y
float32 theta
---`},ae={name:"turtlesim/srv/TeleportRelative",type:"service",request:{linear:{type:"float32",default:0},angular:{type:"float32",default:0}},response:{},createRequest:(n={})=>({linear:n.linear??0,angular:n.angular??0}),createResponse:()=>({}),definition:`# Teleport the turtle relative to its current position.
float32 linear
float32 angular
---`};f.registerService("turtlesim/srv/Spawn",ie);f.registerService("turtlesim/srv/Kill",ne);f.registerService("turtlesim/srv/SetPen",re);f.registerService("turtlesim/srv/TeleportAbsolute",oe);f.registerService("turtlesim/srv/TeleportRelative",ae);const le={name:"turtlesim/action/RotateAbsolute",type:"action",goal:{theta:{type:"float32",default:0}},result:{delta:{type:"float32"}},feedback:{remaining:{type:"float32"}},createGoal:(n={})=>({theta:n.theta??0}),createResult:(n={})=>({delta:n.delta??0}),createFeedback:(n={})=>({remaining:n.remaining??0}),definition:`# Rotate the turtle to an absolute orientation.
# Goal
float32 theta
---
# Result
float32 delta
---
# Feedback
float32 remaining`};f.registerAction("turtlesim/action/RotateAbsolute",le);const ce={name:"tf2_msgs/msg/TFMessage",fields:{transforms:{type:"geometry_msgs/msg/TransformStamped[]",default:[]}},create:(n={})=>({transforms:(n.transforms||[]).map(t=>ot.create(t))}),definition:`# TF2 transform message.
geometry_msgs/TransformStamped[] transforms`};f.registerMessage("tf2_msgs/msg/TFMessage",ce);const he={name:"sensor_msgs/msg/LaserScan",fields:{header:{type:"std_msgs/msg/Header"},angle_min:{type:"float32",default:0},angle_max:{type:"float32",default:0},angle_increment:{type:"float32",default:0},time_increment:{type:"float32",default:0},scan_time:{type:"float32",default:0},range_min:{type:"float32",default:0},range_max:{type:"float32",default:0},ranges:{type:"float32[]",default:[]},intensities:{type:"float32[]",default:[]}},create:(n={})=>({header:n.header||{stamp:{sec:0,nanosec:0},frame_id:"laser"},angle_min:n.angle_min??-Math.PI,angle_max:n.angle_max??Math.PI,angle_increment:n.angle_increment??Math.PI/180,time_increment:n.time_increment??0,scan_time:n.scan_time??.1,range_min:n.range_min??.1,range_max:n.range_max??10,ranges:n.ranges||[],intensities:n.intensities||[]}),definition:`# Single scan from a planar laser range-finder.
std_msgs/Header header

float32 angle_min        # start angle of the scan [rad]
float32 angle_max        # end angle of the scan [rad]
float32 angle_increment  # angular distance between measurements [rad]

float32 time_increment   # time between measurements [seconds]
float32 scan_time        # time between scans [seconds]

float32 range_min        # minimum range value [m]
float32 range_max        # maximum range value [m]

float32[] ranges         # range data [m]
float32[] intensities    # intensity data [device-specific units]`},de={name:"sensor_msgs/msg/Imu",fields:{header:{type:"std_msgs/msg/Header"},orientation:{type:"geometry_msgs/msg/Quaternion"},orientation_covariance:{type:"float64[9]",default:new Array(9).fill(0)},angular_velocity:{type:"geometry_msgs/msg/Vector3"},angular_velocity_covariance:{type:"float64[9]",default:new Array(9).fill(0)},linear_acceleration:{type:"geometry_msgs/msg/Vector3"},linear_acceleration_covariance:{type:"float64[9]",default:new Array(9).fill(0)}},create:(n={})=>({header:n.header||{stamp:{sec:0,nanosec:0},frame_id:"imu"},orientation:n.orientation||{x:0,y:0,z:0,w:1},orientation_covariance:n.orientation_covariance||new Array(9).fill(0),angular_velocity:n.angular_velocity||{x:0,y:0,z:0},angular_velocity_covariance:n.angular_velocity_covariance||new Array(9).fill(0),linear_acceleration:n.linear_acceleration||{x:0,y:0,z:0},linear_acceleration_covariance:n.linear_acceleration_covariance||new Array(9).fill(0)}),definition:`# IMU sensor data.
std_msgs/Header header

geometry_msgs/Quaternion orientation
float64[9] orientation_covariance

geometry_msgs/Vector3 angular_velocity
float64[9] angular_velocity_covariance

geometry_msgs/Vector3 linear_acceleration
float64[9] linear_acceleration_covariance`};f.registerMessage("sensor_msgs/msg/LaserScan",he);f.registerMessage("sensor_msgs/msg/Imu",de);const at={name:"nav_msgs/msg/MapMetaData",fields:{map_load_time:{type:"builtin_interfaces/msg/Time",default:{sec:0,nanosec:0}},resolution:{type:"float32",default:.05},width:{type:"uint32",default:0},height:{type:"uint32",default:0},origin:{type:"geometry_msgs/msg/Pose"}},create:(n={})=>({map_load_time:n.map_load_time||{sec:0,nanosec:0},resolution:n.resolution??.05,width:n.width??0,height:n.height??0,origin:n.origin||{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:1}}}),definition:`# Metadata about a map.
builtin_interfaces/Time map_load_time
float32 resolution
uint32 width
uint32 height
geometry_msgs/Pose origin`},ue={name:"nav_msgs/msg/OccupancyGrid",fields:{header:{type:"std_msgs/msg/Header"},info:{type:"nav_msgs/msg/MapMetaData"},data:{type:"int8[]",default:[]}},create:(n={})=>({header:n.header||{stamp:{sec:0,nanosec:0},frame_id:"map"},info:at.create(n.info),data:n.data||[]}),definition:`# 2D occupancy grid map.
# Values: -1 = unknown, 0 = free, 100 = occupied
std_msgs/Header header
MapMetaData info
int8[] data`},me={name:"nav_msgs/msg/Odometry",fields:{header:{type:"std_msgs/msg/Header"},child_frame_id:{type:"string",default:""},pose:{type:"geometry_msgs/msg/PoseWithCovariance"},twist:{type:"geometry_msgs/msg/TwistWithCovariance"}},create:(n={})=>({header:n.header||{stamp:{sec:0,nanosec:0},frame_id:"odom"},child_frame_id:n.child_frame_id||"base_link",pose:n.pose||{pose:{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:1}},covariance:new Array(36).fill(0)},twist:n.twist||{twist:{linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:0}},covariance:new Array(36).fill(0)}}),definition:`# Robot odometry.
std_msgs/Header header
string child_frame_id
geometry_msgs/PoseWithCovariance pose
geometry_msgs/TwistWithCovariance twist`},fe={name:"nav_msgs/msg/Path",fields:{header:{type:"std_msgs/msg/Header"},poses:{type:"geometry_msgs/msg/PoseStamped[]",default:[]}},create:(n={})=>({header:n.header||{stamp:{sec:0,nanosec:0},frame_id:"map"},poses:n.poses||[]}),definition:`# A path represented as a series of poses.
std_msgs/Header header
geometry_msgs/PoseStamped[] poses`};f.registerMessage("nav_msgs/msg/MapMetaData",at);f.registerMessage("nav_msgs/msg/OccupancyGrid",ue);f.registerMessage("nav_msgs/msg/Odometry",me);f.registerMessage("nav_msgs/msg/Path",fe);function pe(n){return f.getMessage(n)}function ge(n){return f.getService(n)}function we(n){return f.getAction(n)}function lt(){return f.listMessages()}function ct(){return f.listServices()}function ht(){return f.listActions()}function be(n){return f.findMessages(n)}function ye(n){return f.findServices(n)}function ve(n){return f.findActions(n)}function _e(n){return f.getDefinition(n)}async function xe(n,t){if(n.length===0){Y(t),t.finishCommand();return}const e=n[0],s=n.slice(1);switch(e){case"list":Te(s,t),t.finishCommand();break;case"info":Se(s,t),t.finishCommand();break;case"type":Ce(s,t),t.finishCommand();break;case"find":Ie(s,t),t.finishCommand();break;case"echo":ke(s,t);break;case"pub":await Le(s,t);break;case"hz":Ee(s,t);break;case"bw":Me(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),Y(t),t.finishCommand()}}function Y(n){n.writeln("usage: ros2 topic <command> [options]"),n.writeln(""),n.writeln("Commands:"),n.writeln("  list    List all active topics"),n.writeln("  info    Show information about a topic"),n.writeln("  type    Show the type of a topic"),n.writeln("  find    Find topics by type"),n.writeln("  echo    Subscribe and print messages"),n.writeln("  pub     Publish a message to a topic"),n.writeln("  hz      Show message rate for a topic"),n.writeln("  bw      Show bandwidth for a topic")}function Te(n,t){const e=n.includes("-t")||n.includes("--show-types"),s=p.getTopics();if(s.length===0){t.writeln("No topics are currently active.");return}for(const i of s.sort((r,o)=>r.name.localeCompare(o.name)))e?t.writeln(`${i.name} [${i.type}]`):t.writeln(i.name)}function Se(n,t){const e=n.includes("--verbose")||n.includes("-v"),s=n.find(r=>!r.startsWith("-"));if(!s){t.writeln("usage: ros2 topic info <topic_name> [--verbose]");return}const i=p.getTopicInfo(s);if(!i){t.writeln(`\x1B[31mTopic '${s}' not found\x1B[0m`);return}if(t.writeln(`Type: ${i.type}`),t.writeln(`Publisher count: ${i.publishers.length}`),t.writeln(`Subscription count: ${i.subscribers.length}`),e){t.writeln(""),t.writeln("Publishers:");for(const r of i.publishers)t.writeln(`  Node: ${r.nodeId}`);t.writeln(""),t.writeln("Subscribers:");for(const r of i.subscribers)t.writeln("  Node: (subscription)")}}function Ce(n,t){if(n.length===0){t.writeln("usage: ros2 topic type <topic_name>");return}const e=n[0],s=p.getTopicInfo(e);if(!s){t.writeln(`\x1B[31mTopic '${e}' not found\x1B[0m`);return}t.writeln(s.type)}function Ie(n,t){if(n.length===0){t.writeln("usage: ros2 topic find <msg_type>");return}const e=n[0],i=p.getTopics().filter(r=>r.type===e);if(i.length===0){t.writeln(`No topics of type '${e}' found.`);return}for(const r of i)t.writeln(r.name)}function ke(n,t){if(n.length===0){t.writeln("usage: ros2 topic echo <topic_name>"),t.finishCommand();return}const e=n[0];let s=p.getTopicInfo(e),i=null,r=null;const o=a=>{i&&p.unsubscribe(i),i=p.subscribe(e,a,l=>{t.writeln("---"),t.writeln(L(l))})};s?o(s.type):(t.writeln(`\x1B[33mTopic '${e}' does not exist yet.\x1B[0m`),t.writeln("\x1B[33mWill start echoing when a publisher creates it...\x1B[0m"),r=setInterval(()=>{const a=p.getTopicInfo(e);a&&a.type!=="unknown"&&(t.writeln(`\x1B[32mTopic '${e}' is now available [${a.type}]\x1B[0m`),clearInterval(r),r=null,o(a.type))},1e3),o("unknown")),t.addSubscription({destroy:()=>{r&&clearInterval(r),i&&p.unsubscribe(i)}})}async function Le(n,t){let e=!1,s=1,i=null,r=null,o=null;for(let u=0;u<n.length;u++){const m=n[u];m==="--once"||m==="-1"?e=!0:m==="-r"||m==="--rate"?s=parseFloat(n[++u])||1:m==="-w"||m==="--wait"?parseInt(n[++u]):i?r?o||(o=m):r=m:i=m}if(!i||!r){t.writeln('usage: ros2 topic pub [--once] [-r RATE] <topic> <msg_type> "<data>"'),t.finishCommand();return}const a=pe(r);if(!a){t.writeln(`\x1B[31mUnknown message type: ${r}\x1B[0m`),t.writeln(""),t.writeln("Available message types matching this pattern:");const u=be(r.split("/").pop());for(const m of u.slice(0,10))t.writeln(`  ${m}`);t.finishCommand();return}const l=o?H(o):{},c=a.create(l);if(t.writeln("publisher: beginning loop"),t.writeln(`publishing #1: ${JSON.stringify(c)}`),p.publish(i,r,c),e){t.finishCommand();return}let h=1;const d=setInterval(()=>{h++,t.writeln(`publishing #${h}: ${JSON.stringify(c)}`),p.publish(i,r,c)},1e3/s);t.addSubscription({destroy:()=>clearInterval(d)})}function Ee(n,t){if(n.length===0){t.writeln("usage: ros2 topic hz <topic_name>"),t.finishCommand();return}const e=n[0],s=p.getTopicInfo(e);s||t.writeln(`\x1B[33mWaiting for topic '${e}'...\x1B[0m`);const i=[],r=100,o=p.subscribe(e,(s==null?void 0:s.type)||"unknown",()=>{const a=Date.now();for(i.push(a);i.length>r;)i.shift();if(i.length>=2){const l=Math.max((i[i.length-1]-i[0])/1e3,.001),c=(i.length-1)/l,h=l/(i.length-1);t.writeln(`\raverage rate: ${c.toFixed(3)} Hz`),t.writeln(`	min: ${(h*.9).toFixed(3)}s max: ${(h*1.1).toFixed(3)}s std dev: ${(h*.05).toFixed(5)}s window: ${i.length}`)}});t.addSubscription({destroy:()=>p.unsubscribe(o)})}function Me(n,t){if(n.length===0){t.writeln("usage: ros2 topic bw <topic_name>"),t.finishCommand();return}const e=n[0],s=p.getTopicInfo(e);s||t.writeln(`\x1B[33mWaiting for topic '${e}'...\x1B[0m`);const i=[],r=100,o=p.subscribe(e,(s==null?void 0:s.type)||"unknown",a=>{const l=Date.now(),c=JSON.stringify(a).length;for(i.push({time:l,size:c});i.length>r;)i.shift();if(i.length>=2){const h=(i[i.length-1].time-i[0].time)/1e3,d=i.reduce((m,b)=>m+b.size,0),u=d/h;t.writeln(`\rSubscribed to [${e}]`),t.writeln(`average: ${(u/1024).toFixed(2)} KB/s`),t.writeln(`	mean: ${(d/i.length).toFixed(2)} B  min: ${Math.min(...i.map(m=>m.size))} B  max: ${Math.max(...i.map(m=>m.size))} B  window: ${i.length}`)}});t.addSubscription({destroy:()=>p.unsubscribe(o)})}w.registerRos2("topic",xe);async function Ae(n,t){if(n.length===0){K(t),t.finishCommand();return}const e=n[0],s=n.slice(1);switch(e){case"list":Pe(s,t),t.finishCommand();break;case"type":$e(s,t),t.finishCommand();break;case"info":Re(s,t),t.finishCommand();break;case"find":De(s,t),t.finishCommand();break;case"call":await Oe(s,t),t.finishCommand();break;case"echo":Ne(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),K(t),t.finishCommand()}}function K(n){n.writeln("usage: ros2 service <command> [options]"),n.writeln(""),n.writeln("Commands:"),n.writeln("  list    List all active services"),n.writeln("  type    Show the type of a service"),n.writeln("  info    Show information about a service"),n.writeln("  find    Find services by type"),n.writeln("  call    Call a service"),n.writeln("  echo    Echo service calls")}function Pe(n,t){const e=n.includes("-t")||n.includes("--show-types"),s=p.getServices();if(s.length===0){t.writeln("No services are currently available.");return}for(const i of s.sort((r,o)=>r.name.localeCompare(o.name)))e?t.writeln(`${i.name} [${i.type}]`):t.writeln(i.name)}function $e(n,t){if(n.length===0){t.writeln("usage: ros2 service type <service_name>");return}const e=n[0],s=p.getServiceInfo(e);if(!s){t.writeln(`\x1B[31mService '${e}' not found\x1B[0m`);return}t.writeln(s.type)}function Re(n,t){if(n.length===0){t.writeln("usage: ros2 service info <service_name>");return}const e=n[0],s=p.getServiceInfo(e);if(!s){t.writeln(`\x1B[31mService '${e}' not found\x1B[0m`);return}t.writeln(`Type: ${s.type}`),t.writeln(`Node: ${s.node}`)}function De(n,t){if(n.length===0){t.writeln("usage: ros2 service find <srv_type>");return}const e=n[0],i=p.getServices().filter(r=>r.type===e);if(i.length===0){t.writeln(`No services of type '${e}' found.`);return}for(const r of i)t.writeln(r.name)}async function Oe(n,t){let e=null,s=null,i=null;for(let c=0;c<n.length;c++){const h=n[c];e?s?i||(i=h):s=h:e=h}if(!e||!s){t.writeln('usage: ros2 service call <service_name> <srv_type> "<request_data>"');return}const r=ge(s);if(!r){t.writeln(`\x1B[31mUnknown service type: ${s}\x1B[0m`),t.writeln(""),t.writeln("Available service types:");const c=ye(s.split("/").pop());for(const h of c.slice(0,10))t.writeln(`  ${h}`);return}if(!p.getServiceInfo(e)){t.writeln(`\x1B[31mService '${e}' not available\x1B[0m`);return}const a=i?H(i):{},l=r.createRequest(a);t.writeln(`requester: making request: ${e}`),t.writeln("");try{const c=await p.callService(e,s,l);t.writeln("response:"),t.writeln(L(c))}catch(c){t.writeln(`\x1B[31mService call failed: ${c.message}\x1B[0m`)}}function Ne(n,t){t.writeln("\x1B[33mService echo is not fully supported in this simulation.\x1B[0m"),t.finishCommand()}w.registerRos2("service",Ae);async function ze(n,t){if(n.length===0){X(t),t.finishCommand();return}const e=n[0],s=n.slice(1);switch(e){case"list":Be(s,t),t.finishCommand();break;case"type":Fe(s,t),t.finishCommand();break;case"info":He(s,t),t.finishCommand();break;case"send_goal":await We(s,t),t.finishCommand();break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),X(t),t.finishCommand()}}function X(n){n.writeln("usage: ros2 action <command> [options]"),n.writeln(""),n.writeln("Commands:"),n.writeln("  list       List all action servers"),n.writeln("  type       Show the type of an action"),n.writeln("  info       Show information about an action"),n.writeln("  send_goal  Send a goal to an action server")}function Be(n,t){const e=n.includes("-t")||n.includes("--show-types"),s=p.getActions();if(s.length===0){t.writeln("No action servers are currently available.");return}for(const i of s.sort((r,o)=>r.name.localeCompare(o.name)))e?t.writeln(`${i.name} [${i.type}]`):t.writeln(i.name)}function Fe(n,t){if(n.length===0){t.writeln("usage: ros2 action type <action_name>");return}const e=n[0],s=p.getActionInfo(e);if(!s){t.writeln(`\x1B[31mAction '${e}' not found\x1B[0m`);return}t.writeln(s.type)}function He(n,t){if(n.length===0){t.writeln("usage: ros2 action info <action_name>");return}const e=n[0],s=p.getActionInfo(e);if(!s){t.writeln(`\x1B[31mAction '${e}' not found\x1B[0m`);return}t.writeln(`Action: ${e}`),t.writeln(`Type: ${s.type}`),t.writeln(`Node: ${s.node}`),t.writeln(""),t.writeln("Action Servers:"),t.writeln(`  ${s.node}`),t.writeln(""),t.writeln("Action Clients:"),t.writeln("  (none)")}async function We(n,t){let e=null,s=null,i=null,r=!1;for(let h=0;h<n.length;h++){const d=n[h];d==="--feedback"||d==="-f"?r=!0:e?s?i||(i=d):s=d:e=d}if(!e||!s){t.writeln('usage: ros2 action send_goal <action_name> <action_type> "<goal>" [--feedback]');return}const o=we(s);if(!o){t.writeln(`\x1B[31mUnknown action type: ${s}\x1B[0m`),t.writeln(""),t.writeln("Available action types:");const h=ve(s.split("/").pop());for(const d of h.slice(0,10))t.writeln(`  ${d}`);return}if(!p.getActionInfo(e)){t.writeln(`\x1B[31mAction '${e}' not available\x1B[0m`);return}const l=i?H(i):{},c=o.createGoal(l);t.writeln("Waiting for an action server to become available..."),t.writeln("Sending goal:"),t.writeln(L(c)),t.writeln("");try{let h=null;r&&(h=u=>{t.writeln("Feedback:"),t.writeln(L(u)),t.writeln("")}),t.writeln("Goal accepted with ID: goal_1"),t.writeln("");const d=await p.sendActionGoal(e,s,c,h);t.writeln("Result:"),t.writeln(L(d)),t.writeln(""),t.writeln("Goal finished with status: SUCCEEDED")}catch(h){t.writeln(`\x1B[31mAction failed: ${h.message}\x1B[0m`)}}w.registerRos2("action",ze);async function Ge(n,t){if(n.length===0){j(t),t.finishCommand();return}const e=n[0],s=n.slice(1);switch(e){case"list":Ue(s,t);break;case"get":Ve(s,t);break;case"set":qe(s,t);break;case"dump":Ye(s,t);break;case"load":Ke(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),j(t)}t.finishCommand()}function j(n){n.writeln("usage: ros2 param <command> [options]"),n.writeln(""),n.writeln("Commands:"),n.writeln("  list    List all parameters"),n.writeln("  get     Get a parameter value"),n.writeln("  set     Set a parameter value"),n.writeln("  dump    Dump all parameters for a node"),n.writeln("  load    Load parameters from a file (not supported in sim)")}function W(n){return n?n.startsWith("/")?n:"/"+n:null}function O(n){return I.getProcessByNodeName(n)}function Ue(n,t){const e=n.length>0?W(n[0]):null;if(e){const s=O(e);if(!s){t.writeln(`\x1B[31mNode '${e}' not found\x1B[0m`);return}const i=s.node.getParameterNames();if(i.length===0){t.writeln("No parameters.");return}t.writeln(`${e}:`);for(const r of i.sort())t.writeln(`  ${r}`)}else{const s=p.getNodes();for(const i of s.sort()){const r=O(i);if(r&&r.node){const o=r.node.getParameterNames();if(o.length>0){t.writeln(`${i}:`);for(const a of o.sort())t.writeln(`  ${a}`)}}}}}function Ve(n,t){if(n.length<2){t.writeln("usage: ros2 param get <node_name> <parameter_name>");return}const e=W(n[0]),s=n[1],i=O(e);if(!i){t.writeln(`\x1B[31mNode '${e}' not found\x1B[0m`);return}const r=i.node.getParameter(s);if(r===void 0){t.writeln(`\x1B[31mParameter '${s}' not found on node '${e}'\x1B[0m`);return}t.writeln(`${s}: ${G(r)}`)}function qe(n,t){if(n.length<3){t.writeln("usage: ros2 param set <node_name> <parameter_name> <value>");return}const e=W(n[0]),s=n[1],i=n.slice(2).join(" "),r=O(e);if(!r){t.writeln(`\x1B[31mNode '${e}' not found\x1B[0m`);return}const o=Xe(i);if(!r.node.setParameter(s,o)){t.writeln(`\x1B[31mParameter '${s}' not found on node '${e}'\x1B[0m`);return}t.writeln(`Set parameter '${s}' to: ${G(o)}`)}function Ye(n,t){if(n.length<1){t.writeln("usage: ros2 param dump <node_name>");return}const e=W(n[0]),s=O(e);if(!s){t.writeln(`\x1B[31mNode '${e}' not found\x1B[0m`);return}const i=s.node.getParameterNames();if(i.length===0){t.writeln("No parameters.");return}t.writeln(`${e}:`),t.writeln("  ros__parameters:");for(const r of i.sort()){const o=s.node.getParameter(r);t.writeln(`    ${r}: ${G(o)}`)}}function Ke(n,t){t.writeln("\x1B[33mParameter file loading is not supported in this simulation.\x1B[0m"),t.writeln("Use ros2 param set to set individual parameters.")}function Xe(n){if(n==="true")return!0;if(n==="false")return!1;const t=Number(n);return isNaN(t)?n.startsWith('"')&&n.endsWith('"')||n.startsWith("'")&&n.endsWith("'")?n.slice(1,-1):n:t}function G(n){return typeof n=="string"?`"${n}"`:typeof n=="boolean"?n?"true":"false":typeof n=="number"?Number.isInteger(n)?n.toString():n.toFixed(6):Array.isArray(n)?`[${n.map(G).join(", ")}]`:String(n)}w.registerRos2("param",Ge);class ${constructor(t,e=[]){this.name=t,this.topics=e,this.messages=[],this.subscriptions=[],this.recording=!1,this.startTime=null,this.endTime=null}start(){if(!this.recording){this.recording=!0,this.startTime=Date.now(),this.messages=[];for(const t of this.topics){const e=p.getTopicInfo(t);if(e){const s=p.subscribe(t,e.type,i=>{this.recording&&this.messages.push({topic:t,type:e.type,timestamp:Date.now()-this.startTime,message:{...i}})});this.subscriptions.push(s)}}}}stop(){if(this.recording){this.recording=!1,this.endTime=Date.now();for(const t of this.subscriptions)p.unsubscribe(t);this.subscriptions=[]}}getInfo(){const t={};for(const e of this.messages)t[e.topic]=(t[e.topic]||0)+1;return{name:this.name,duration:this.endTime?(this.endTime-this.startTime)/1e3:null,startTime:this.startTime,endTime:this.endTime,messageCount:this.messages.length,topics:this.topics,topicCounts:t}}getMessages(){return this.messages}toJSON(){return{name:this.name,startTime:this.startTime,endTime:this.endTime,topics:this.topics,messages:this.messages}}static fromJSON(t){const e=new $(t.name,t.topics);return e.startTime=t.startTime,e.endTime=t.endTime,e.messages=t.messages,e}saveToStorage(){try{const t=`ros2bag_${this.name}`;return localStorage.setItem(t,JSON.stringify(this.toJSON())),!0}catch(t){return console.error("Failed to save bag to localStorage:",t),!1}}static loadFromStorage(t){try{const e=`ros2bag_${t}`,s=localStorage.getItem(e);if(s)return $.fromJSON(JSON.parse(s))}catch(e){console.error("Failed to load bag from localStorage:",e)}return null}static listStoredBags(){const t=[];for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e);s.startsWith("ros2bag_")&&t.push(s.substring(8))}return t}static deleteFromStorage(t){const e=`ros2bag_${t}`;localStorage.removeItem(e)}}class je{constructor(){this.bags=new Map}store(t){this.bags.set(t.name,t)}get(t){return this.bags.has(t)?this.bags.get(t):$.loadFromStorage(t)}list(){const t=Array.from(this.bags.keys()),e=$.listStoredBags();return[...new Set([...t,...e])]}delete(t){this.bags.delete(t),$.deleteFromStorage(t)}}const R=new je;class Qe{constructor(t){this.recorder=t,this.messages=t.getMessages(),this.playing=!1,this.paused=!1,this.rate=1,this.currentIndex=0,this.playStartTime=null,this.pauseTime=null,this.timeouts=[],this.onComplete=null,this.onMessage=null,this.playbackId=0}play(t=1){this.playing||(this.rate=t,this.playing=!0,this.paused=!1,this.currentIndex=0,this.playStartTime=Date.now(),this.playbackId++,this._scheduleMessages())}_scheduleMessages(){this._clearTimeouts();const t=this.playbackId;for(let e=this.currentIndex;e<this.messages.length;e++){const s=this.messages[e],i=s.timestamp/this.rate,r=setTimeout(()=>{t===this.playbackId&&this.playing&&!this.paused&&(this._publishMessage(s),this.currentIndex=e+1,this.currentIndex>=this.messages.length&&(this.stop(),this.onComplete&&this.onComplete()))},i);this.timeouts.push(r)}}_publishMessage(t){p.publish(t.topic,t.type,t.message),this.onMessage&&this.onMessage(t)}_clearTimeouts(){for(const t of this.timeouts)clearTimeout(t);this.timeouts=[]}pause(){!this.playing||this.paused||(this.paused=!0,this.pauseTime=Date.now(),this._clearTimeouts())}resume(){if(!this.playing||!this.paused)return;this.paused=!1;const t=Date.now()-this.pauseTime;this.playStartTime+=t,this._scheduleRemainingMessages()}_scheduleRemainingMessages(){const t=(Date.now()-this.playStartTime)*this.rate,e=this.playbackId;for(let s=this.currentIndex;s<this.messages.length;s++){const i=this.messages[s],r=Math.max(0,(i.timestamp-t)/this.rate),o=setTimeout(()=>{e===this.playbackId&&this.playing&&!this.paused&&(this._publishMessage(i),this.currentIndex=s+1,this.currentIndex>=this.messages.length&&(this.stop(),this.onComplete&&this.onComplete()))},r);this.timeouts.push(o)}}stop(){this._clearTimeouts(),this.playbackId++,this.playing=!1,this.paused=!1}setRate(t){this.playing&&!this.paused?(this._clearTimeouts(),this.playbackId++,this.paused=!0,this.pauseTime=Date.now(),this.rate=t,this.resume()):this.rate=t}getStatus(){return{playing:this.playing,paused:this.paused,rate:this.rate,progress:this.currentIndex/this.messages.length,currentIndex:this.currentIndex,totalMessages:this.messages.length}}}async function Je(n,t){if(n.length===0){Q(t),t.finishCommand();return}const e=n[0],s=n.slice(1);switch(e){case"record":Ze(s,t);break;case"play":await ts(s,t),t.finishCommand();break;case"info":es(s,t),t.finishCommand();break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),Q(t),t.finishCommand()}}function Q(n){n.writeln("usage: ros2 bag <command> [options]"),n.writeln(""),n.writeln("Commands:"),n.writeln("  record  Record topics to a bag"),n.writeln("  play    Play back a recorded bag"),n.writeln("  info    Show information about a bag")}function Ze(n,t){let e=!1,s=`rosbag2_${Date.now()}`;const i=[];for(let a=0;a<n.length;a++){const l=n[a];l==="-a"||l==="--all"?e=!0:l==="-o"||l==="--output"?a+1<n.length&&(s=n[++a]):l.startsWith("-")||i.push(l)}let r=i;if(e&&(r=p.getTopics().map(a=>a.name),r.length===0)){t.writeln("\x1B[33mNo topics available to record.\x1B[0m"),t.finishCommand();return}if(r.length===0){t.writeln("usage: ros2 bag record [-a] [-o <bag_name>] <topic1> <topic2> ..."),t.finishCommand();return}const o=new $(s,r);o.start(),t.writeln(`\x1B[32m[INFO] Recording to '${s}'\x1B[0m`),t.writeln("Topics:");for(const a of r)t.writeln(`  ${a}`);t.writeln(""),t.writeln("Press Ctrl+C to stop recording..."),t.addBagRecorder({stop:()=>{var l;o.stop(),R.store(o);const a=o.getInfo();t.writeln(""),t.writeln("\x1B[32m[INFO] Stopped recording.\x1B[0m"),t.writeln(`Bag: ${s}`),t.writeln(`Duration: ${((l=a.duration)==null?void 0:l.toFixed(2))||0}s`),t.writeln(`Messages: ${a.messageCount}`)}})}async function ts(n,t){var a;let e=null,s=1;for(let l=0;l<n.length;l++){const c=n[l];c==="--rate"||c==="-r"?l+1<n.length&&(s=parseFloat(n[++l])||1):c.startsWith("-")||(e=c)}if(!e){t.writeln("usage: ros2 bag play <bag_name> [--rate N]"),t.writeln(""),t.writeln("Available bags:");const l=R.list();for(const c of l)t.writeln(`  ${c}`);return}const i=R.get(e);if(!i){t.writeln(`\x1B[31mBag '${e}' not found.\x1B[0m`),t.writeln(""),t.writeln("Available bags:");const l=R.list();for(const c of l)t.writeln(`  ${c}`);return}const r=i.getInfo();t.writeln(`\x1B[32m[INFO] Playing bag '${e}'\x1B[0m`),t.writeln(`Duration: ${((a=r.duration)==null?void 0:a.toFixed(2))||0}s`),t.writeln(`Rate: ${s}x`),t.writeln("");const o=new Qe(i);return new Promise(l=>{o.onComplete=()=>{t.writeln(""),t.writeln("\x1B[32m[INFO] Playback complete.\x1B[0m"),l()},o.onMessage=c=>{},o.play(s)})}function es(n,t){var r;if(n.length===0){t.writeln("usage: ros2 bag info <bag_name>"),t.writeln(""),t.writeln("Available bags:");const o=R.list();for(const a of o)t.writeln(`  ${a}`);return}const e=n[0],s=R.get(e);if(!s){t.writeln(`\x1B[31mBag '${e}' not found.\x1B[0m`);return}const i=s.getInfo();t.writeln(`Bag: ${i.name}`),t.writeln(`Duration: ${((r=i.duration)==null?void 0:r.toFixed(2))||0}s`),t.writeln(`Messages: ${i.messageCount}`),t.writeln(""),t.writeln("Topics:");for(const o of i.topics){const a=i.topicCounts[o]||0;t.writeln(`  ${o}: ${a} messages`)}}w.registerRos2("bag",Je);async function ss(n,t){if(n.length===0){J(t),t.finishCommand();return}const e=n[0],s=n.slice(1);switch(e){case"show":is(s,t);break;case"list":ns(s,t);break;case"package":rs(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),J(t)}t.finishCommand()}function J(n){n.writeln("usage: ros2 interface <command> [options]"),n.writeln(""),n.writeln("Commands:"),n.writeln("  show      Show the definition of an interface"),n.writeln("  list      List all available interfaces"),n.writeln("  package   List interfaces in a package")}function is(n,t){if(n.length===0){t.writeln("usage: ros2 interface show <interface_type>");return}const e=n[0],s=_e(e);if(!s){t.writeln(`\x1B[31mInterface '${e}' not found.\x1B[0m`),t.writeln(""),t.writeln('Use "ros2 interface list" to see available interfaces.');return}t.writeln(s)}function ns(n,t){const e=n.includes("-m")||n.includes("--only-msgs"),s=n.includes("-s")||n.includes("--only-srvs"),i=n.includes("-a")||n.includes("--only-actions"),r=!e&&!s&&!i;if(r||e){t.writeln("Messages:");for(const o of lt().sort())t.writeln(`  ${o}`);t.writeln("")}if(r||s){t.writeln("Services:");for(const o of ct().sort())t.writeln(`  ${o}`);t.writeln("")}if(r||i){t.writeln("Actions:");for(const o of ht().sort())t.writeln(`  ${o}`)}}function rs(n,t){if(n.length===0){t.writeln("usage: ros2 interface package <package_name>");return}const e=n[0],s=e+"/",i=lt().filter(a=>a.startsWith(s)),r=ct().filter(a=>a.startsWith(s)),o=ht().filter(a=>a.startsWith(s));if(i.length===0&&r.length===0&&o.length===0){t.writeln(`\x1B[31mNo interfaces found in package '${e}'.\x1B[0m`);return}for(const a of i.sort())t.writeln(a);for(const a of r.sort())t.writeln(a);for(const a of o.sort())t.writeln(a)}w.registerRos2("interface",ss);async function os(n,t){if(n.length===0){Z(t),t.finishCommand();return}const e=n[0],s=n.slice(1);switch(e){case"executables":as(s,t);break;case"list":ls(s,t);break;default:t.writeln(`\x1B[31mUnknown subcommand: ${e}\x1B[0m`),Z(t)}t.finishCommand()}function Z(n){n.writeln("usage: ros2 pkg <command> [options]"),n.writeln(""),n.writeln("Commands:"),n.writeln("  executables   List executables in a package"),n.writeln("  list          List available packages")}function as(n,t){if(n.length===0){const i=x.listPackages();for(const r of i.sort()){const o=x.listExecutables(r);for(const a of o.sort())t.writeln(`${r} ${a}`)}return}const e=n[0],s=x.listExecutables(e);if(s.length===0){t.writeln(`\x1B[31mPackage '${e}' not found or has no executables.\x1B[0m`);return}for(const i of s.sort())t.writeln(`${e} ${i}`)}function ls(n,t){const e=x.listPackages();if(e.length===0){t.writeln("No packages available.");return}for(const s of e.sort())t.writeln(s)}w.registerRos2("pkg",os);function cs(n,t){return t.clear(),t.finishCommand(),!0}function hs(n,t){const e=n.includes("-a")||n.includes("-la")||n.includes("-al"),s=n.includes("-l")||n.includes("-la")||n.includes("-al"),i=[{name:"src",type:"d",size:4096},{name:"install",type:"d",size:4096},{name:"build",type:"d",size:4096},{name:"log",type:"d",size:4096},{name:"package.xml",type:"-",size:1024},{name:"CMakeLists.txt",type:"-",size:2048},{name:"setup.py",type:"-",size:512}],o=e?[...[{name:".",type:"d",size:4096},{name:"..",type:"d",size:4096},{name:".colcon",type:"d",size:4096}],...i]:i;if(s){t.writeln("total "+o.length);for(const a of o){const l=a.type==="d"?"drwxr-xr-x":"-rw-r--r--",c=String(a.size).padStart(6),h="Jan 27 12:00",d=a.type==="d"?"\x1B[34m":"",u=a.type==="d"?"\x1B[0m":"";t.writeln(`${l} 1 ros2 ros2 ${c} ${h} ${d}${a.name}${u}`)}}else{const a=o.map(l=>{const c=l.type==="d"?"\x1B[34m":"",h=l.type==="d"?"\x1B[0m":"";return`${c}${l.name}${h}`});t.writeln(a.join("  "))}return t.finishCommand(),!0}function ds(n,t){return t.writeln("/home/ros2/ws"),t.finishCommand(),!0}function us(n,t){return t.writeln("cd: Simulated filesystem - directory change not supported"),t.finishCommand(),!0}function dt(n,t){return n.length>0&&t.writeln(n.join(" ")),t.finishCommand(),!0}function ms(n,t){return t.writeln("ros2"),t.finishCommand(),!0}function fs(n,t){return t.writeln("ROS2WebSim 1.0.0"),t.finishCommand(),!0}function ut(n,t){return t.writeln("Use Ctrl+C to stop running commands."),t.writeln("Close terminal tabs with the X button."),t.finishCommand(),!0}w.register("clear",cs);w.register("ls",hs);w.register("pwd",ds);w.register("cd",us);w.register("cat",dt);w.register("echo",dt);w.register("whoami",ms);w.register("uname",fs);w.register("exit",ut);w.register("quit",ut);function ps(n,t){return t.writeln("ROS2 Web Emulator - Available Commands:"),t.writeln(""),t.writeln("\x1B[33mROS2 Commands:\x1B[0m"),t.writeln('  ros2 <subcommand>  - ROS2 CLI commands (type "ros2 --help")'),t.writeln("  rqt               - Open rqt tool selector"),t.writeln("  rqt_graph         - Open node graph visualization"),t.writeln("  rqt_console       - Open log console"),t.writeln(""),t.writeln("\x1B[33mShell Commands:\x1B[0m"),t.writeln("  ls [-la]          - List directory contents"),t.writeln("  pwd               - Print working directory"),t.writeln("  clear             - Clear the terminal"),t.writeln("  echo <text>       - Print text"),t.writeln("  whoami            - Print current user"),t.writeln("  help              - Show this help message"),t.writeln(""),t.writeln('Type "ros2 --help" for ros2 subcommands.'),t.finishCommand(),!0}w.register("help",ps);function gs(n,t){return window.dispatchEvent(new CustomEvent(g.OPEN_RQT_MODAL)),t.finishCommand(),!0}function ws(n,t){return window.dispatchEvent(new CustomEvent(g.TOGGLE_GRAPH)),t.writeln("Opening rqt_graph..."),t.finishCommand(),!0}function bs(n,t){return window.dispatchEvent(new CustomEvent(g.TOGGLE_CONSOLE)),t.writeln("Opening rqt_console..."),t.finishCommand(),!0}w.register("rqt",gs);w.register("rqt_graph",ws);w.register("rqt_console",bs);function tt(n){n.writeln("usage: ros2 <command> [options]"),n.writeln(""),n.writeln("Commands:"),n.writeln("  run        Run an executable from a package"),n.writeln("  node       Node-related commands"),n.writeln("  topic      Topic-related commands"),n.writeln("  service    Service-related commands"),n.writeln("  action     Action-related commands"),n.writeln("  param      Parameter-related commands"),n.writeln("  bag        Bag file commands"),n.writeln("  interface  Interface introspection"),n.writeln("  pkg        Package-related commands")}async function ys(n,t){if(n.length===0||n[0]==="--help"||n[0]==="-h")return tt(t),t.finishCommand(),!0;const e=n[0],s=n.slice(1);return await w.executeRos2(e,s,t)||(t.writeln(`\x1B[31mUnknown ros2 command: ${e}\x1B[0m`),tt(t),t.finishCommand()),!0}w.register("ros2",ys);async function et(n,t){const e=n.trim();if(!e){t.finishCommand();return}const s=vs(e);if(s.length===0){t.finishCommand();return}const i=s[0],r=s.slice(1);await w.execute(i,r,t)||(t.writeln(`\x1B[31mCommand not found: ${i}\x1B[0m`),t.writeln('Type "help" for available commands.'),t.finishCommand())}function vs(n){const t=[];let e="",s=!1,i="",r=0;for(;r<n.length;){const o=n[r];if((o==='"'||o==="'")&&!s){s=!0,i=o,r++;continue}if(s&&o===i){s=!1,i="",r++;continue}if(o===" "&&!s){e&&(t.push(e),e=""),r++;continue}e+=o,r++}return e&&t.push(e),t}class N{constructor(t,e={}){if(this.name=t,this.namespace=e.namespace||"",this.fullName=this.namespace?`${this.namespace}/${t}`:`/${t}`,this.publishers=[],this.subscriptions=[],this.services=[],this.actionServers=[],this.timers=[],this.parameters=new Map,this.running=!1,this.simDDS=e.simDDS||D.get("simDDS")||p,this.logManager=e.logManager||D.get("logManager")||S,this.logger=this.logManager.getLogger(this.fullName),this.simDDS.registerNode(this.fullName,{name:this.name,namespace:this.namespace}),e.parameters)for(const[s,i]of Object.entries(e.parameters))this.declareParameter(s,i)}declareParameter(t,e){return this.parameters.has(t)||this.parameters.set(t,e),this.parameters.get(t)}getParameter(t){return this.parameters.get(t)}setParameter(t,e){return this.parameters.has(t)?(this.parameters.set(t,e),this.onParameterChange(t,e),!0):!1}getParameterNames(){return Array.from(this.parameters.keys())}onParameterChange(t,e){}createPublisher(t,e){const s=this.simDDS.createPublisher(this.fullName,t,e);return this.publishers.push(s),s}createSubscription(t,e,s){const i=this.simDDS.createSubscription(this.fullName,t,e,s.bind(this));return this.subscriptions.push(i),i}createService(t,e,s){const i=this.simDDS.createService(this.fullName,t,e,s.bind(this));return this.services.push(i),i}createActionServer(t,e,s){var o,a;const i={executeCallback:s.executeCallback.bind(this),goalCallback:(o=s.goalCallback)==null?void 0:o.bind(this),cancelCallback:(a=s.cancelCallback)==null?void 0:a.bind(this)},r=this.simDDS.createActionServer(this.fullName,t,e,i);return this.actionServers.push(r),r}createTimer(t,e){const s=setInterval(()=>{this.running&&e.call(this)},t);return this.timers.push(s),s}cancelTimer(t){clearInterval(t);const e=this.timers.indexOf(t);e>=0&&this.timers.splice(e,1)}now(){return{sec:Math.floor(Date.now()/1e3),nanosec:Date.now()%1e3*1e6}}logDebug(t){this.logger.debug(t)}logInfo(t){this.logger.info(t)}logWarn(t){this.logger.warn(t)}logError(t){this.logger.error(t)}logFatal(t){this.logger.fatal(t)}onInit(){}onShutdown(){}start(){this.running=!0,this.onInit(),this.logInfo("Node started")}destroy(){this.running=!1,this.onShutdown();for(const t of this.timers)clearInterval(t);this.timers=[],this.logInfo("Node destroyed"),this.publishers=[],this.subscriptions=[],this.services=[],this.actionServers=[],this.simDDS.unregisterNode(this.fullName)}}class _s extends N{constructor(t="turtlesim",e={}){super(t,{...e,parameters:{background_r:69,background_g:86,background_b:255,...e.parameters}}),this.turtles=new Map,this.canvas=null,this.ctx=null,this.turtleImage=null,this.turtleImageLoaded=!1,this.trails=[],this.updateRate=60,this.publishRate=10,this.lastPosePublish=0,this.lidarEnabled=!0,this.lidarPublishRate=10,this.lastLidarPublish=0}onInit(){this._spawnTurtle("turtle1",5.544445,5.544445,0),this.createService("/spawn","turtlesim/srv/Spawn",this._handleSpawn.bind(this)),this.createService("/kill","turtlesim/srv/Kill",this._handleKill.bind(this)),this.createService("/clear","turtlesim/srv/Empty",this._handleClear.bind(this)),this.createService("/reset","turtlesim/srv/Empty",this._handleReset.bind(this)),this.createTimer(1e3/this.updateRate,this._update.bind(this)),this._notifyCanvas(),this.logInfo("Turtlesim node started")}onShutdown(){for(const[t,e]of this.turtles)e.activeActionInterval&&(clearInterval(e.activeActionInterval),e.activeActionInterval=null),_.removeTurtle(t);this.turtles.clear(),this.trails=[]}onParameterChange(t,e){t.startsWith("background_")&&this._notifyCanvas()}_spawnTurtle(t,e,s,i){if(this.turtles.has(t))return null;const r={name:t,x:e,y:s,theta:i,linearVelocity:0,angularVelocity:0,pen:{r:184,g:184,b:184,width:3,off:!1},activeActionInterval:null};this.turtles.set(t,r),_.registerTurtle(t,e,s,i);const o=`/${t}`;return r.posePub=this.createPublisher(`${o}/pose`,"turtlesim/msg/Pose"),r.colorPub=this.createPublisher(`${o}/color_sensor`,"turtlesim/msg/Color"),r.cmdVelSub=this.createSubscription(`${o}/cmd_vel`,"geometry_msgs/msg/Twist",a=>this._handleCmdVel(t,a)),r.setPenService=this.createService(`${o}/set_pen`,"turtlesim/srv/SetPen",a=>this._handleSetPen(t,a)),r.teleportAbsService=this.createService(`${o}/teleport_absolute`,"turtlesim/srv/TeleportAbsolute",a=>this._handleTeleportAbsolute(t,a)),r.teleportRelService=this.createService(`${o}/teleport_relative`,"turtlesim/srv/TeleportRelative",a=>this._handleTeleportRelative(t,a)),t==="turtle1"&&(r.rotateAbsAction=this.createActionServer(`${o}/rotate_absolute`,"turtlesim/action/RotateAbsolute",{executeCallback:(a,l,c,h)=>this._executeRotateAbsolute(t,a,c,h),goalCallback:()=>!0}),this.lidarEnabled&&(r.scanPub=this.createPublisher("/scan","sensor_msgs/msg/LaserScan"))),this.logInfo(`Spawned turtle '${t}' at (${e.toFixed(2)}, ${s.toFixed(2)})`),t}_handleSpawn(t){let e=t.name;if(!e){let i=1;for(;this.turtles.has(`turtle${i}`);)i++;e=`turtle${i}`}return{name:this._spawnTurtle(e,t.x,t.y,t.theta)||""}}_handleKill(t){const e=this.turtles.get(t.name);if(!e)throw new Error(`Turtle '${t.name}' not found`);return e.activeActionInterval&&(clearInterval(e.activeActionInterval),e.activeActionInterval=null),e.posePub&&e.posePub.destroy(),e.colorPub&&e.colorPub.destroy(),e.cmdVelSub&&e.cmdVelSub.destroy(),e.setPenService&&e.setPenService.destroy(),e.teleportAbsService&&e.teleportAbsService.destroy(),e.teleportRelService&&e.teleportRelService.destroy(),e.rotateAbsAction&&e.rotateAbsAction.destroy(),e.scanPub&&e.scanPub.destroy(),this.turtles.delete(t.name),_.removeTurtle(t.name),this.logInfo(`Killed turtle '${t.name}'`),{}}_handleClear(){return this.trails=[],this._notifyCanvas(),{}}_handleReset(){for(const[e]of this.turtles)e!=="turtle1"&&this._handleKill({name:e});const t=this.turtles.get("turtle1");return t&&(t.x=5.544445,t.y=5.544445,t.theta=0,t.linearVelocity=0,t.angularVelocity=0,_.updateTurtle("turtle1",t.x,t.y,t.theta)),this.trails=[],this._notifyCanvas(),{}}_handleCmdVel(t,e){var i,r;const s=this.turtles.get(t);s&&(s.linearVelocity=((i=e.linear)==null?void 0:i.x)||0,s.angularVelocity=((r=e.angular)==null?void 0:r.z)||0)}_handleSetPen(t,e){const s=this.turtles.get(t);if(!s)throw new Error(`Turtle '${t}' not found`);return s.pen={r:e.r,g:e.g,b:e.b,width:e.width,off:e.off!==0},{}}_handleTeleportAbsolute(t,e){const s=this.turtles.get(t);if(!s)throw new Error(`Turtle '${t}' not found`);return s.x=e.x,s.y=e.y,s.theta=e.theta,_.updateTurtle(t,s.x,s.y,s.theta),{}}_handleTeleportRelative(t,e){const s=this.turtles.get(t);if(!s)throw new Error(`Turtle '${t}' not found`);return s.theta+=e.angular,s.x+=Math.cos(s.theta)*e.linear,s.y+=Math.sin(s.theta)*e.linear,_.updateTurtle(t,s.x,s.y,s.theta),{}}async _executeRotateAbsolute(t,e,s,i){const r=this.turtles.get(t);if(!r)throw new Error(`Turtle '${t}' not found`);r.activeActionInterval&&(clearInterval(r.activeActionInterval),r.activeActionInterval=null);const o=e.theta,a=r.theta;let l=o-r.theta;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;const c=1,h=l>0?1:-1,d=Math.abs(l);let u=0;return new Promise(m=>{const b=setInterval(()=>{if(i()){clearInterval(b),r.activeActionInterval=null,m({delta:u*h});return}const y=c/30;if(u+=y,u>=d)r.theta=o,clearInterval(b),r.activeActionInterval=null,m({delta:d*h});else{r.theta=a+u*h,_.updateTurtle(t,r.x,r.y,r.theta);const v=d-u;s({remaining:v})}},33.333333333333336);r.activeActionInterval=b})}_update(){const t=1/this.updateRate,e=Date.now();for(const[s,i]of this.turtles){const r=i.x,o=i.y;if(i.linearVelocity!==0||i.angularVelocity!==0){for(i.theta+=i.angularVelocity*t;i.theta>Math.PI;)i.theta-=2*Math.PI;for(;i.theta<-Math.PI;)i.theta+=2*Math.PI;const a=i.x+Math.cos(i.theta)*i.linearVelocity*t,l=i.y+Math.sin(i.theta)*i.linearVelocity*t;i.x=Math.max(0,Math.min(11,a)),i.y=Math.max(0,Math.min(11,l)),_.updateTurtle(s,i.x,i.y,i.theta),!i.pen.off&&(i.x!==r||i.y!==o)&&this.trails.push({x1:r,y1:o,x2:i.x,y2:i.y,color:`rgb(${i.pen.r}, ${i.pen.g}, ${i.pen.b})`,width:i.pen.width})}if(e-this.lastPosePublish>=1e3/this.publishRate){const a={x:i.x,y:i.y,theta:i.theta,linear_velocity:i.linearVelocity,angular_velocity:i.angularVelocity};i.posePub.publish(a)}if(s==="turtle1"&&this.lidarEnabled&&i.scanPub&&e-this.lastLidarPublish>=1e3/this.lidarPublishRate){const a=_.lidarScan(i.x,i.y,i.theta,{angleMin:-Math.PI,angleMax:Math.PI,numRays:360,rangeMax:10});a.header={stamp:this.now(),frame_id:"base_link"},i.scanPub.publish(a),this.lastLidarPublish=e}}e-this.lastPosePublish>=1e3/this.publishRate&&(this.lastPosePublish=e),this._notifyCanvas()}_notifyCanvas(){window.dispatchEvent(new CustomEvent(g.TURTLESIM_UPDATE,{detail:{turtles:Array.from(this.turtles.values()),trails:this.trails,background:{r:this.getParameter("background_r"),g:this.getParameter("background_g"),b:this.getParameter("background_b")}}}))}getTurtleData(){return{turtles:Array.from(this.turtles.values()),trails:this.trails,background:{r:this.getParameter("background_r"),g:this.getParameter("background_g"),b:this.getParameter("background_b")}}}}x.register("turtlesim","turtlesim_node",_s);class xs extends N{constructor(t="turtle_teleop_key",e={}){var s;super(t,{...e,parameters:{scale_linear:2,scale_angular:2,...e.parameters}}),this.targetTopic=((s=e.remappings)==null?void 0:s.cmd_vel)||"/turtle1/cmd_vel",this.keyHandler=null,this.activeKeys=new Set}onInit(){this.cmdVelPub=this.createPublisher(this.targetTopic,"geometry_msgs/msg/Twist"),this.keyHandler=this._handleKeyDown.bind(this),this.keyUpHandler=this._handleKeyUp.bind(this),window.addEventListener("keydown",this.keyHandler),window.addEventListener("keyup",this.keyUpHandler),this.createTimer(100,this._publishVelocity.bind(this)),this.logInfo("Turtle teleop started. Use arrow keys to move the turtle."),this.logInfo(`Publishing to: ${this.targetTopic}`),window.dispatchEvent(new CustomEvent(g.TELEOP_ACTIVE,{detail:{type:"arrow-keys",node:this.fullName}}))}onShutdown(){this.keyHandler&&(window.removeEventListener("keydown",this.keyHandler),window.removeEventListener("keyup",this.keyUpHandler)),this.activeKeys.clear(),window.dispatchEvent(new CustomEvent(g.TELEOP_INACTIVE,{detail:{node:this.fullName}}))}_handleKeyDown(t){["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key)&&(t.preventDefault(),this.activeKeys.add(t.key))}_handleKeyUp(t){["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key)&&(t.preventDefault(),this.activeKeys.delete(t.key))}_publishVelocity(){const t=this.getParameter("scale_linear"),e=this.getParameter("scale_angular");let s=0,i=0;if(this.activeKeys.has("ArrowUp")&&(s+=t),this.activeKeys.has("ArrowDown")&&(s-=t),this.activeKeys.has("ArrowLeft")&&(i+=e),this.activeKeys.has("ArrowRight")&&(i-=e),s!==0||i!==0||this.lastVelocity){const r={linear:{x:s,y:0,z:0},angular:{x:0,y:0,z:i}};this.cmdVelPub.publish(r),this.lastVelocity=s!==0||i!==0}}}x.register("turtlesim","turtle_teleop_key",xs);class Ts extends N{constructor(t="teleop_twist_keyboard",e={}){var s;super(t,{...e,parameters:{speed:.5,turn:1,speed_limit:2,turn_limit:2,...e.parameters}}),this.targetTopic=((s=e.remappings)==null?void 0:s.cmd_vel)||"/turtle1/cmd_vel",this.keyHandler=null,this.keyUpHandler=null,this.activeKeys=new Set,this.currentSpeed=.5,this.currentTurn=1}onInit(){this.cmdVelPub=this.createPublisher(this.targetTopic,"geometry_msgs/msg/Twist"),this.keyHandler=this._handleKeyDown.bind(this),this.keyUpHandler=this._handleKeyUp.bind(this),window.addEventListener("keydown",this.keyHandler),window.addEventListener("keyup",this.keyUpHandler),this.createTimer(100,this._publishVelocity.bind(this)),this.logInfo("Teleop Twist Keyboard started."),this.logInfo("W/S: forward/back, A/D: turn, Q/E: diagonal, X: stop"),this.logInfo(`Publishing to: ${this.targetTopic}`),window.dispatchEvent(new CustomEvent(g.TELEOP_ACTIVE,{detail:{type:"wasd-keys",node:this.fullName}}))}onShutdown(){this.keyHandler&&(window.removeEventListener("keydown",this.keyHandler),window.removeEventListener("keyup",this.keyUpHandler)),this.activeKeys.clear(),window.dispatchEvent(new CustomEvent(g.TELEOP_INACTIVE,{detail:{node:this.fullName}}))}_handleKeyDown(t){const e=t.key.toLowerCase();if(["w","a","s","d","q","e","x"].includes(e)){t.preventDefault(),this.activeKeys.add(e);return}if(e==="i"){this.currentSpeed=Math.min(this.getParameter("speed_limit"),this.currentSpeed+.1),this.logInfo(`Speed: ${this.currentSpeed.toFixed(1)}`),t.preventDefault();return}if(e==="k"){this.currentSpeed=Math.max(.1,this.currentSpeed-.1),this.logInfo(`Speed: ${this.currentSpeed.toFixed(1)}`),t.preventDefault();return}if(e==="o"){this.currentTurn=Math.min(this.getParameter("turn_limit"),this.currentTurn+.1),this.logInfo(`Turn: ${this.currentTurn.toFixed(1)}`),t.preventDefault();return}if(e==="l"){this.currentTurn=Math.max(.1,this.currentTurn-.1),this.logInfo(`Turn: ${this.currentTurn.toFixed(1)}`),t.preventDefault();return}}_handleKeyUp(t){const e=t.key.toLowerCase();["w","a","s","d","q","e","x"].includes(e)&&(t.preventDefault(),this.activeKeys.delete(e))}_publishVelocity(){let t=0,e=0;if(this.activeKeys.has("x")){const s={linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:0}};this.cmdVelPub.publish(s),this.lastVelocity=!1;return}if(this.activeKeys.has("w")&&(t+=this.currentSpeed),this.activeKeys.has("s")&&(t-=this.currentSpeed),this.activeKeys.has("a")&&(e+=this.currentTurn),this.activeKeys.has("d")&&(e-=this.currentTurn),this.activeKeys.has("q")&&(t+=this.currentSpeed,e+=this.currentTurn),this.activeKeys.has("e")&&(t+=this.currentSpeed,e-=this.currentTurn),t!==0||e!==0||this.lastVelocity){const s={linear:{x:t,y:0,z:0},angular:{x:0,y:0,z:e}};this.cmdVelPub.publish(s),this.lastVelocity=t!==0||e!==0}}}x.register("teleop_twist_keyboard","teleop_twist_keyboard",Ts);class Ss extends N{constructor(t="slam_node",e={}){super(t,{...e,parameters:{map_resolution:.1,map_width:110,map_height:110,origin_x:0,origin_y:0,hit_prob:.9,miss_prob:.3,...e.parameters}}),this.grid=null,this.gridWidth=0,this.gridHeight=0,this.resolution=0,this.originX=0,this.originY=0,this.robotX=5.5,this.robotY=5.5,this.robotTheta=0,this.l0=0,this.lOcc=0,this.lFree=0,this.lMin=-5,this.lMax=5}onInit(){this._initializeGrid();const t=this.getParameter("hit_prob"),e=this.getParameter("miss_prob");this.lOcc=Math.log(t/(1-t)),this.lFree=Math.log(e/(1-e)),this.createSubscription("/turtle1/pose","turtlesim/msg/Pose",this._handlePose.bind(this)),this.createSubscription("/scan","sensor_msgs/msg/LaserScan",this._handleScan.bind(this)),this.mapPub=this.createPublisher("/map","nav_msgs/msg/OccupancyGrid"),this.createTimer(500,this._publishMap.bind(this)),this.logInfo("SLAM node started. Subscribe to /scan and /turtle1/pose"),this.logInfo(`Map: ${this.gridWidth}x${this.gridHeight} cells, ${this.resolution}m resolution`),window.dispatchEvent(new CustomEvent(g.SHOW_MAP)),this.logInfo("Map visualization enabled - watch the occupancy grid build as you explore!")}_initializeGrid(){this.gridWidth=this.getParameter("map_width"),this.gridHeight=this.getParameter("map_height"),this.resolution=this.getParameter("map_resolution"),this.originX=this.getParameter("origin_x"),this.originY=this.getParameter("origin_y"),this.grid=new Float32Array(this.gridWidth*this.gridHeight),this.grid.fill(0)}_handlePose(t){this.robotX=t.x,this.robotY=t.y,this.robotTheta=t.theta,window.dispatchEvent(new CustomEvent(g.ROBOT_POSE_UPDATE,{detail:{x:this.robotX,y:this.robotY,theta:this.robotTheta}}))}_handleScan(t){const{angle_min:e,angle_increment:s,ranges:i,range_max:r}=t;for(let o=0;o<i.length;o++){const a=i[o],l=this.robotTheta+e+o*s;if(!isFinite(a)||a<=0)continue;const c=a<r-.1,h=c?Math.max(0,a-this.resolution*.5):a,d=this.robotX+Math.cos(l)*h,u=this.robotY+Math.sin(l)*h;this._rayTrace(this.robotX,this.robotY,d,u,c)}}_rayTrace(t,e,s,i,r){const o=this._worldToGridX(t),a=this._worldToGridY(e),l=this._worldToGridX(s),c=this._worldToGridY(i),h=l-o,d=c-a,u=Math.max(Math.abs(h),Math.abs(d));if(u===0){if(o>=0&&o<this.gridWidth&&a>=0&&a<this.gridHeight){const T=a*this.gridWidth+o;r&&(this.grid[T]=Math.min(this.lMax,this.grid[T]+this.lOcc))}return}const m=h/u,b=d/u;let y=o,v=a,E=-1,M=-1;for(let T=0;T<=u;T++){const C=Math.round(y),k=Math.round(v);if(C===E&&k===M){y+=m,v+=b;continue}if(E=C,M=k,C>=0&&C<this.gridWidth&&k>=0&&k<this.gridHeight){const A=k*this.gridWidth+C;T===u?r&&(this.grid[A]=Math.min(this.lMax,this.grid[A]+this.lOcc)):this.grid[A]=Math.max(this.lMin,this.grid[A]+this.lFree)}y+=m,v+=b}}_worldToGridX(t){return Math.floor((t-this.originX)/this.resolution)}_worldToGridY(t){return Math.floor((t-this.originY)/this.resolution)}_logOddsToProbability(t){return 1-1/(1+Math.exp(t))}_publishMap(){const t=new Int8Array(this.grid.length);for(let s=0;s<this.grid.length;s++){const i=this.grid[s];if(Math.abs(i)<.1)t[s]=-1;else{const r=this._logOddsToProbability(i);t[s]=Math.round(r*100)}}const e={header:{stamp:this.now(),frame_id:"map"},info:{map_load_time:this.now(),resolution:this.resolution,width:this.gridWidth,height:this.gridHeight,origin:{position:{x:this.originX,y:this.originY,z:0},orientation:{x:0,y:0,z:0,w:1}}},data:Array.from(t)};this.mapPub.publish(e),window.dispatchEvent(new CustomEvent(g.MAP_UPDATE,{detail:{map:Array.from(t),info:e.info}}))}onShutdown(){this.grid=null}}x.register("simple_slam","slam_node",Ss);class Cs{constructor(){this.transforms=new Map,this.staticTransforms=new Map,this.bufferDuration=1e4}setTransform(t,e=!1){const{header:s,child_frame_id:i,transform:r}=t,o=s.frame_id,a=i,l=e?this.staticTransforms:this.transforms;l.has(a)||l.set(a,new Map);const c=l.get(a);c.has(o)||c.set(o,[]);const h=c.get(o),d={timestamp:s.stamp.sec*1e3+s.stamp.nanosec/1e6,transform:r};e?c.set(o,[d]):(h.push(d),this._cleanupBuffer(h))}_cleanupBuffer(t){const s=Date.now()-this.bufferDuration;for(;t.length>0&&t[0].timestamp<s;)t.shift()}lookupTransform(t,e,s=0){let i=this._getDirectTransform(e,t,s);if(i)return i;if(i=this._getDirectTransform(t,e,s),i)return this._invertTransform(i);const r=this._findPath(e,t);return r?this._chainTransforms(r,s):null}_getDirectTransform(t,e,s){const i=this.staticTransforms.get(t);if(i&&i.has(e)){const o=i.get(e);if(o.length>0)return o[o.length-1].transform}const r=this.transforms.get(t);if(r&&r.has(e)){const o=r.get(e);if(o.length===0)return null;if(s===0)return o[o.length-1].transform;for(let a=o.length-1;a>=0;a--)if(o[a].timestamp<=s)return o[a].transform;return o[0].transform}return null}_invertTransform(t){const{translation:e,rotation:s}=t,i={x:-s.x,y:-s.y,z:-s.z,w:s.w};return{translation:this._rotateVector({x:-e.x,y:-e.y,z:-e.z},i),rotation:i}}_rotateVector(t,e){const{x:s,y:i,z:r,w:o}=e,a=[2*(i*t.z-r*t.y),2*(r*t.x-s*t.z),2*(s*t.y-i*t.x)];return{x:t.x+o*a[0]+i*a[2]-r*a[1],y:t.y+o*a[1]+r*a[0]-s*a[2],z:t.z+o*a[2]+s*a[1]-i*a[0]}}_findPath(t,e){this._getAllFrames();const s=new Set,i=[[t,[t]]];for(;i.length>0;){const[r,o]=i.shift();if(r===e)return o;if(s.has(r))continue;s.add(r);const a=this._getConnectedFrames(r);for(const l of a)s.has(l)||i.push([l,[...o,l]])}return null}_getConnectedFrames(t){const e=new Set;for(const[s]of[[this.transforms],[this.staticTransforms]]){const i=s.get(t);if(i)for(const r of i.keys())e.add(r);for(const[r,o]of s)o.has(t)&&e.add(r)}return e}_chainTransforms(t,e){let s={translation:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0,w:1}};for(let i=0;i<t.length-1;i++){const r=t[i],o=t[i+1];let a=this._getDirectTransform(r,o,e);if(!a)if(a=this._getDirectTransform(o,r,e),a)a=this._invertTransform(a);else return null;s=this._composeTransforms(s,a)}return s}_composeTransforms(t,e){const s=t.rotation,i=e.rotation,r={x:s.w*i.x+s.x*i.w+s.y*i.z-s.z*i.y,y:s.w*i.y-s.x*i.z+s.y*i.w+s.z*i.x,z:s.w*i.z+s.x*i.y-s.y*i.x+s.z*i.w,w:s.w*i.w-s.x*i.x-s.y*i.y-s.z*i.z},o=this._rotateVector(e.translation,s);return{translation:{x:t.translation.x+o.x,y:t.translation.y+o.y,z:t.translation.z+o.z},rotation:r}}_getAllFrames(){const t=new Set;for(const e of[this.transforms,this.staticTransforms])for(const[s,i]of e){t.add(s);for(const r of i.keys())t.add(r)}return t}getFrameTree(){const t={},e=this._getAllFrames();for(const s of e)t[s]={parents:[],children:[]};for(const s of[this.transforms,this.staticTransforms])for(const[i,r]of s)for(const o of r.keys())t[i]&&t[i].parents.push(o),t[o]&&t[o].children.push(i);return t}clear(){this.transforms.clear(),this.staticTransforms.clear()}}const Is=new Cs;class ks extends N{constructor(t="static_transform_publisher",e={}){super(t,e),this.transform={translation:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0,w:1}},this.frameId="world",this.childFrameId="base_link",this._parseArgs(e.args||[])}_parseArgs(t){if(t.length!==0&&t.length>=8)if(this.transform.translation.x=parseFloat(t[0])||0,this.transform.translation.y=parseFloat(t[1])||0,this.transform.translation.z=parseFloat(t[2])||0,t.length===8){const e=parseFloat(t[3])||0,s=parseFloat(t[4])||0,i=parseFloat(t[5])||0;this.transform.rotation=this._eulerToQuaternion(e,s,i),this.frameId=t[6],this.childFrameId=t[7]}else t.length>=9&&(this.transform.rotation.x=parseFloat(t[3])||0,this.transform.rotation.y=parseFloat(t[4])||0,this.transform.rotation.z=parseFloat(t[5])||0,this.transform.rotation.w=parseFloat(t[6])||1,this.frameId=t[7],this.childFrameId=t[8])}_eulerToQuaternion(t,e,s){const i=Math.cos(t*.5),r=Math.sin(t*.5),o=Math.cos(e*.5),a=Math.sin(e*.5),l=Math.cos(s*.5),c=Math.sin(s*.5);return{w:l*o*i+c*a*r,x:c*o*i-l*a*r,y:l*a*i+c*o*r,z:l*o*r-c*a*i}}onInit(){this.tfPub=this.createPublisher("/tf_static","tf2_msgs/msg/TFMessage");const t={header:{stamp:this.now(),frame_id:this.frameId},child_frame_id:this.childFrameId,transform:this.transform};Is.setTransform(t,!0),this.tfPub.publish({transforms:[t]}),this.createTimer(1e3,()=>{const e={transforms:[{header:{stamp:this.now(),frame_id:this.frameId},child_frame_id:this.childFrameId,transform:this.transform}]};this.tfPub.publish(e)}),this.logInfo(`Publishing static transform: ${this.frameId} -> ${this.childFrameId}`),this.logInfo(`  Translation: (${this.transform.translation.x}, ${this.transform.translation.y}, ${this.transform.translation.z})`),this.logInfo(`  Rotation: (${this.transform.rotation.x}, ${this.transform.rotation.y}, ${this.transform.rotation.z}, ${this.transform.rotation.w})`)}}x.register("tf2_ros","static_transform_publisher",ks);class Ls{constructor(){this.terminalManager=null,this.canvas=null,this.mapCanvas=null,this.graph=null,this.rqtConsole=null,this.layout=null,this.logger=S.getLogger("/ros2_turtle_school")}init(){this.logger.info("Initializing ROS 2 Turtle School..."),this.layout=new Mt,this.terminalManager=new xt({containerId:"terminals-container",tabListId:"terminal-tabs",addButtonId:"add-terminal",onCommand:(e,s)=>et(e,s)}),this.canvas=new St("turtle-canvas"),this.mapCanvas=new Ct("map-canvas"),this.graph=new Lt("graph-container"),this.rqtConsole=new Et,this._setupEventListeners(),this.terminalManager.focus();const t=this.terminalManager.getActiveTerminal();t&&(t.writeln(""),t.writeln("\x1B[32m\x1B[0m"),t.writeln("\x1B[32m                    ROS 2 Turtle School                       \x1B[0m"),t.writeln("\x1B[32m\x1B[0m"),t.writeln(""),t.writeln("Welcome! This is a browser-based ROS2 CLI emulator."),t.writeln("Try these commands to get started:"),t.writeln(""),t.writeln("  \x1B[33mros2 run turtlesim turtlesim_node\x1B[0m  - Start turtlesim"),t.writeln("  \x1B[33mros2 topic list\x1B[0m                   - List topics"),t.writeln("  \x1B[33mros2 node list\x1B[0m                    - List nodes"),t.writeln("  \x1B[33mhelp\x1B[0m                              - Show all commands"),t.writeln(""),t.writeln("Use the \x1B[36m+\x1B[0m button to add more terminal panes."),t.writeln("Press \x1B[36mCtrl+C\x1B[0m to stop running commands."),t.writeln(""),t.finishCommand()),this.logger.info("ROS 2 Turtle School initialized")}_setupEventListeners(){const t=document.getElementById("toggle-graph");t==null||t.addEventListener("click",()=>{this.graph.toggle()});const e=document.getElementById("toggle-map");e==null||e.addEventListener("click",()=>{this.layout.toggleMap()});const s=document.getElementById("toggle-console");s==null||s.addEventListener("click",()=>{this.rqtConsole.toggle()});const i=document.getElementById("show-help");i==null||i.addEventListener("click",()=>{this._showHelpModal()}),this._setupObstacleButtons(),this._setupMapOverlayButtons(),window.addEventListener(g.TOGGLE_GRAPH,()=>{this.graph.toggle()}),window.addEventListener(g.TOGGLE_CONSOLE,()=>{this.rqtConsole.toggle()}),window.addEventListener(g.SHOW_MAP,()=>{this.layout.showMap()}),window.addEventListener(g.OPEN_RQT_MODAL,()=>{this._showRqtModal()}),document.querySelectorAll("#quick-commands button").forEach(l=>{l.addEventListener("click",()=>{const c=l.dataset.cmd;if(c){const h=this.terminalManager.getActiveTerminal();h&&(h.writeln(c),et(c,h))}})}),window.addEventListener(g.TELEOP_ACTIVE,l=>{const{type:c}=l.detail;this._showTeleopHint(c)}),window.addEventListener(g.TELEOP_INACTIVE,()=>{this._hideTeleopHint()});const o=document.getElementById("modal-overlay"),a=document.getElementById("modal-close");o==null||o.addEventListener("click",l=>{l.target===o&&o.classList.add("hidden")}),a==null||a.addEventListener("click",()=>{o==null||o.classList.add("hidden")})}_setupObstacleButtons(){const t=document.getElementById("randomize-obstacles"),e=document.getElementById("add-obstacle-mode"),s=document.getElementById("delete-obstacle-mode"),i=document.getElementById("clear-obstacles"),r=document.getElementById("reset-obstacles");t==null||t.addEventListener("click",()=>{this.canvas.randomizeObstacles(5)}),e==null||e.addEventListener("click",()=>{const a=this.canvas.getEditMode()==="add"?"none":"add";this.canvas.setEditMode(a),this._updateObstacleButtons(a)}),s==null||s.addEventListener("click",()=>{const a=this.canvas.getEditMode()==="delete"?"none":"delete";this.canvas.setEditMode(a),this._updateObstacleButtons(a)}),i==null||i.addEventListener("click",()=>{this.canvas.clearObstacles()}),r==null||r.addEventListener("click",()=>{this.canvas.resetObstacles()}),window.addEventListener(g.CANVAS_EDIT_MODE_CHANGED,o=>{this._updateObstacleButtons(o.detail.mode)})}_updateObstacleButtons(t){const e=document.getElementById("add-obstacle-mode"),s=document.getElementById("delete-obstacle-mode");e==null||e.classList.toggle("active",t==="add"),s==null||s.classList.toggle("active",t==="delete")}_setupMapOverlayButtons(){const t=document.getElementById("toggle-map-overlay"),e=document.getElementById("map-opacity-control"),s=document.getElementById("map-opacity-slider"),i=document.getElementById("map-opacity-value");t==null||t.addEventListener("click",()=>{const r=this.canvas.toggleMap();t.classList.toggle("active",r),e==null||e.classList.toggle("hidden",!r)}),s==null||s.addEventListener("input",r=>{const o=parseInt(r.target.value,10)/100;this.canvas.setMapOpacity(o),i&&(i.textContent=`${r.target.value}%`)}),window.addEventListener(g.TOGGLE_MAP_OVERLAY,()=>{const r=this.canvas.toggleMap();t==null||t.classList.toggle("active",r),e==null||e.classList.toggle("hidden",!r)})}_showRqtModal(){const t=document.getElementById("modal-overlay"),e=document.getElementById("modal-title"),s=document.getElementById("modal-body");!t||!s||(e.textContent="rqt - ROS2 Tools",s.innerHTML=`
      <div class="rqt-tools">
        <button class="rqt-tool-btn" data-tool="graph">
          <span class="icon"></span>
          <span class="label">Node Graph</span>
          <span class="desc">Visualize nodes and topics</span>
        </button>
        <button class="rqt-tool-btn" data-tool="console">
          <span class="icon"></span>
          <span class="label">Console</span>
          <span class="desc">View log messages</span>
        </button>
      </div>
    `,s.querySelectorAll(".rqt-tool-btn").forEach(i=>{i.addEventListener("click",()=>{const r=i.dataset.tool;t.classList.add("hidden"),r==="graph"?this.graph.toggle():r==="console"&&this.rqtConsole.toggle()})}),t.classList.remove("hidden"))}_showHelpModal(){const t=document.getElementById("modal-overlay");Pt.show(t)}_showTeleopHint(t){let e=document.getElementById("teleop-hint");e||(e=document.createElement("div"),e.id="teleop-hint",document.body.appendChild(e)),t==="arrow-keys"?e.innerHTML="Use <kbd></kbd> <kbd></kbd> <kbd></kbd> <kbd></kbd> to control turtle":t==="wasd-keys"&&(e.innerHTML="Use <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> to move, <kbd>Q</kbd><kbd>E</kbd> to rotate"),e.classList.add("visible")}_hideTeleopHint(){const t=document.getElementById("teleop-hint");t&&t.classList.remove("visible")}destroy(){var t,e,s;I.killAll(),p.reset(),(t=this.terminalManager)==null||t.destroy(),(e=this.graph)==null||e.destroy(),(s=this.rqtConsole)==null||s.destroy()}}document.addEventListener("DOMContentLoaded",()=>{new Ls().init()});
//# sourceMappingURL=index-BvV9nw9y.js.map
